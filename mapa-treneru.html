<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa trenérů | CZTRAINERS</title>

  <!-- Fonts + global site styles -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="style_main.css" />
  <link rel="stylesheet" href="navbar.css" />
  <link rel="stylesheet" href="https://unpkg.com/animate.css@4.1.1/animate.min.css">

  <!-- Page styles (below) -->
  <link rel="stylesheet" href="mapa-treneru.css" />
</head>
<body>
  <!-- Navbar -->
  <nav class="cznav" aria-label="Hlavní navigace">
    <div class="cznav__logo">
      <a href="index.html">
        <img src="assets/CZTrainersNew.png" alt="CZTRAINERS Logo" />
      </a>
    </div>

    <div class="cznav__right">
      <a id="profilePill" class="cznav__pill" href="register.html" aria-label="Přihlásit / registrace">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M6 20a6 6 0 0112 0"></path>
        </svg>
        <span id="pillText">Login</span>
      </a>

      <button id="themeToggle" class="cznav__theme" type="button" aria-label="Přepnout motiv">
        <span id="themeIcon">☀️</span>
      </button>

      <button id="hamburger" class="cznav__hamburger" type="button" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <div id="navLinks" class="cznav__menu" role="menu" aria-label="Navigace">
      <a href="index.html" class="cznav__link">Domů</a>
      <a href="mapa-treneru.html" class="cznav__link">Mapa Trenérů</a>
      <a href="o-nas.html" class="cznav__link">O nás</a>
      <a href="login.html" class="cznav__link" id="loginBtn">Přihlášení</a>
      <a href="#" class="cznav__link" id="logoutBtn" style="display:none">Odhlásit se</a>
    </div>
  </nav>

  <!-- Layout: sidebar + map -->
  <main class="map-layout">
    <aside class="map-panel" aria-label="Filtry">
      <div class="map-panel__header">
        <h1>Mapa trenérů</h1>
        <button id="panelClose" class="map-panel__close" aria-label="Zavřít panel">×</button>
      </div>

      <div class="map-panel__section">
        <label class="map-field">
          <span>Hledat město nebo adresu</span>
          <input id="searchPlace" type="text" placeholder="Praha, Brno, Ostrava…" />
        </label>
      </div>

      <div class="map-panel__section">
        <label class="map-field">
          <span>Kraj</span>
          <select id="filterKraj">
            <option value="">Všechny kraje</option>
          </select>
        </label>
      </div>

      <div class="map-panel__section">
        <label class="map-field">
          <span>Specializace</span>
          <select id="filterSpec">
            <option value="">Vše</option>
          </select>
        </label>
      </div>

      <div class="map-panel__section">
        <label class="map-field">
          <span>Jazyky</span>
          <select id="filterLang">
            <option value="">Vše</option>
          </select>
        </label>
      </div>

      <!-- === MY LOCATION === -->
      <div class="map-panel__section map-near">
        <div class="map-near__row">
          <button id="useMyLocation" class="ur-btn ur-btn-primary" type="button">
            Použít mou polohu
          </button>
          <button id="recenterMe" class="ur-btn ur-btn-ghost" type="button" disabled>
            Přiblížit ke mně
          </button>
        </div>

        <label class="map-near__check">
          <input id="filterNear" type="checkbox" disabled />
          <span>Jen trenéři v okruhu</span>
          <strong id="nearRadiusValue">25&nbsp;km</strong>
        </label>

        <input id="nearRadius" class="range" type="range" min="1" max="100" step="1" value="25" disabled />
        <p class="map-panel__hint">Vaši přesnou polohu neukládáme.</p>
      </div>

      <!--
      <div class="map-panel__section">
        <label class="map-check">
          <input id="filterApprox" type="checkbox" />
          <span>Zahrnout jen přibližné polohy</span>
        </label>
      </div>
      -->

      <div class="map-panel__section">
        <button id="applyFilters" class="ur-btn ur-btn-primary" type="button">Filtrovat</button>
        <button id="resetFilters" class="ur-btn ur-btn-ghost" type="button">Vymazat</button>
      </div>

      <p class="map-panel__hint">Tip: Klikněte na pin pro detail trenéra a odkaz na profil.</p>
    </aside>

    <section class="map-canvas-wrap">
      <div id="map" class="map-canvas" role="application" aria-label="Mapa trenérů v České republice"></div>
      <button id="panelOpen" class="map-fab" aria-label="Otevřít filtry">Filtry</button>
    </section>
  </main>

  <!-- Auth-aware navbar -->
  <script type="module" src="auth-navbar.js"></script>

  <!-- Clustering -->
  <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

    <!-- Firebase + Google Maps -->
    <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
        authDomain: "cztrainers-dat1.firebaseapp.com",
        databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "cztrainers-dat1",
        storageBucket: "cztrainers-dat1.appspot.com",
        messagingSenderId: "369200533487",
        appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* Map IDs (light/dark). Put YOUR real IDs here. */
    const MAP_ID_LIGHT = "af6046a265f967e45e85c84d";
    const MAP_ID_DARK  = "af6046a265f967e41ff3345f";
    // Desktop = 'greedy' (normal scroll zoom), touch = 'cooperative' (two-finger)
    const gestureHandlingMode = () =>
      (window.matchMedia && window.matchMedia('(pointer: coarse)').matches)
        ? 'cooperative'
        : 'greedy';
    const currentMapId = () =>
    document.body.classList.contains("dark") ? MAP_ID_DARK : MAP_ID_LIGHT;

    /* Globals */
    let map, clusterer, allMarkers = [], trainersData = {};
    let geocoder;
    // --- Geolocation state ---
    let userLoc = null;           // { lat, lng, accuracy }
    let userMarker = null;        // AdvancedMarker for the blue dot
    let userCircle = null;        // Accuracy circle
    let distCache = {};           // uid -> distance (km)
    let nearEnabled = false;
    let nearRadiusKm = Number(localStorage.getItem('nearRadiusKm') || 25);

    /* ===== Trainer Detail Sheet (two states) ===== */
    const sheetEl   = document.getElementById("trainerSheet");
    const scrimEl   = document.getElementById("trainerScrim");
    const cardEl    = document.getElementById("tsContent");
    const avatarEl  = document.getElementById("tsAvatar");
    const titleEl   = document.getElementById("tsTitle");
    const metaEl    = document.getElementById("tsMeta");
    const approxEl  = document.getElementById("tsBadge") || document.getElementById("tsApprox");
    const specsEl   = document.getElementById("tsSpecs");
    const langsEl   = document.getElementById("tsLangs");
    const expEl     = document.getElementById("tsExp");
    const profileEl = document.getElementById("tsProfileBtn");
    const navEl     = document.getElementById("tsNavBtn");

    let lastAnchor = null; // to restore focus when closing

    function getTextList(v){
    if (!v) return "";
    if (Array.isArray(v)) return v.filter(Boolean).join(", ");
    return String(v);
    }
    function fullName(t){
    return ([t.name, t.prijmeni].filter(Boolean).join(" ") || "Trenér").trim();
    }

    let preventCloseUntil = 0; // small guard to ignore map-click right after opening
    let sheetOpenedAt = 0; // high-res timestamp for the last open (performance.now)

    function openTrainerSheet(uid, t){
    // build content safely
    const name = fullName(t);
    const loc  = t.location || {};
    const city = (loc.city || "").trim();
    const region = (loc.region || "").trim();
    const showDot = city && region;
    const meta = showDot ? `${city} • ${region}` : (city || region || "");
    const specs = getTextList(t.specializations);
    const langs = getTextList(t.languages);
    const exp   = (t.experience != null && t.experience !== "") ? `${t.experience} let praxe` : "";

    avatarEl.src = t.profilePicture || "assets/placeholder.jpg";
    avatarEl.alt = name;
    titleEl.textContent = name;
    let metaWithDist = meta;
    if (userLoc && Number.isFinite(distCache[uid])) metaWithDist += (metaWithDist ? " • " : "") + `${distCache[uid].toFixed(1)} km`;
    metaEl.textContent = metaWithDist;
    approxEl.hidden = !(loc.precision === "approx");
    specsEl.hidden = !specs;  specsEl.textContent = specs;
    langsEl.hidden = !langs;  langsEl.textContent = langs ? `Jazyky: ${langs}` : "";
    expEl.hidden   = !exp;    expEl.textContent   = exp;

    // links
    // Link to the correct profile page + expected query param
    profileEl.href = `profile.html?id=${encodeURIComponent(uid)}`;
    if (loc.visibleOnMap !== false && isFinite(loc.lat) && isFinite(loc.lng)) {
        // Build absolute URL to avoid SPA/redirect rules pointing you back to index.html
        const profileUrl = new URL('profile.html', window.location.origin);
        profileUrl.searchParams.set('id', uid);
        profileEl.href = profileUrl.toString();
        profileEl.setAttribute('target', '_self');   // explicit navigation in same tab

        // Safety: stop bubbling (but DO NOT prevent default)
        profileEl.addEventListener('click', (e) => e.stopPropagation());

        // Navigation link unchanged, just ensure absolute format
        if (isFinite(loc.lat) && isFinite(loc.lng) && loc.visibleOnMap !== false) {
        const navUrl = new URL('https://www.google.com/maps/dir/');
        navUrl.searchParams.set('api', '1');
        navUrl.searchParams.set('destination', `${loc.lat},${loc.lng}`);
        navEl.href = navUrl.toString();
        navEl.removeAttribute('hidden');
        } else {
        navEl.setAttribute('hidden', 'true');
        }
    } else {
        navEl.setAttribute("hidden", "true");
    }

    // state & animation
    sheetEl.setAttribute("aria-hidden", "false");
    scrimEl.setAttribute("aria-hidden", "false");
    sheetEl.classList.add("open");
    cardEl.classList.remove("animate__fadeOutDown");
    cardEl.classList.add("animate__fadeInUp", "animate__fast");

    // focus mgmt
    lastAnchor = document.activeElement;
    cardEl.focus();

    // brief guard so a pin click doesn't immediately close via map 'click'
    sheetOpenedAt = performance.now();
    preventCloseUntil = Date.now() + 900; // was 350; longer guard for mobile taps

    // URL deep link
    const url = new URL(location.href);
    url.searchParams.set("u", uid);
    history.pushState({u: uid}, "", url);
    }

    function closeTrainerSheet(source = 'ui'){
    // ignore accidental immediate map click right after opening
    if (source === 'map' && Date.now() < preventCloseUntil) return;
    if (!sheetEl.classList.contains("open")) return;
    // animate out
    cardEl.classList.remove("animate__fadeInUp");
    cardEl.classList.add("animate__fadeOutDown", "animate__fast");
    setTimeout(() => {
        sheetEl.classList.remove("open");
        sheetEl.setAttribute("aria-hidden", "true");
        scrimEl.setAttribute("aria-hidden", "true");
        cardEl.classList.remove("animate__fadeOutDown");
        // URL clean-up
        const url = new URL(location.href);
        url.searchParams.delete("u");
        history.pushState({}, "", url);
        // restore focus
        if (lastAnchor && typeof lastAnchor.focus === "function") lastAnchor.focus();
    }, 180);
    }

    // global exits
    scrimEl.addEventListener("click", () => closeTrainerSheet('ui'));
    window.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeTrainerSheet(); });
    window.addEventListener("popstate", ()=> {
    const u = new URL(location.href).searchParams.get("u");
    if (!u) closeTrainerSheet();
    });


    // add this helper anywhere in the module (above init is fine)
    function setupSearch() {
    const input = document.getElementById("searchPlace");
    if (!input || !window.google || !google.maps) return;

    // Legacy Autocomplete (still supported). We already load libraries=places.
    // Restrict to CZ; add more countries if you like.
    const ac = new google.maps.places.Autocomplete(input, {
        fields: ["geometry"],
        componentRestrictions: { country: ["cz"] },
        types: ["geocode"]
    });

    ac.addListener("place_changed", () => {
        const place = ac.getPlace();
        const loc = place?.geometry?.location;
        if (loc) {
        map.panTo(loc);
        map.setZoom(12);
        }
    });

    // Fallback: user presses Enter without picking a suggestion
    input.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        e.preventDefault();
        const q = input.value.trim();
        if (!q) return;

        geocoder = geocoder || new google.maps.Geocoder();
        geocoder.geocode(
        { address: q, componentRestrictions: { country: "cz" } },
        (results, status) => {
            const loc = (status === "OK" && results[0]?.geometry?.location) ? results[0].geometry.location : null;
            if (loc) {
            map.panTo(loc);
            map.setZoom(12);
            }
        }
        );
    });
    }

    const KRAJE = [
        "Hlavní město Praha","Středočeský kraj","Jihočeský kraj","Plzeňský kraj","Karlovarský kraj",
        "Ústecký kraj","Liberecký kraj","Královéhradecký kraj","Pardubický kraj","Vysočina",
        "Jihomoravský kraj","Olomoucký kraj","Zlínský kraj","Moravskoslezský kraj"
    ];
    const SPECIALIZACE = [
        "Fitness","Kondiční trénink","Silový trénink","Hubnutí","Výživa","Rehabilitace",
        "Běhání","Jóga","Pilates","Skupinové lekce"
    ];
    const JAZYKY = ["CZ","EN","DE","SK","RU","FR"];

    function populateFilters(){
        const krajSel = document.getElementById("filterKraj");
        KRAJE.forEach(k => krajSel.append(new Option(k, k)));
        const specSel = document.getElementById("filterSpec");
        SPECIALIZACE.forEach(s => specSel.append(new Option(s, s)));
        const langSel = document.getElementById("filterLang");
        JAZYKY.forEach(l => langSel.append(new Option(l, l)));
    }

    /* -------- pretty InfoWindow content + avatar pins ---------- */
        function buildIwHtml(t, uid) {
        const name  = [t.name, t.prijmeni].filter(Boolean).join(" ") || "Trenér";
        const specs = (t.specializations || "").toString();
        const langs = (t.languages || "").toString();
        const img   = t.profilePicture || "assets/placeholder.jpg";

        // NOTE: relative link (fixes “goes to homepage”)
        return `
            <div class="iw-card" role="dialog" aria-label="${name}">
            <img class="iw-avatar" src="${img}" alt="${name}">
            <div class="iw-body">
                <div class="iw-name">${name}</div>
                ${specs ? `<div class="iw-meta">${specs}</div>` : ""}
                ${langs ? `<div class="iw-meta">Jazyky: ${langs}</div>` : ""}
                <a class="rt-btn rt-btn-primary iw-btn" href="profile.html?id=${encodeURIComponent(uid)}">Zobrazit profil</a>
            </div>
            </div>`;
        }


        function makeTrainerPin(t, uid, position) {
            const name = fullName(t);
            const img  = t.profilePicture || "assets/placeholder.jpg";

            const el = document.createElement("button"); // button for a11y focus
            el.type = "button";
            el.className = "trainer-pin";
            el.innerHTML = `<img class="pin-avatar" src="${img}" alt="${name}">`;

            const m = new google.maps.marker.AdvancedMarkerElement({
                map,
                position,
                content: el,
                title: name
            });

            // open our sheet
            const open = () => {
                closeTrainerSheet();           // ensure only one open
                lastAnchor = el;               // restore focus here on close
                openTrainerSheet(uid, t);
            };
            m.addListener("gmp-click", open); // primary event for AdvancedMarker
            el.addEventListener("pointerdown", e => e.stopPropagation(), { passive: true });
            el.addEventListener("touchstart", e => e.stopPropagation(), { passive: true });
            // click on the button content (fallback)
            el.addEventListener("click", (e) => { e.stopPropagation(); open(); });
            return m;
        }


    /* ----------------------------------------------------------- */

    function rebuildMap(){
        const mapDiv = document.getElementById("map");
        const center = map ? map.getCenter() : { lat: 49.8175, lng: 15.4730 };
        const zoom   = map ? map.getZoom()   : 6;

        if (clusterer) { clusterer.clearMarkers(); clusterer = null; }
        allMarkers.forEach(m => { if (m) m.map = null; });

        map = new google.maps.Map(mapDiv, {
          center, zoom, mapId: currentMapId(),
          gestureHandling: gestureHandlingMode(),
          fullscreenControl: true
        });
        drawUserOverlays();
        applyFilters();
    }
    // Haversine distance in KM (no extra Maps library needed)
    function distanceKm(a, b){
      const toRad = d => d * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const q = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2 * R * Math.asin(Math.min(1, Math.sqrt(q)));
    }

    function updateNearLabel(){
      const span = document.getElementById('nearRadiusValue');
      if (span) span.textContent = `${nearRadiusKm} km`;
    }

    function drawUserOverlays(){
      if (!map || !userLoc) return;
      // marker
      if (userMarker) userMarker.map = null;
      const el = document.createElement('div'); el.className = 'user-dot';
      userMarker = new google.maps.marker.AdvancedMarkerElement({
        map, position: userLoc, content: el, title: 'Moje poloha'
      });
      // accuracy circle
      const radius = Math.max(80, Math.min(1500, Number(userLoc.accuracy || 200))); // clamp
      if (userCircle) userCircle.setMap(null);
      userCircle = new google.maps.Circle({
        map, center: userLoc, radius,
        strokeColor: '#4285F4', strokeOpacity: .5, strokeWeight: 1,
        fillColor: '#4285F4', fillOpacity: .12, clickable: false
      });
    }

    async function requestUserLocation(){
      const btn = document.getElementById('useMyLocation');
      btn?.setAttribute('disabled','true');
      try{
        await new Promise((resolve, reject) => {
          if (!navigator.geolocation) return reject(new Error('no geo'));
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy:true, timeout:12000, maximumAge:30000
          });
        }).then((pos) => {
          userLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy };
        });
        drawUserOverlays();
        // enable controls
        document.getElementById('recenterMe')?.removeAttribute('disabled');
        document.getElementById('filterNear')?.removeAttribute('disabled');
        document.getElementById('nearRadius')?.removeAttribute('disabled');
        // center once
        if (map) { map.setCenter(userLoc); map.setZoom(Math.max(map.getZoom()||6, 12)); }
        applyFilters(); // to compute distances & (optionally) filter
        // Hide the “Použít mou polohu” button and make “Přiblížit ke mně” full width
        const useBtn = document.getElementById('useMyLocation');
        if (useBtn) useBtn.style.display = 'none';
        const recBtn = document.getElementById('recenterMe');
        if (recBtn) recBtn.style.gridColumn = '1 / -1';
      } catch(e){
        alert('Nepodařilo se získat polohu. Zkuste to prosím znovu.');
      } finally{
        btn?.removeAttribute('disabled');
      }
    }

    function recenterToUser(){
      if (!map || !userLoc) return;
      map.panTo(userLoc);
      if ((map.getZoom()||6) < 12) map.setZoom(12);
    }

    function applyFilters(){
        const kraj = document.getElementById("filterKraj").value;
        const spec = document.getElementById("filterSpec").value;
        const lang = document.getElementById("filterLang").value;
        // approx-only filter removed
        nearEnabled = !!document.getElementById("filterNear")?.checked;
        nearRadiusKm = Number(document.getElementById("nearRadius")?.value || nearRadiusKm);
        updateNearLabel();

        closeTrainerSheet();

        if (clusterer) clusterer.clearMarkers();
        allMarkers.forEach(m => { if (m) m.map = null; });
        allMarkers = [];

        const markers = [];
        Object.entries(trainersData).forEach(([uid, t]) => {
          const loc = t?.location;
          if (!loc) return;
          if (loc.visibleOnMap === false) return;

          // Prefer publicLat/publicLng when provided; fallback to lat/lng
          const lat = (loc.publicLat != null && isFinite(Number(loc.publicLat))) ? Number(loc.publicLat) : Number(loc.lat);
          const lng = (loc.publicLng != null && isFinite(Number(loc.publicLng))) ? Number(loc.publicLng) : Number(loc.lng);
          if (!isFinite(lat) || !isFinite(lng)) return;
          const pos = { lat, lng };

          // Distance cache (if we know user's location)
          if (userLoc) {
            distCache[uid] = distanceKm(userLoc, pos);
            if (nearEnabled && distCache[uid] > nearRadiusKm) return; // outside radius -> skip
          }

          if (kraj && (loc.region !== kraj)) return;
          if (spec && !(t.specializations || "").includes(spec)) return;
          if (lang && !(t.languages || "").includes(lang)) return;

          const marker = makeTrainerPin(t, uid, pos);
          markers.push(marker);
        });

        allMarkers = markers;
        if (markers.length) {
        // eslint-disable-next-line no-undef
        clusterer = new markerClusterer.MarkerClusterer({ map, markers });
        }
    }

    async function fetchTrainers() {
        const rootRef = ref(db);
        let pubSnap = null, userSnap = null;
        try { pubSnap  = await get(child(rootRef, "public-trainers")); } catch (_) {}
        try { userSnap = await get(child(rootRef, "users")); } catch (_) {}

        const pub   = (pubSnap  && pubSnap.exists())  ? pubSnap.val()  : {};
        const users = (userSnap && userSnap.exists()) ? userSnap.val() : {};

        // Merge, prefer live users data when both exist
        trainersData = { ...(pub || {}), ...(users || {}) };
    }

    function closePanelIfMobile() {
      // only on mobile/tablet layouts
      if (!window.matchMedia('(max-width: 1023px)').matches) return;

      // Works with either #mapPanel or .map-panel, and the wrapper class you toggle
      const panel = document.getElementById('mapPanel') || document.querySelector('.map-panel');
      const wrap  = document.querySelector('.map-canvas-wrap');

      panel?.classList.remove('open');
      wrap?.classList.remove('panel-open');

      // return focus to the FAB so keyboard users can reopen quickly
      document.getElementById('panelOpen')?.focus({ preventScroll: true });
    }

    function initPanel(){
      const open  = document.getElementById("panelOpen");
      const close = document.getElementById("panelClose");
      const panel = document.querySelector(".map-panel");
      const wrap  = document.querySelector(".map-canvas-wrap");
      open.addEventListener("click",  () => { panel.classList.add("open");  wrap.classList.add("panel-open"); });
      close.addEventListener("click", () => { panel.classList.remove("open"); wrap.classList.remove("panel-open"); });
      document.getElementById("applyFilters").addEventListener("click", applyFilters);
      document.getElementById("resetFilters").addEventListener("click", () => {
        const kraj = document.getElementById("filterKraj");
        const spec = document.getElementById("filterSpec");
        const lang = document.getElementById("filterLang");
        const nearChk = document.getElementById("filterNear");
        const near = document.getElementById("nearRadius");

        // 1) Clear dropdowns
        if (kraj) kraj.value = "";
        if (spec) spec.value = "";
        if (lang) lang.value = "";

        // 2) Reset "near me" state
        if (nearChk) {
          nearChk.checked = false;
          // Enable only if we already have a user location
          if (userLoc) {
            nearChk.removeAttribute("disabled");
            near?.removeAttribute("disabled");
          } else {
            nearChk.setAttribute("disabled", "true");
            near?.setAttribute("disabled", "true");
          }
        }

        // 3) Reset radius to default and label
        nearRadiusKm = 25;
        if (near) near.value = "25";
        updateNearLabel();

        // 4) Re-apply filters with clean state
        applyFilters();
      });
      // === My location UI ===
      const near = document.getElementById("nearRadius");
      if (near) {
        near.value = String(nearRadiusKm);
        updateNearLabel();
        near.addEventListener("input", () => {
          nearRadiusKm = Number(near.value);
          localStorage.setItem('nearRadiusKm', String(nearRadiusKm));
          if (nearEnabled) applyFilters();
          updateNearLabel();
        });
      }
      document.getElementById("useMyLocation")?.addEventListener("click", requestUserLocation);
      document.getElementById("recenterMe")?.addEventListener("click", () => {
        recenterToUser();
        // Close the panel shortly after panning so the user sees the map move
        setTimeout(closePanelIfMobile, 50);
      });
      document.getElementById("filterNear")?.addEventListener("change", () => {
        nearEnabled = !!document.getElementById("filterNear").checked;
        applyFilters();
      });
    }

    /* INIT */
    window.initTrainersMapReal = async function(){
        populateFilters();
        initPanel();

        const mapDiv = document.getElementById("map");
        map = new google.maps.Map(mapDiv, {
          center: { lat: 49.8175, lng: 15.4730 },
          zoom: 6,
          mapId: currentMapId(),
          gestureHandling: gestureHandlingMode(),
          fullscreenControl: false
        });
        // close only on explicit map taps (not drag/zoom to avoid instant close)
        map.addListener("click", () => {
          // If the sheet isn’t open, ignore
          if (!sheetEl.classList.contains("open")) return;
          // On touch devices, a synthetic map click follows the pin tap — ignore it briefly
          if (performance.now() - sheetOpenedAt < 900) return;
          closeTrainerSheet('map');
        });

        // If user enters native fullscreen by other means, keep sheet inside the fullscreen root
        const relocateOverlay = () => {
        const fs = document.fullscreenElement;
        if (fs === mapDiv) {
            mapDiv.appendChild(sheetEl);
            mapDiv.appendChild(scrimEl);
        } else {
            // place near end of body so it overlays page
            document.body.appendChild(sheetEl);
            document.body.appendChild(scrimEl);
        }
        };
        document.addEventListener('fullscreenchange', relocateOverlay);
        // initial placement (non-fullscreen)
        relocateOverlay();
        setupSearch();
        try { await fetchTrainers(); } catch (e) { console.warn("Cannot load trainers:", e); }
        applyFilters();
        drawUserOverlays();
        // deep-link: ?u=<uid>

        const uidParam = new URL(location.href).searchParams.get("u");
        if (uidParam && trainersData[uidParam] && trainersData[uidParam].location) {
        const t   = trainersData[uidParam];
        const loc = t.location || {};
        if (isFinite(loc.lat) && isFinite(loc.lng) && loc.visibleOnMap !== false) {
            map.setCenter({lat: Number(loc.lat), lng: Number(loc.lng)});
            map.setZoom(12);
            openTrainerSheet(uidParam, t);
        }
        }

        // Rebuild when theme flips body.dark
        document.getElementById("themeToggle")?.addEventListener("click", () => setTimeout(rebuildMap, 0));

        // Also handle class changes programmatically
        new MutationObserver(() => rebuildMap())
        .observe(document.body, { attributes: true, attributeFilter: ["class"] });
    };
    </script>

    <!-- Make sure our callback exists before Maps loads -->
    <script>
    (function () {
        function start() {
        if (typeof window.initTrainersMapReal === 'function') {
            window.initTrainersMapReal();
        } else {
            setTimeout(start, 30);
        }
        }
        window.initTrainersMap = start;
    })();
    </script>

    <!-- Trainer Detail Sheet (bottom sheet) + scrim -->
<div id="trainerScrim" class="ts-scrim" aria-hidden="true"></div>

<aside id="trainerSheet" class="ts-sheet" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="tsTitle">
    <div id="tsContent" class="ts-card animate__animated" tabindex="-1">
        <div class="ts-row">
        <img id="tsAvatar" class="ts-avatar" src="assets/placeholder.jpg" alt="Profilový obrázek" />
        <div class="ts-main">
            <h3 id="tsTitle" class="ts-name">Trenér</h3>
            <div id="tsMeta" class="ts-meta">Město • Kraj</div>
            <div id="tsApprox" class="ts-badge" hidden>Přibližné umístění</div>
        </div>
        </div>

        <div class="ts-lines">
        <div id="tsSpecs" class="ts-line" hidden></div>
        <div id="tsLangs" class="ts-line" hidden></div>
        <div id="tsExp"   class="ts-line" hidden></div>
        </div>

        <div class="ts-actions">
        <a id="tsProfileBtn" class="rt-btn rt-btn-primary">Zobrazit profil</a>
        <a id="tsNavBtn" class="rt-btn rt-btn-ghost" target="_blank" rel="noopener">Navigovat</a>
        </div>
    </div>
    </aside>

  <!-- Google Maps JS -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCkboX_dqsdoPwyVYuNoxeBieZZnUILzU&libraries=marker,places&language=cs&region=CZ&callback=initTrainersMap&loading=async"></script>
</body>
</html>
