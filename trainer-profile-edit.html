<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Můj profil – CZTRAINERS</title>
  <link rel="stylesheet" href="trainer-profile-edit.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <!-- TFJS must load before nsfwjs -->
  <script src="https://unpkg.com/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <!-- UMD build that exposes window.nsfwjs -->
  <script src="vendor/nsfwjs.min.js"></script>
  <link rel="stylesheet" href="navbar.css">
</head>
<body>
<!-- Navbar (isolated) -->
  <nav class="cznav" aria-label="Hlavní navigace">
    <div class="cznav__logo">
      <a href="index.html">
        <img src="assets/CZTrainersNew.png" alt="CZTRAINERS Logo" />
      </a>
    </div>

    <!-- Right cluster: profile pill + theme + burger -->
    <div class="cznav__right">
      <a id="profilePill" class="cznav__pill" href="register.html" aria-label="Přihlásit / registrace">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M6 20a6 6 0 0112 0"></path>
        </svg>
        <span id="pillText">Login</span>
      </a>

      <button id="themeToggle" class="cznav__theme" type="button" aria-label="Přepnout motiv">
        <span id="themeIcon">☀️</span>
      </button>

      <button id="hamburger" class="cznav__hamburger" type="button" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <!-- Dropdown -->
    <div id="navLinks" class="cznav__menu" role="menu" aria-label="Navigace">
      <a href="index.html" class="cznav__link">Domů</a>
      <a href="mapa-treneru.html" class="cznav__link">Mapa Trenérů</a>
      <a href="o-nas.html" class="cznav__link">O nás</a>
      <a href="login.html" class="cznav__link" id="loginBtn">Přihlášení</a>
      <a href="#" class="cznav__link" id="logoutBtn" style="display:none">Odhlásit se</a>
    </div>
  </nav>

  <!-- PAGE -->
  <main class="page-wrapper">
    <div class="form-card">
      <h1 class="title">Můj profil</h1>

      <form id="profileForm" class="form">
        <!-- Obrázek -->
        <div class="field">
          <label for="profileImage">Profilový obrázek</label>
          <img id="profilePreview" src="" alt="Profilový obrázek" style="display:none" />
          <input type="file" id="profileImage" accept="image/*" />
          <p class="hint">Max 500&nbsp;KB · Nevhodné obrázky se zamítnou.</p>
        </div>

        <!-- === Gallery (edit) — paste after profile image field === -->
        <fieldset class="field-group" id="editGalleryField">
          <legend>Galerie (upravit)</legend>
          <p class="hint">Přidejte nebo odeberte fotky. Max 10 fotek, každá ≤ 10MB. Obrázky se zmenší a nahrají na Cloudinary.</p>
          <input id="galleryInput" type="file" accept="image/*" multiple />
          <div id="galleryPreview" class="gallery-preview" aria-live="polite"></div>
          <p class="hint" id="galleryCount">0 fotek</p>
        </fieldset>

        <!-- Osobní údaje -->
        <h3 class="section">Osobní údaje</h3>
        <div class="grid-2">
          <div class="field">
            <label for="name">Jméno</label>
            <input type="text" id="name" placeholder="Jméno" />
          </div>
          <div class="field">
            <label for="prijmeni">Příjmení</label>
            <input type="text" id="prijmeni" placeholder="Příjmení" />
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="datum">Datum narození</label>
            <input type="date" id="datum" />
          </div>
          <div class="field">
            <label for="phone">Telefon</label>
            <input
              type="tel"
              id="phone"
              placeholder="+420 123 456 789"
              inputmode="tel"
              autocomplete="tel"
              pattern="^\+?\d(?:\s?\d){6,14}$"
              required
            />
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="gender">Pohlaví</label>
            <select id="gender" required>
              <option value="">Vyber pohlaví</option>
              <option value="muz">Muž</option>
              <option value="zena">Žena</option>
              <option value="jine">Jiné</option>
            </select>
          </div>
          <div class="field">
            <label for="location">Kraj</label>
            <select id="location" required>
              <option value="">Vyber kraj</option>
              <option value="Hlavní město Praha">Hlavní město Praha</option>
              <option value="Středočeský kraj">Středočeský kraj</option>
              <option value="Jihočeský kraj">Jihočeský kraj</option>
              <option value="Plzeňský kraj">Plzeňský kraj</option>
              <option value="Karlovarský kraj">Karlovarský kraj</option>
              <option value="Ústecký kraj">Ústecký kraj</option>
              <option value="Liberecký kraj">Liberecký kraj</option>
              <option value="Královéhradecký kraj">Královéhradecký kraj</option>
              <option value="Pardubický kraj">Pardubický kraj</option>
              <option value="Vysočina">Vysočina</option>
              <option value="Jihomoravský kraj">Jihomoravský kraj</option>
              <option value="Olomoucký kraj">Olomoucký kraj</option>
              <option value="Zlínský kraj">Zlínský kraj</option>
              <option value="Moravskoslezský kraj">Moravskoslezský kraj</option>
            </select>
          </div>
        </div>

        <!-- O mně -->
        <div class="field">
          <label for="bio">O mně</label>
          <textarea id="bio" placeholder="Krátký popis (specializace, zkušenosti…)"></textarea>
        </div>

        <!-- Specializace -->
        <h3 class="section">Specializace</h3>
        <div id="specializationOptions" class="checkbox-group">
          <label><input type="checkbox" name="specializations" value="Fitness" /> Fitness</label>
          <label><input type="checkbox" name="specializations" value="Kondiční trénink" /> Kondiční trénink</label>
          <label><input type="checkbox" name="specializations" value="Silový trénink" /> Silový trénink</label>
          <label><input type="checkbox" name="specializations" value="Hubnutí" /> Hubnutí</label>
          <label><input type="checkbox" name="specializations" value="Výživa" /> Výživa / Nutriční poradenství</label>
          <label><input type="checkbox" name="specializations" value="Rehabilitace" /> Rehabilitace</label>
          <label><input type="checkbox" name="specializations" value="Běhání" /> Běhání</label>
          <label><input type="checkbox" name="specializations" value="Jóga" /> Jóga</label>
          <label><input type="checkbox" name="specializations" value="Pilates" /> Pilates</label>
          <label><input type="checkbox" name="specializations" value="Skupinové lekce" /> Skupinové lekce</label>
        </div>

        <!-- Ceník + Zkušenosti -->
        <div class="grid-2">
          <div class="field">
            <label for="pricing">Ceník</label>
            <textarea id="pricing" placeholder="Např. 700 Kč/hod · Balíčky…" required></textarea>
          </div>
          <div class="field">
            <label for="experience">Zkušenosti (roky)</label>
            <input type="number" id="experience" min="0" max="50" placeholder="Roky zkušeností" />
          </div>
        </div>

        <!-- Jazyky -->
        <h3 class="section">Jazyky</h3>
        <div id="languageOptions" class="checkbox-group">
          <label><input type="checkbox" name="languages" value="CZ" /> Čeština (CZ)</label>
          <label><input type="checkbox" name="languages" value="EN" /> Angličtina (EN)</label>
          <label><input type="checkbox" name="languages" value="DE" /> Němčina (DE)</label>
          <label><input type="checkbox" name="languages" value="SK" /> Slovenština (SK)</label>
          <label><input type="checkbox" name="languages" value="RU" /> Ruština (RU)</label>
          <label><input type="checkbox" name="languages" value="FR" /> Francouzština (FR)</label>
        </div>

        <!-- Socials -->
        <h3 class="section">Sociální sítě (volitelné)</h3>
        <div class="grid-3">
          <div class="field">
            <label for="instagram">Instagram</label>
            <input type="text" id="instagram" placeholder="uživatelské jméno nebo odkaz" />
          </div>
          <div class="field">
            <label for="facebook">Facebook</label>
            <input type="text" id="facebook" placeholder="uživatelské jméno nebo odkaz" />
          </div>
          <div class="field">
            <label for="tiktok">TikTok</label>
            <input type="text" id="tiktok" placeholder="uživatelské jméno nebo odkaz" />
          </div>
        </div>

        <!-- ======= Poloha trenéra (edit) ======= -->
        <h3 class="section">Zvol, kde trénuješ (adresu najdeš nebo přetáhneš pin)</h3>

        <div class="rt-mapbox">
          <label class="map-field">
            <span>Najdi adresu / město</span>
            <input id="mapSearch" type="text" placeholder="Zadejte adresu nebo město" />
          </label>

          <div id="trainerMap" class="map-picker" aria-label="Výběr polohy trenéra"></div>

          <div class="map-toggles">
            <label class="rt-check">
              <input type="checkbox" id="showOnMap" checked>
              <span>Zobrazit na mapě</span>
            </label>

            <div class="map-precision">
              <label class="rt-check">
                <input type="radio" name="locPrecision" value="exact" checked>
                <span>Přesná poloha</span>
              </label>
              <label class="rt-check">
                <input type="radio" name="locPrecision" value="approx">
                <span>Přibližná poloha</span>
              </label>
            </div>
          </div>

          <div class="map-meta">
            <label class="field-small">
              <span>Město (auto)</span>
              <input id="cityDisplay" type="text" readonly placeholder="—" />
            </label>
            <label class="field-small">
              <span>Kraj (auto vyplní výběr výše)</span>
              <input id="regionDisplay" type="text" readonly placeholder="—" />
            </label>
          </div>

          <!-- Hidden fields JS fills before save -->
          <input type="hidden" id="loc_lat" />
          <input type="hidden" id="loc_lng" />
          <input type="hidden" id="loc_lat_public" />
          <input type="hidden" id="loc_lng_public" />
          <input type="hidden" id="loc_city" />
          <input type="hidden" id="loc_region" />
          <input type="hidden" id="loc_geohash" />
          <input type="hidden" id="loc_precision" value="exact" />
          <input type="hidden" id="loc_visible" value="true" />
        </div>


        <!-- Submit -->
        <div class="actions">
          <button type="submit" class="btn primary">Uložit změny</button>
        </div>
      </form>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
      authDomain: "cztrainers-dat1.firebaseapp.com",
      databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cztrainers-dat1",
      storageBucket: "cztrainers-dat1.appspot.com",
      messagingSenderId: "369200533487",
      appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    // ---------- Cloudinary / Worker ----------
    const CLOUD_NAME = "dkt3pdcbe";
    const SIGNER_URL = "/api/sign";
    const MAX_FILE_SIZE = 500 * 1024;
    const MAX_DIM = 800;
    let CLOUD_FROM_FN = null;

    // ---------- DOM ----------
    const form = document.getElementById("profileForm");
    const imageInput = document.getElementById("profileImage");
    const preview = document.getElementById("profilePreview");
    let currentUrl = "";

    // --- Gallery config & state (add near other constants) ---
    const MAX_INPUT_SIZE = 10 * 1024 * 1024;         // 10MB client guard (same as register page)
    const MAX_GALLERY_FILES = 10;
    const GALLERY_MAX_DIM = 1600;
    const GALLERY_TARGET_BYTES = 500 * 1024;
    const TARGET_MAX_BYTES = 500 * 1024; // fallback target size for compressToTarget


    let existingGallery = [];       // [{ publicId, url }] from DB
    let galleryFilesSelected = [];  // File[] new files selected by user
    let galleryToDelete = new Set(); // publicIds marked for deletion
    let galleryUploadedResults = []; // results from newly uploaded files { publicId, url }

    let loadedLocation = null;

    function collectMapLocation() {
      const visible   = document.getElementById("showOnMap")?.checked ?? true;
      const precision = document.querySelector('input[name="locPrecision"]:checked')?.value || "exact";

      let latExact = Number(document.getElementById("loc_lat").value || NaN);
      let lngExact = Number(document.getElementById("loc_lng").value || NaN);
      let latPub   = Number(document.getElementById("loc_lat_public").value || NaN);
      let lngPub   = Number(document.getElementById("loc_lng_public").value || NaN);

      // Fallback to previously loaded location if fields are not yet set
      if (!Number.isFinite(latExact) && Number.isFinite(loadedLocation?.lat)) latExact = Number(loadedLocation.lat);
      if (!Number.isFinite(lngExact) && Number.isFinite(loadedLocation?.lng)) lngExact = Number(loadedLocation.lng);
      if (!Number.isFinite(latPub)   && Number.isFinite(loadedLocation?.publicLat)) latPub = Number(loadedLocation.publicLat);
      if (!Number.isFinite(lngPub)   && Number.isFinite(loadedLocation?.publicLng)) lngPub = Number(loadedLocation.publicLng);
      // As a last resort, mirror exact into public
      if (!Number.isFinite(latPub)) latPub = latExact;
      if (!Number.isFinite(lngPub)) lngPub = lngExact;

      if (!visible) {
        return { visibleOnMap: false, precision, lat: null, lng: null, publicLat: null, publicLng: null, city:"", region:"", geohash:"", updatedAt: Date.now() };
      }
      return {
        visibleOnMap: true,
        precision,
        lat: latExact,
        lng: lngExact,
        publicLat: latPub,
        publicLng: lngPub,
        city:    document.getElementById("loc_city").value || "",
        region:  document.getElementById("loc_region").value || "",
        geohash: document.getElementById("loc_geohash").value || "",
        updatedAt: Date.now()
      };
    }

    // ---------- Image preview (no pre-size check) ----------
    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        toast("Vybraný soubor není obrázek.");
        imageInput.value = "";
        preview.style.display = "none";
        return;
      }
      const r = new FileReader();
      r.onload = e => { preview.src = e.target.result; preview.style.display = "block"; };
      r.readAsDataURL(file);
    });

    // ---------- Helpers ----------
    function asArray(val){
      if (!val) return [];
      if (Array.isArray(val)) return val;
      if (typeof val === "string") return val.split(",").map(s => s.trim()).filter(Boolean);
      return [];
    }

    function fillForm(d){
      form.name.value       = d.name || "";
      form.prijmeni.value   = d.prijmeni || "";
      form.datum.value      = d.datum || "";
      form.phone.value      = d.phone || "";
      form.gender.value     = d.gender || "";
      // form.location.value = d.location || "";
      form.bio.value        = d.bio || "";
      form.pricing.value    = d.pricing || "";
      form.experience.value = d.experience || "";

      const socials = d.socials || {};
      form.instagram.value = (d.instagram ?? socials.instagram ?? "") || "";
      form.facebook.value  = (d.facebook  ?? socials.facebook  ?? "") || "";
      form.tiktok.value    = (d.tiktok    ?? socials.tiktok    ?? "") || "";
      
      const loc = d.location || {};
      loadedLocation = loc;
      document.getElementById("loc_lat").value       = loc.lat ?? "";
      document.getElementById("loc_lng").value       = loc.lng ?? "";
      document.getElementById("loc_city").value      = loc.city ?? "";
      document.getElementById("loc_region").value    = loc.region ?? "";
      document.getElementById("loc_geohash").value   = loc.geohash ?? "";
      document.getElementById("loc_precision").value = loc.precision ?? "exact";
      document.getElementById("loc_visible").value   = String(loc.visibleOnMap !== false);
      // public coords if present
      const latPubEl = document.getElementById("loc_lat_public");
      const lngPubEl = document.getElementById("loc_lng_public");
      if (latPubEl) latPubEl.value = (loc.publicLat ?? loc.lat ?? "");
      if (lngPubEl) lngPubEl.value = (loc.publicLng ?? loc.lng ?? "");

      const regionSelect = document.getElementById("location");
      if (regionSelect && loc.region) regionSelect.value = loc.region;

      if (window.setTrainerMapFromHidden) window.setTrainerMapFromHidden();

      const show = document.getElementById("showOnMap");
      if (show) show.checked = loc.visibleOnMap !== false;

      const exact = document.querySelector('input[name="locPrecision"][value="exact"]');
      const approx = document.querySelector('input[name="locPrecision"][value="approx"]');
      if (loc.precision === "approx" && approx) approx.checked = true;
      else if (exact) exact.checked = true;

      const specs = asArray(d.specializations);
      document.querySelectorAll("#specializationOptions input[type='checkbox']").forEach(cb => {
        cb.checked = specs.includes(cb.value);
      });

      const langs = asArray(d.languages);
      document.querySelectorAll("#languageOptions input[type='checkbox']").forEach(cb => {
        cb.checked = langs.includes(cb.value);
      });

      currentUrl = d.profilePicture || "";
      if (currentUrl) {
        const thumb = currentUrl.includes("/image/upload/")
          ? currentUrl.replace("/image/upload/", "/image/upload/c_fill,w_320,h_320,q_auto,f_auto/")
          : currentUrl;
        preview.src = thumb;
        preview.style.display = "block";
      }
        // --- render existing gallery when filling form ---
      existingGallery = Array.isArray(d.gallery) ? d.gallery.slice() : [];
      renderGalleryPreview();
    }

    // copy into trainer-profile-edit.html near other image helpers
    async function downscaleImage(file, maxDim = MAX_DIM, mime = "image/jpeg", quality = 0.9) {
      const img = await new Promise((res, rej) => {
        const i = new Image();
        i.onload = () => res(i);
        i.onerror = rej;
        i.src = URL.createObjectURL(file);
      });
      const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      canvas.getContext("2d").drawImage(img, 0, 0, w, h);
      return new Promise((res) => canvas.toBlob(res, mime, quality));
    }

    async function compressToTarget(file, { maxDim = MAX_DIM, target = TARGET_MAX_BYTES } = {}) {
      // Start at high quality and reduce until under target or minimum
      let quality = 0.9;
      let blob = await downscaleImage(file, maxDim, "image/jpeg", quality);
      let dim = maxDim;
      for (let step = 0; (blob && blob.size > target) && step < 8; step++) {
        if (quality > 0.5) {
          quality -= 0.08;
        } else {
          dim = Math.round(dim * 0.85);
        }
        blob = await downscaleImage(file, dim, "image/jpeg", Math.max(quality, 0.35));
      }
      return new File([blob], "upload.jpg", { type: "image/jpeg" });
    }


    // ---------- NSFWJS (LOCAL MODEL) ----------
    const NSFW_MODEL_PATH = "./vendor/nsfw-model/";
    let nsfwModelPromise = null;                   // <-- define it!

    function getNSFWModel(){
      if (nsfwModelPromise) return nsfwModelPromise;
      const NS = window.nsfwjs;
      if (!NS) throw new Error("NSFWJS failed to load (check vendor/nsfwjs.min.js)");
      // Loads model.json + .bin shards from NSFW_MODEL_PATH
      nsfwModelPromise = NS.load(NSFW_MODEL_PATH)
        .catch(err => {
          console.error("[nsfw] load failed:", err);
          throw err;
        });
      return nsfwModelPromise;
    }

    async function isImageSafe(file){
      const model = await getNSFWModel();
      const dataURL = await new Promise(res => { const r = new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); });
      const img = new Image();
      await new Promise((res, rej) => { img.onload=res; img.onerror=rej; img.src=dataURL; });
      const preds = await model.classify(img);
      const score = { Sexy: 0, Porn: 0, Hentai: 0 };
      preds.forEach(p => { if (score[p.className] != null) score[p.className] = p.probability; });
      if (score.Porn + score.Hentai >= 0.2) return false;
      if (score.Sexy >= 0.5) return false;
      return true;
    }

    // Preload once so the first upload is fast
    getNSFWModel().catch(err => console.error("[nsfw] preload failed:", err));

    async function deleteGallerySigned(publicId) {
      if (!publicId) throw new Error("No publicId");
      const timestamp = Math.floor(Date.now()/1000);
      // ask your signer for a destroy signature
      const sigRes = await fetch(SIGNER_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ op: "destroy", public_id: publicId, timestamp })
      }).then(r => {
        if (!r.ok) throw new Error("Signer failed for destroy");
        return r.json();
      });

      const cloud = sigRes.cloudName || CLOUD_NAME;
      const form = new FormData();
      form.append("public_id", publicId);
      form.append("api_key", sigRes.apiKey);
      form.append("timestamp", String(sigRes.timestamp || timestamp));
      form.append("signature", sigRes.signature);

      // call Cloudinary destroy endpoint
      const res = await fetch(`https://api.cloudinary.com/v1_1/${cloud}/image/destroy`, {
        method: "POST",
        body: form
      });
      const json = await res.json();
      // Cloudinary returns { result: "ok" } on success, or result: "not found"
      if (!res.ok || (json.result !== "ok" && json.result !== "not found")) {
        throw new Error("Cloudinary destroy failed: " + (json.error?.message || json.result || res.status));
      }
      return json;
    }

    async function getSignature(params){
      const r = await fetch(SIGNER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(params)
      });
      const txt = await r.text().catch(()=>"(no body)");
      if (!r.ok) throw new Error(`Signer HTTP ${r.status}: ${txt}`);
        const json = JSON.parse(txt);
      if (json.cloudName) CLOUD_FROM_FN = json.cloudName;
        return json;
    }

    async function uploadPfpSigned({ file, uid }){
      const public_id = `users/${uid}/pfp`;
      const timestamp = Math.floor(Date.now()/1000);
      const { signature, apiKey } = await getSignature({ public_id, timestamp, overwrite:true, invalidate:true });

      const formData = new FormData();
      formData.append("file", file, "pfp.jpg");
      formData.append("api_key", apiKey);
      formData.append("timestamp", String(timestamp));
      formData.append("public_id", public_id);
      formData.append("overwrite", "true");
      formData.append("invalidate", "true");
      formData.append("signature", signature);

      const cloud = CLOUD_FROM_FN || CLOUD_NAME;
      const resp = await fetch(`https://api.cloudinary.com/v1_1/${cloud}/image/upload`, {
        method: "POST",
        body: formData
      });    
      const txt = await resp.text().catch(()=>"(no body)");
      if (!resp.ok) throw new Error(`Cloudinary chyba ${resp.status}: ${txt}`);
      return JSON.parse(txt);
    }

    async function uploadGallerySigned({ file, uid }) {
      // same signer contract as registration page
      const timestamp = Math.floor(Date.now() / 1000);
      const public_id = `users/${uid}/gallery/${Date.now()}-${Math.random().toString(36).slice(2,8)}`;

      const sigRes = await fetch(SIGNER_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          public_id,
          timestamp,
          overwrite: true,
          invalidate: true
        })
      }).then(r => {
        if (!r.ok) throw new Error("Signer failed");
        return r.json();
      });

      const form = new FormData();
      form.append("file", file);
      form.append("api_key", sigRes.apiKey);
      form.append("timestamp", String(timestamp));
      form.append("public_id", public_id);
      form.append("overwrite", "true");
      form.append("invalidate", "true");
      form.append("signature", sigRes.signature);

      const cloud = sigRes.cloudName || CLOUD_NAME;
      const res = await fetch(`https://api.cloudinary.com/v1_1/${cloud}/image/upload`, { method: "POST", body: form });
      const json = await res.json();
      if (!json.secure_url) throw new Error("Cloudinary upload failed");
      return { publicId: json.public_id, url: json.secure_url };
    }

    // Render gallery UI from existingGallery + newly selected files
    function renderGalleryPreview() {
      const galleryPreview = document.getElementById("galleryPreview");
      const galleryCountEl = document.getElementById("galleryCount");
      if (!galleryPreview || !galleryCountEl) return;
      galleryPreview.innerHTML = "";

      // existing (from DB)
      existingGallery.forEach((item, idx) => {
        const wrap = document.createElement("div");
        wrap.className = "g-thumb";
        wrap.dataset.publicId = item.publicId || item.public_id || "";
        if (galleryToDelete.has(wrap.dataset.publicId)) wrap.classList.add("deleting");
        wrap.innerHTML = `<img src="${item.url}" alt="Galerie ${idx+1}"><div class="g-meta">DB</div>
          <div class="g-remove" title="Odebrat">✕</div>`;
        galleryPreview.appendChild(wrap);
        wrap.querySelector(".g-remove").addEventListener("click", async () => {
          const pid = wrap.dataset.publicId;
          if (!pid) return;
          const confirmNow = confirm("Opravdu chcete tuto fotku smazat natrvalo? (bude odstraněna z Cloudinary)");
          if (!confirmNow) return;
          // inside the click handler after successful deleteGallerySigned(pid)
          try {
            wrap.classList.add("deleting");
            await deleteGallerySigned(pid);

            // remove from existingGallery local array
            existingGallery = existingGallery.filter(it => (it.publicId || it.public_id || "") !== pid);
            renderGalleryPreview();

            // Persist change to DB: update user's gallery + galleryCount
            try {
              const finalGallery = existingGallery.map(it => ({ publicId: it.publicId || it.public_id, url: it.url || it.secure_url }));
              await update(ref(db, "users/" + auth.currentUser.uid), {
                gallery: finalGallery.length ? finalGallery : null,
                galleryCount: finalGallery.length || 0
              });
            } catch (dbErr) {
              console.warn("Failed to persist gallery deletion to DB:", dbErr);
              // not fatal — UI already updated; optionally show toast
            }

            toast("Obrázek odstraněn.");
          } catch (err) {
            console.error("Destroy failed:", err);
            wrap.classList.remove("deleting");
            toast("Nepodařilo se smazat obrázek. Zkuste to později.");
          }
        });
      });

      // newly selected files (previews)
      galleryFilesSelected.forEach((f) => {
        const url = URL.createObjectURL(f);
        const wrap = document.createElement("div");
        wrap.className = "g-thumb";
        wrap.innerHTML = `<img src="${url}" alt="Nová"><div class="g-meta">${Math.round(f.size/1024)} kB</div>
          <div class="g-remove" title="Odebrat">✕</div>`;
        galleryPreview.appendChild(wrap);

        // remove by reference (safe even after array changes)
        wrap.querySelector(".g-remove").addEventListener("click", () => {
          galleryFilesSelected = galleryFilesSelected.filter(x => x !== f);
          try { URL.revokeObjectURL(url); } catch(e){}
          renderGalleryPreview();
        });
      });

      galleryCountEl.textContent = `${existingGallery.length - galleryToDelete.size + galleryFilesSelected.length} fotek`;
    }

    // gallery input change — preview and client-side checks (max count/size)
    const galleryInputEl = document.getElementById("galleryInput");
    if (galleryInputEl) {
      galleryInputEl.addEventListener("change", () => {
        const files = Array.from(galleryInputEl.files || []);
        // only images + max size
        const ok = files.filter(f => /^image\//.test(f.type) && f.size <= MAX_INPUT_SIZE);
        if (ok.length !== files.length) toast("Některé soubory byly přeskočeny (neplatný formát nebo >10MB).");
        // cap by remaining allowed
        const allowed = Math.max(0, MAX_GALLERY_FILES - (existingGallery.length - galleryToDelete.size));
        if (ok.length > allowed) {
          toast(`Maximálně ${MAX_GALLERY_FILES} fotek v galerii. Přidávám první ${allowed}.`);
          ok.length = allowed;
        }
        galleryFilesSelected = ok;
        renderGalleryPreview();
      });
    }


    window.applyLoadedLocationWhenMapReady = function () {
      if (window.setTrainerMapFromHidden) {
        window.setTrainerMapFromHidden();
      } else {
        // Maps not ready yet – try shortly again
        setTimeout(window.applyLoadedLocationWhenMapReady, 60);
      }
    };

    // ---------- Load & Submit ----------
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      toast("Nejste přihlášen.");
      window.location.href = "login.html";
      return;
    }

    const userRef = ref(db, "users/" + user.uid);
    get(userRef)
      .then(async (snap) => {
        if (snap.exists()) {
          fillForm(snap.val());
          window.applyLoadedLocationWhenMapReady?.();
          return;
        }
        const uvRef = ref(db, "unverified-users/" + user.uid);
        try {
          const uvSnap = await get(uvRef);
          if (uvSnap.exists()) {
            fillForm(uvSnap.val());
            window.applyLoadedLocationWhenMapReady?.();
          }
          else toast("Vaše data nebyla nalezena. Přihlaste se znovu, aby se profil aktivoval.");
        } catch (err) {
          console.error("[profile] read error (unverified-users):", err);
          toast("Nedaří se načíst profilová data (oprávnění).");
        }
      })
      .catch((err) => {
        console.error("[profile] read error (/users):", err);
        toast("Chyba při načítání profilu: " + err.message);
      });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      let newUrl = currentUrl;

      if (imageInput.files.length > 0) {
        const raw = imageInput.files[0];

        // 1) quick guard: file must be an image
        if (!raw.type.startsWith("image/")) {
          toast("Vybraný soubor není obrázek.");
          return;
        }

        try {
          // 2) downscale first (so big phone photos are reduced)
          const jpg = await downscaleImage(raw); // returns a JPEG Blob/File

          // 3) optional cap AFTER downscale
          const MAX_FILE_SIZE = 500 * 1024; // 500 KB
          if (jpg.size > MAX_FILE_SIZE) {
            toast("Obrázek je příliš velký i po zmenšení (max 500 KB).");
            return;
          }

          // 4) NSFW check
          const safe = await isImageSafe(jpg);
          if (!safe) {
            toast("Tento obrázek není vhodný pro profil (NSFW). Zvolte prosím jiný.");
            return;
          }

          // 5) Signed upload to Cloudinary
          const { secure_url } = await uploadPfpSigned({ file: jpg, uid: user.uid });
          newUrl = secure_url;

        } catch (err) {
          toast("Nepodařilo se nahrát obrázek: " + err.message);
          return;
        }
      }

      const selectedSpecializations = Array.from(
        document.querySelectorAll("#specializationOptions input[type='checkbox']:checked")
      ).map(cb => cb.value);

      const selectedLanguages = Array.from(
        document.querySelectorAll("#languageOptions input[type='checkbox']:checked")
      ).map(cb => cb.value);

      const phoneRaw = form.phone.value.trim();
      const phoneNormalized = (phoneRaw.startsWith('+') ? '+' : '') + phoneRaw.replace(/\D/g, '');

      // ⚠️ Do NOT put "location: form.location.value" here — it would overwrite the map object.
      const updated = {
        name: form.name.value,
        prijmeni: form.prijmeni.value,
        datum: form.datum.value,
        phone: phoneNormalized,
        gender: form.gender.value,
        bio: form.bio.value,
        specializations: selectedSpecializations,
        pricing: form.pricing.value,
        experience: form.experience.value,
        languages: selectedLanguages,
        email: user.email,
        profilePicture: newUrl,
        instagram: form.instagram.value.trim(),
        facebook: form.facebook.value.trim(),
        tiktok: form.tiktok.value.trim()
      };

      // include the map picker payload
      window.syncHiddenFromMarker?.();
      const locationPayload = collectMapLocation();

      // === GALLERY handling (inside submit flow, after authentication/user check) ===
      const finalGallery = []; // will hold { publicId, url } objects

      // 1) keep existing items that are NOT marked for deletion
      for (const it of existingGallery) {
        const pid = it.publicId || it.public_id || "";
        if (!galleryToDelete.has(pid)) finalGallery.push({ publicId: pid, url: it.url || it.secure_url || "" });
      }

      // 2) upload newly selected files (compress + nsfw + upload)
      for (const raw of galleryFilesSelected) {
        try {
          const jpg = await compressToTarget(raw, { maxDim: GALLERY_MAX_DIM, target: GALLERY_TARGET_BYTES });
          // optional quality loop - you already have compressToTarget on register page; you can reuse it
          // do NSFW check
          const ok = await isImageSafe(jpg);
          if (!ok) { console.warn("NSFW rejected a gallery image"); continue; }
          const up = await uploadGallerySigned({ file: jpg, uid: user.uid });
          finalGallery.push({ publicId: up.publicId, url: up.url });
        } catch (err) {
          console.error("Gallery upload error:", err);
        }
      }

      // 3) attach finalGallery to the object you write to DB
      updated.gallery = finalGallery.length ? finalGallery : null;
      updated.galleryCount = finalGallery.length || 0;

      try {
        await update(ref(db, "users/" + user.uid), {
          ...updated,
          location: locationPayload
        });

        toast("Profil uložen.");
        currentUrl = newUrl;
        if (currentUrl) {
          const thumb = currentUrl.includes("/image/upload/")
            ? currentUrl.replace("/image/upload/", "/image/upload/c_fill,w_320,h_320,q_auto,f_auto/")
            : currentUrl;
          preview.src = thumb;
          preview.style.display = "block";
        }
        setTimeout(() => (window.location.href = "index.html"), 600);
      } catch (err) {
        toast("Chyba: " + err.message);
      }
    });
  });
  </script>

  <script type="module" src="register-trainer-map.js"></script>
  <!-- Map callback stub: ensures Google won't call undefined function -->
  <script>
    if (!window.initTrainerPickMap) {
      window.__initTrainerPickMap_pending = false;
      window.__initTrainerPickMap_real = null;
      window.initTrainerPickMap = function() {
        if (typeof window.__initTrainerPickMap_real === 'function') {
          try { window.__initTrainerPickMap_real(); } catch (e) { console.error('[map] initTrainerPickMap real threw', e); }
        } else {
          window.__initTrainerPickMap_pending = true;
          console.warn('[map] initTrainerPickMap called early - queued until module loads');
        }
      };
    }
  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCkboX_dqsdoPwyVYuNoxeBieZZnUILzU&libraries=places&language=cs&region=CZ&callback=initTrainerPickMap&loading=async"></script>
  <script type="module" src="auth-navbar.js"></script>
</body>
</html>
