<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registrace uživatele | CZTRAINERS</title>

  <!-- Global site styles (navbar, tokens, etc.) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="style_main.css" />
  <!-- Page styles -->
  <link rel="stylesheet" href="register-user.css" />
  <link rel="stylesheet" href="navbar.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body>
<!-- Navbar (isolated) -->
  <nav class="cznav" aria-label="Hlavní navigace">
    <div class="cznav__logo">
      <a href="index_main.html">
        <img src="CZtrainers new better.png" alt="CZTRAINERS Logo" />
      </a>
    </div>

    <!-- Right cluster: profile pill + theme + burger -->
    <div class="cznav__right">
      <a id="profilePill" class="cznav__pill" href="register.html" aria-label="Přihlásit / registrace">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M6 20a6 6 0 0112 0"></path>
        </svg>
        <span id="pillText">Login</span>
      </a>

      <button id="themeToggle" class="cznav__theme" type="button" aria-label="Přepnout motiv">
        <span id="themeIcon">☀️</span>
      </button>

      <button id="hamburger" class="cznav__hamburger" type="button" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <!-- Dropdown -->
    <div id="navLinks" class="cznav__menu" role="menu" aria-label="Navigace">
      <a href="index_main.html" class="cznav__link">Domů</a>
      <a href="o-nas.html" class="cznav__link">O nás</a>
      <a href="login.html" class="cznav__link" id="loginBtn">Přihlášení</a>
      <a href="#" class="cznav__link" id="logoutBtn" style="display:none">Odhlásit se</a>
    </div>
  </nav>

  <!-- PAGE CONTENT -->
  <header class="ur-header">
    <h1>Registrace uživatele</h1>
    <p class="ur-subtitle">Zadejte své jméno, e-mail a heslo. Po registraci vám pošleme ověřovací e-mail.</p>
  </header>

  <main class="ur-container">
    <section class="ur-card animate__animated animate__fadeIn">
      <form id="userRegisterForm" novalidate>
        <label class="ur-field">
          <span>Jméno</span>
          <input type="text" id="name" placeholder="Vaše jméno" required />
        </label>

        <label class="ur-field">
          <span>E-mail</span>
          <input type="email" id="email" placeholder="např. jan.novak@email.cz" required />
        </label>

        <label class="ur-field">
          <span>Heslo</span>
          <input type="password" id="password" placeholder="Min. 6 znaků" minlength="6" required />
        </label>

        <!-- NEW: Age confirmation (required) -->
        <label class="ur-check" style="display:flex;gap:.5rem;align-items:flex-start;margin:.5rem 0;">
          <input type="checkbox" id="age16" required />
          <span>Je mi alespoň 16 let.</span>
        </label>

        <!-- NEW: TOS & Privacy consent (required) -->
        <label class="ur-check" style="display:flex;gap:.5rem;align-items:flex-start;margin:.25rem 0 1rem;">
          <input type="checkbox" id="consentTos" required />
          <span>Souhlasím se <a href="podminky.html" target="_blank" rel="noopener">Smluvními podmínkami</a> a se 
            <a href="ochrana-osobnich-udaju.html" target="_blank" rel="noopener">Zásadami ochrany osobních údajů</a>.
          </span>
        </label>

        <button id="submitBtn" type="submit" class="ur-btn ur-btn-primary">Vytvořit účet</button>
        <a class="ur-btn ur-btn-ghost" href="register.html">Zpět na výběr registrace</a>
      </form>
    </section>
  </main>

  <footer class="ur-foot animate__animated animate__swing animate__delay-3s">
    <p>Máte účet? <a href="login.html">Přihlásit se</a></p>
  </footer>

  <!-- Shared navbar auth logic (toggles register/login vs profile/account/logout) -->
  <script type="module" src="auth-navbar.js"></script>

  <!-- Firebase: create user + separate under /app-users and /roles -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
      authDomain: "cztrainers-dat1.firebaseapp.com",
      databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cztrainers-dat1",
      storageBucket: "cztrainers-dat1.appspot.com",
      messagingSenderId: "369200533487",
      appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };

    // Safe init (won't double-init if auth-navbar.js already did)
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const form = document.getElementById("userRegisterForm");
    const submitBtn = document.getElementById("submitBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = (document.getElementById("name").value || "").trim();
      const email = (document.getElementById("email").value || "").trim();
      const password = document.getElementById("password").value;

      // NEW: quick client-side checks (required already enforces too)
      if (!document.getElementById("age16").checked) {
        alert("Pro pokračování potvrďte, že je vám alespoň 16 let.");
        return;
      }
      if (!document.getElementById("consentTos").checked) {
        alert("Pro pokračování je nutný souhlas s podmínkami a zásadami.");
        return;
      }

      if (!name || !email || !password || password.length < 6) {
        alert("Vyplňte prosím všechny údaje. Heslo musí mít alespoň 6 znaků.");
        return;
      }

      submitBtn.disabled = true;

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;

        // Separate bucket for simple users
        await set(ref(db, "app-users/" + uid), {
          name,
          email,
          role: "user",
          emailVerified: false,
          createdAt: Date.now(),
          ageConfirmed: true
        });

        // Flat roles map for quick checks/rules
        await set(ref(db, "roles/" + uid), "user");

        // NEW: store consent version + timestamp
        const consentVersion = "2025-09-21"; // bump when you change texts
        await set(ref(db, "app-users/" + uid + "/consent"), {
          tos: true,
          privacy: true,
          version: consentVersion,
          at: Date.now()
        });

        await sendEmailVerification(cred.user);
        alert("Účet byl vytvořen. Poslali jsme vám ověřovací e-mail. Po ověření se přihlaste.");
        await signOut(auth);

        form.reset();
        window.location.href = "login.html";
      } catch (err) {
        alert("Chyba při registraci: " + (err?.message || err));
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
