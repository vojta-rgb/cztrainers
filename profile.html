<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profil trenÃ©ra</title>
  <link rel="stylesheet" href="style_main.css"/>
  <link rel="stylesheet" href="navbar.css">
</head>
<body>
<!-- Navbar (isolated) -->
  <nav class="cznav" aria-label="HlavnÃ­ navigace">
    <div class="cznav__logo">
      <a href="index_main.html">
        <img src="CZtrainers new better.png" alt="CZTRAINERS Logo" />
      </a>
    </div>

    <!-- Right cluster: profile pill + theme + burger -->
    <div class="cznav__right">
      <a id="profilePill" class="cznav__pill" href="register.html" aria-label="PÅ™ihlÃ¡sit / registrace">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M6 20a6 6 0 0112 0"></path>
        </svg>
        <span id="pillText">Login</span>
      </a>

      <button id="themeToggle" class="cznav__theme" type="button" aria-label="PÅ™epnout motiv">
        <span id="themeIcon">â˜€ï¸</span>
      </button>

      <button id="hamburger" class="cznav__hamburger" type="button" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <!-- Dropdown -->
    <div id="navLinks" class="cznav__menu" role="menu" aria-label="Navigace">
      <a href="o-nas.html" class="cznav__link">O nÃ¡s</a>
      <a href="login.html" class="cznav__link" id="loginBtn">PÅ™ihlÃ¡Å¡enÃ­</a>
      <a href="#" class="cznav__link" id="logoutBtn" style="display:none">OdhlÃ¡sit se</a>
    </div>
  </nav>

  <div class="container">
    <h1>Profil uÅ¾ivatele</h1>
    <div id="profileCard" class="profilecard"></div>
  </div>

  <div class="container">
    <h1>Profil uÅ¾ivatele</h1>
  <div id="profileCard" class="profilecard"></div>

    <!-- REVIEW SYSTEM START -->
    <div id="reviewsSection" class="reviews-container">
      <h2>Recenze</h2>
    <div id="reviewsList" class="reviews-list"></div>

      <div id="reviewFormContainer" class="review-form-container" style="display:none;">
        <label for="reviewRating">HodnocenÃ­:</label>
        <div id="starRating" class="star-rating">
          <span data-value="1">â˜…</span>
          <span data-value="2">â˜…</span>
          <span data-value="3">â˜…</span>
          <span data-value="4">â˜…</span>
          <span data-value="5">â˜…</span>
        </div>

        <textarea id="reviewText" placeholder="NapiÅ¡te svou recenzi..." rows="4"></textarea>
        <button id="submitReview" class="btn primary">Odeslat recenzi</button>
      </div>
      <p id="reviewNotice" class="small"></p>
    </div>
    <!-- REVIEW SYSTEM END -->
  </div>

  <script type="module">
    /* ===== Firebase imports ===== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    /* ===== Firebase config ===== */
    const firebaseConfig = {
      apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
      authDomain: "cztrainers-dat1.firebaseapp.com",
      databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cztrainers-dat1",
      storageBucket: "cztrainers-dat1.appspot.com",
      messagingSenderId: "369200533487",
      appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const auth = getAuth(app);

    /* ===== URL & DOM refs ===== */
    const urlParams   = new URLSearchParams(window.location.search);
    const userId      = urlParams.get("id"); // trainer id whose profile we view
    const profileCard = document.getElementById("profileCard");
      
  function renderSocialLinks(socials = {}) {
      const platforms = {
        instagram: usernameOrUrl =>
          usernameOrUrl?.startsWith("http")
            ? usernameOrUrl
            : `https://instagram.com/${String(usernameOrUrl).replace(/^@/, "")}`,
        facebook: usernameOrUrl =>
          usernameOrUrl?.startsWith("http")
            ? usernameOrUrl
            : `https://facebook.com/${String(usernameOrUrl).replace(/^@/, "")}`,
        tiktok: usernameOrUrl =>
          usernameOrUrl?.startsWith("http")
            ? usernameOrUrl
            : `https://tiktok.com/@${String(usernameOrUrl).replace(/^@/, "")}`
      };

      let html = "";
      for (let key in platforms) {
        if (socials[key] && String(socials[key]).trim() !== "") {
          const link = platforms[key](socials[key]);
          const displayName = String(socials[key]).startsWith("http")
            ? socials[key]
            : `@${String(socials[key]).replace(/^@/, "")}`;
          html += `<a href="${link}" target="_blank" class="social-tag">${key} ${displayName}</a>`;
        }
      }
      return html || "<p>Å½Ã¡dnÃ© sociÃ¡lnÃ­ sÃ­tÄ›</p>";
    }

    // ===== Load trainer profile (UNCHANGED LOGIC) =====
    if (userId) {
      const userRef = ref(db, 'users/' + userId);
      get(userRef).then(snapshot => {
        if (snapshot.exists()) {
          const user = snapshot.val();

          const specializations = Array.isArray(user.specializations)
            ? user.specializations.join(', ')
            : (typeof user.specializations === 'string' ? user.specializations : '-');

          const languages = Array.isArray(user.languages)
            ? user.languages.join(', ')
            : (typeof user.languages === 'string' ? user.languages : '-');

          profileCard.innerHTML = `
            <div class="profile-container">
              <div class="profile-left">
                <img class="profile-avatar" src="${user.profilePicture || 'https://placehold.co/300x300?text=Profil'}" alt="ProfilovÃ¡ fotka">
                <h2>${user.name || "NeznÃ¡mÃ½"} ${user.prijmeni || ""}</h2>
                <p><strong>ğŸ“ Lokalita:</strong> ${user.location || "-"}</p>
                <p><strong>ğŸ“ Telefon:</strong> ${user.phone || "-"}</p>
                <p><strong>ğŸ“§ Email:</strong> ${user.email || "-"}</p>
                <p><strong>ğŸŒ Moje sociÃ¡lnÃ­ sÃ­tÄ›:</strong></p>
                <p> </p>
                <div class="socials-container">
                  ${renderSocialLinks({
                    instagram: user.instagram,
                    facebook: user.facebook,
                    tiktok: user.tiktok
                  })}
                </div>
              </div>
              <div class="profile-right">
                <p class="bio-text"><strong>ğŸ§â€â™‚ï¸ O mnÄ›:</strong> ${user.bio || "-"}</p>
                <p><strong>ğŸ’ª Specializace:</strong></p>
                <div class="tag-list">
                  ${(Array.isArray(user.specializations) ? user.specializations : (user.specializations || "").split(","))
                    .map(s => `<span class="tag">${String(s).trim()}</span>`).join("") || "-"}
                </div>
                
                <p><strong>ğŸ—£ï¸ Jazyky:</strong></p>
                <div class="tag-list">
                  ${(Array.isArray(user.languages) ? user.languages : (user.languages || "").split(","))
                    .map(l => `<span class="tag">${String(l).trim()}</span>`).join("") || "-"}
                </div>

                <p><strong>ğŸ§  ZkuÅ¡enosti:</strong> ${user.experience || "-"} let</p>
                <p class="pricing-text"><strong>ğŸ’° Cena:</strong> ${user.pricing || "-"}</p>
              </div>
            </div>
          `;
        } else {
          profileCard.innerHTML = "<p>UÅ¾ivatel nebyl nalezen.</p>";
        }
      }).catch(error => {
        profileCard.innerHTML = `<p>Chyba naÄÃ­tÃ¡nÃ­: ${error.message}</p>`;
      });
    } else {
      profileCard.innerHTML = "<p>ChybÃ­ ID uÅ¾ivatele v URL.</p>";
    }

    /* ====== REVIEW SYSTEM ====== */
    const reviewsSection      = document.getElementById("reviewsSection");
    const reviewsList         = document.getElementById("reviewsList");
    const reviewFormContainer = document.getElementById("reviewFormContainer");
    const reviewText          = document.getElementById("reviewText");
    const submitReview        = document.getElementById("submitReview");
    const reviewNotice        = document.getElementById("reviewNotice");
    const starRating          = document.getElementById("starRating");
    let selectedRating = 0;

    // Only initialize if the review section exists and we have a trainer id
    if (reviewsSection && userId) {

      // --- Profanity check via PurgoMalum API (works for Czech) ---
      async function containsBadWords(text) {
        // If the service is unreachable, we choose "not profane" to avoid blocking legit users.
        try {
          const res = await fetch(
            `https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`
          );
          return (await res.text()) === "true";
        } catch {
          console.warn("Profanity API unavailable â€“ skipping check.");
          return false;
        }
      }

      // --- Star picker ---
      if (starRating) {
        starRating.querySelectorAll("span").forEach(star => {
          star.addEventListener("click", () => {
            selectedRating = parseInt(star.dataset.value);
            starRating.querySelectorAll("span").forEach(s => {
              s.classList.toggle("active", parseInt(s.dataset.value) <= selectedRating);
            });
          });
        });
      }

      // --- Load existing reviews ---
      function loadReviews() {
        const rRef = ref(db, `reviews/${userId}`);
        onValue(rRef, snap => {
          reviewsList.innerHTML = "";
          if (snap.exists()) {
            const reviews = snap.val();
            Object.keys(reviews).forEach(uid => {
              const r = reviews[uid];
              const stars = Math.max(1, Math.min(5, Number(r.rating) || 0));
              const card = document.createElement("div");
              card.className = "review-card";
              card.innerHTML = `
                <div class="review-stars">${"â˜…".repeat(stars)}${"â˜†".repeat(5 - stars)}</div>
                <p class="review-text">"${r.text}"</p>
                <p class="review-meta">â€” ${r.authorName || "UÅ¾ivatel"}, ${new Date(r.createdAt).toLocaleDateString("cs-CZ")}</p>
              `;
              reviewsList.appendChild(card);
            });
          } else {
            reviewsList.innerHTML = "<p>ZatÃ­m Å¾Ã¡dnÃ© recenze.</p>";
          }
        });
      }
      loadReviews();

      // --- Auth gating (no self-review, only once, redirect strangers) ---
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Prevent self-review
          if (user.uid === userId) {
            reviewNotice.textContent = "NemÅ¯Å¾ete psÃ¡t recenzi na sebe.";
            return;
          }

          // One review per user per trainer
          const myReviewSnap = await get(ref(db, `reviews/${userId}/${user.uid}`));
          if (myReviewSnap.exists()) {
            reviewNotice.textContent = "Recenzi jste jiÅ¾ napsali.";
            return;
          }

          // Enable form
          reviewFormContainer.style.display = "block";

          submitReview.onclick = async () => {
            const text = (reviewText?.value || "").trim();
            if (!text)          { alert("Recenze nemÅ¯Å¾e bÃ½t prÃ¡zdnÃ¡."); return; }
            if (!selectedRating){ alert("Vyberte hodnocenÃ­ (1â€“5 hvÄ›zdiÄek)."); return; }
            if (await containsBadWords(text)) { alert("Recenze obsahuje zakÃ¡zanÃ¡ slova."); return; }

            const reviewData = {
              text,
              rating: selectedRating,
              authorId: user.uid,
              authorName: user.displayName || "UÅ¾ivatel",
              createdAt: Date.now()
            };

            await set(ref(db, `reviews/${userId}/${user.uid}`), reviewData);
            reviewText.value = "";
            selectedRating = 0;
            starRating.querySelectorAll("span").forEach(s => s.classList.remove("active"));
            reviewNotice.textContent = "Recenze byla odeslÃ¡na.";
            reviewFormContainer.style.display = "none";
          };

        } else {
          // Stranger: show notice and redirect on any click in the section
          reviewNotice.textContent = "Pro psanÃ­ recenze se musÃ­te pÅ™ihlÃ¡sit.";
          reviewFormContainer.style.display = "none";
          reviewsSection.addEventListener("click", () => {
            window.location.href = "register.html";
          }, { once: true });
        }
      });
    }
  </script>

  <script type="module" src="auth-navbar.js"></script>
</body>
</html>
