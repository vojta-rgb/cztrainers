<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profil trenéra</title>
  <link rel="stylesheet" href="style_main.css"/>
  <link rel="stylesheet" href="navbar.css">
</head>
<body>
<!-- Navbar (isolated) -->
  <nav class="cznav" aria-label="Hlavní navigace">
    <div class="cznav__logo">
      <a href="index_main.html">
        <img src="CZtrainers new better.png" alt="CZTRAINERS Logo" />
      </a>
    </div>

    <!-- Right cluster: profile pill + theme + burger -->
    <div class="cznav__right">
      <a id="profilePill" class="cznav__pill" href="register.html" aria-label="Přihlásit / registrace">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M6 20a6 6 0 0112 0"></path>
        </svg>
        <span id="pillText">Login</span>
      </a>

      <button id="themeToggle" class="cznav__theme" type="button" aria-label="Přepnout motiv">
        <span id="themeIcon">☀️</span>
      </button>

      <button id="hamburger" class="cznav__hamburger" type="button" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <!-- Dropdown -->
    <div id="navLinks" class="cznav__menu" role="menu" aria-label="Navigace">
      <a href="o-nas.html" class="cznav__link">O nás</a>
      <a href="login.html" class="cznav__link" id="loginBtn">Přihlášení</a>
      <a href="#" class="cznav__link" id="logoutBtn" style="display:none">Odhlásit se</a>
    </div>
  </nav>

  <div class="container">
    <h1>Profil uživatele</h1>
    <div id="profileCard" class="profilecard"></div>
  </div>

  <div class="container">
    <h1>Profil uživatele</h1>
  <div id="profileCard" class="profilecard"></div>

    <!-- REVIEW SYSTEM START -->
    <div id="reviewsSection" class="reviews-container">
      <h2>Recenze</h2>
    <div id="reviewsList" class="reviews-list"></div>

      <div id="reviewFormContainer" class="review-form-container" style="display:none;">
        <label for="reviewRating">Hodnocení:</label>
        <div id="starRating" class="star-rating">
          <span data-value="1">★</span>
          <span data-value="2">★</span>
          <span data-value="3">★</span>
          <span data-value="4">★</span>
          <span data-value="5">★</span>
        </div>

        <textarea id="reviewText" placeholder="Napište svou recenzi..." rows="4"></textarea>
        <button id="submitReview" class="btn primary">Odeslat recenzi</button>
      </div>
      <p id="reviewNotice" class="small"></p>
    </div>
    <!-- REVIEW SYSTEM END -->
  </div>

  <!-- FIREBASE + PROFILE SCRIPT -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  // Czech profanity filter (bad-words-cz via CDN)
  import Filter from "https://cdn.jsdelivr.net/npm/bad-words-cz@1.0.4/dist/bad-words-cz.esm.js";

  const filter = new Filter();
  const firebaseConfig = {
    apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
    authDomain: "cztrainers-dat1.firebaseapp.com",
    databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "cztrainers-dat1",
    storageBucket: "cztrainers-dat1.appspot.com",
    messagingSenderId: "369200533487",
    appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const urlParams = new URLSearchParams(window.location.search);
  const userId = urlParams.get('id');
  const profileCard = document.getElementById("profileCard");

  function renderSocialLinks(socials = {}) {
    const platforms = {
      instagram: usernameOrUrl =>
        usernameOrUrl.startsWith("http")
          ? usernameOrUrl
          : `https://instagram.com/${usernameOrUrl.replace(/^@/, "")}`,
      facebook: usernameOrUrl =>
        usernameOrUrl.startsWith("http")
          ? usernameOrUrl
          : `https://facebook.com/${usernameOrUrl.replace(/^@/, "")}`,
      tiktok: usernameOrUrl =>
        usernameOrUrl.startsWith("http")
          ? usernameOrUrl
          : `https://tiktok.com/@${usernameOrUrl.replace(/^@/, "")}`
    };

    let html = "";
    for (let key in platforms) {
      if (socials[key] && socials[key].trim() !== "") {
        const link = platforms[key](socials[key]);
        const displayName = socials[key].startsWith("http")
          ? socials[key]
          : `@${socials[key].replace(/^@/, "")}`;
        html += `<a href="${link}" target="_blank" class="social-tag">${key} ${displayName}</a>`;
      }
    }
    return html || "<p>Žádné sociální sítě</p>";
  }

  if (userId) {
    const userRef = ref(db, 'users/' + userId);
    get(userRef).then(snapshot => {
      if (snapshot.exists()) {
        const user = snapshot.val();

        const specializations = Array.isArray(user.specializations)
          ? user.specializations.join(', ')
          : (typeof user.specializations === 'string' ? user.specializations : '-');

        const languages = Array.isArray(user.languages)
          ? user.languages.join(', ')
          : (typeof user.languages === 'string' ? user.languages : '-');

        profileCard.innerHTML = `
          <div class="profile-container">
            <div class="profile-left">
              <img class="profile-avatar" src="${user.profilePicture || 'https://placehold.co/300x300?text=Profil'}" alt="Profilová fotka">
              <h2>${user.name || "Neznámý"} ${user.prijmeni || ""}</h2>
              <p><strong>📍 Lokalita:</strong> ${user.location || "-"}</p>
              <p><strong>📞 Telefon:</strong> ${user.phone || "-"}</p>
              <p><strong>📧 Email:</strong> ${user.email || "-"}</p>
              <p><strong>🌐 Moje sociální sítě:</strong></p>
              <p> </p>
              <div class="socials-container">
                ${renderSocialLinks({
                  instagram: user.instagram,
                  facebook: user.facebook,
                  tiktok: user.tiktok
                })}
              </div>
            </div>
            <div class="profile-right">
              <p class="bio-text"><strong>🧍‍♂️ O mně:</strong> ${user.bio || "-"}</p>
              <p><strong>💪 Specializace:</strong></p>
              <div class="tag-list">
                ${(Array.isArray(user.specializations) ? user.specializations : (user.specializations || "").split(","))
                  .map(s => `<span class="tag">${s.trim()}</span>`).join("") || "-"}
              </div>
              
              <p><strong>🗣️ Jazyky:</strong></p>
              <div class="tag-list">
                ${(Array.isArray(user.languages) ? user.languages : (user.languages || "").split(","))
                  .map(l => `<span class="tag">${l.trim()}</span>`).join("") || "-"}
              </div>

              <p><strong>🧠 Zkušenosti:</strong> ${user.experience || "-"} let</p>
              <p class="pricing-text"><strong>💰 Cena:</strong> ${user.pricing || "-"}</p>
            </div>
          </div>
        `;
      } else {
        profileCard.innerHTML = "<p>Uživatel nebyl nalezen.</p>";
      }
    }).catch(error => {
      profileCard.innerHTML = `<p>Chyba načítání: ${error.message}</p>`;
    });
  } else {
    profileCard.innerHTML = "<p>Chybí ID uživatele v URL.</p>";
  }

  const starRating = document.getElementById("starRating");
  let selectedRating = 0;

  // Handle star selection
  starRating.querySelectorAll("span").forEach(star => {
    star.addEventListener("click", () => {
      selectedRating = parseInt(star.dataset.value);
      starRating.querySelectorAll("span").forEach(s => {
        s.classList.toggle("active", parseInt(s.dataset.value) <= selectedRating);
      });
    });
  });

  // Load reviews
  function loadReviews() {
    const reviewsRef = dbRef(db, `reviews/${userId}`);
    onValue(reviewsRef, snapshot => {
      reviewsList.innerHTML = "";
      if (snapshot.exists()) {
        const reviews = snapshot.val();
        Object.keys(reviews).forEach(uid => {
          const r = reviews[uid];
          const div = document.createElement("div");
          div.className = "review-card";
          div.innerHTML = `
            <div class="review-stars">${"★".repeat(r.rating)}${"☆".repeat(5-r.rating)}</div>
            <p class="review-text">"${r.text}"</p>
            <p class="review-meta">— ${r.authorName || "Uživatel"}, ${new Date(r.createdAt).toLocaleDateString("cs-CZ")}</p>
          `;
          reviewsList.appendChild(div);
        });
      } else {
        reviewsList.innerHTML = "<p>Zatím žádné recenze.</p>";
      }
    });
  }

  loadReviews();

  // Handle auth
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const trainerSnap = await get(dbRef(db, "users/" + userId));
      const trainerData = trainerSnap.val();
      
      if (user.uid === userId) {
        reviewNotice.textContent = "Nemůžete psát recenzi na sebe.";
        return;
      }

      const userReviewSnap = await get(dbRef(db, `reviews/${userId}/${user.uid}`));
      if (userReviewSnap.exists()) {
        reviewNotice.textContent = "Recenzi jste již napsali.";
        return;
      }

      reviewFormContainer.style.display = "block";
      submitReview.onclick = async () => {
        const text = reviewText.value.trim();
        if (!text) return alert("Recenze nemůže být prázdná.");
        if (!selectedRating) return alert("Vyberte hodnocení (1–5 hvězdiček).");
        if (filter.isProfane(text)) return alert("Recenze obsahuje zakázaná slova.");

        const reviewData = {
          text,
          rating: selectedRating,
          authorId: user.uid,
          authorName: user.displayName || "Uživatel",
          createdAt: Date.now()
        };

        await set(dbRef(db, `reviews/${userId}/${user.uid}`), reviewData);
        reviewText.value = "";
        selectedRating = 0;
        starRating.querySelectorAll("span").forEach(s => s.classList.remove("active"));
        reviewNotice.textContent = "Recenze byla odeslána.";
        reviewFormContainer.style.display = "none";
      };
    } else {
      reviewNotice.textContent = "Pro psaní recenze se musíte přihlásit.";
    }
  });
  </script>

  <script type="module" src="auth-navbar.js"></script>
</body>
</html>
