<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registrace tren√©ra ‚Äì CZTRAINERS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-logo">
      <a href="index_main.html"><img src="CZtrainers new better.png" alt="CZTRAINERS Logo"></a>
    </div>

    <!-- RIGHT: pill + (desktop) theme + burger -->
    <div class="nav-right">
      <!-- Profile/Login pill -->
      <a id="profilePill" class="nav-button profile-pill" href="register.html" aria-label="P≈ôihl√°sit / registrace">
        <!-- simple user icon -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="margin-right:.45rem">
          <circle cx="12" cy="8" r="4"></circle><path d="M6 20a6 6 0 0112 0"></path>
        </svg>
        <span id="pillText">Login</span>
      </a>

      <!-- desktop theme toggle -->
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="P≈ôepnout motiv">
        <span id="themeIcon">‚òÄÔ∏è</span>
      </button>

      <!-- Hamburger -->
      <button class="hamburger" id="hamburger" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <!-- DROPDOWN -->
    <div class="nav-links" id="navLinks" role="menu" aria-label="Navigace">
      <a href="o-nas.html" class="nav-button">O n√°s</a>
      <a href="login.html" class="nav-button" id="loginBtn">P≈ôihl√°≈°en√≠</a>
      <a href="#" class="nav-button" id="logoutBtn" style="display:none">Odhl√°sit se</a>

      <!-- mobile theme toggle (desktop hides this one) -->
      <button class="theme-toggle" id="themeToggleMobile" type="button" aria-label="P≈ôepnout motiv (mobil)">
        <span>üåó</span>
      </button>
    </div>
  </nav>

  <!-- FORM CARD -->
  <main class="page-wrapper">
    <div class="form-container">
      <h1 class="title">Registrace tren√©ra</h1>

      <form id="registerForm" class="form">
        <!-- Obr√°zek -->
        <div class="field">
          <label for="profileImage">P≈ôidejte profilov√Ω obr√°zek</label>
          <img id="profilePreview" src="" alt="Profilov√Ω obr√°zek" style="display:none" />
          <input type="file" id="profileImage" accept="image/*" />
          <p class="hint">Max 500&nbsp;KB ¬∑ Nevhodn√© obr√°zky se zam√≠tnou.</p>
        </div>

        <!-- Osobn√≠ √∫daje -->
        <h3 class="section">Osobn√≠ √∫daje</h3>
        <div class="grid-2">
          <div class="field">
            <label for="name">Jm√©no</label>
            <input type="text" id="name" placeholder="Jm√©no" required />
          </div>
          <div class="field">
            <label for="prijmeni">P≈ô√≠jmen√≠</label>
            <input type="text" id="prijmeni" placeholder="P≈ô√≠jmen√≠" required />
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="email">E-mail</label>
            <input type="email" id="email" placeholder="nap≈ô. jan.novak@email.cz" required />
          </div>
          <div class="field">
            <label for="password">Heslo</label>
            <input type="password" id="password" placeholder="Min. 6 znak≈Ø" required />
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="phone">Telefon</label>
            <input type="tel" id="phone" placeholder="+420 123 456 789" required pattern="\+?[0-9\s]{9,15}" />
          </div>
          <div class="field">
            <label for="datum">Datum narozen√≠</label>
            <input type="date" id="datum" required />
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="gender">Pohlav√≠</label>
            <select id="gender" required>
              <option value="">Vyber pohlav√≠</option>
              <option value="muz">Mu≈æ</option>
              <option value="zena">≈Ωena</option>
              <option value="jine">Jin√©</option>
            </select>
          </div>
          <div class="field">
            <label for="location">Kraj</label>
            <select id="location" required>
              <option value="">Vyber kraj</option>
              <option value="Hlavn√≠ mƒõsto Praha">Hlavn√≠ mƒõsto Praha</option>
              <option value="St≈ôedoƒçesk√Ω kraj">St≈ôedoƒçesk√Ω kraj</option>
              <option value="Jihoƒçesk√Ω kraj">Jihoƒçesk√Ω kraj</option>
              <option value="Plze≈àsk√Ω kraj">Plze≈àsk√Ω kraj</option>
              <option value="Karlovarsk√Ω kraj">Karlovarsk√Ω kraj</option>
              <option value="√östeck√Ω kraj">√östeck√Ω kraj</option>
              <option value="Libereck√Ω kraj">Libereck√Ω kraj</option>
              <option value="Kr√°lov√©hradeck√Ω kraj">Kr√°lov√©hradeck√Ω kraj</option>
              <option value="Pardubick√Ω kraj">Pardubick√Ω kraj</option>
              <option value="Vysoƒçina">Vysoƒçina</option>
              <option value="Jihomoravsk√Ω kraj">Jihomoravsk√Ω kraj</option>
              <option value="Olomouck√Ω kraj">Olomouck√Ω kraj</option>
              <option value="Zl√≠nsk√Ω kraj">Zl√≠nsk√Ω kraj</option>
              <option value="Moravskoslezsk√Ω kraj">Moravskoslezsk√Ω kraj</option>
            </select>
          </div>
        </div>

        <!-- O mnƒõ -->
        <div class="field">
          <label for="bio">O mnƒõ</label>
          <textarea id="bio" placeholder="Kr√°tk√Ω popis (specializace, zku≈°enosti‚Ä¶)" required></textarea>
        </div>

        <!-- Specializace -->
        <h3 class="section">Specializace</h3>
        <div id="specializationOptions" class="checkbox-group">
          <label><input type="checkbox" name="specializations" value="Fitness" /> Fitness</label>
          <label><input type="checkbox" name="specializations" value="Kondiƒçn√≠ tr√©nink" /> Kondiƒçn√≠ tr√©nink</label>
          <label><input type="checkbox" name="specializations" value="Silov√Ω tr√©nink" /> Silov√Ω tr√©nink</label>
          <label><input type="checkbox" name="specializations" value="Hubnut√≠" /> Hubnut√≠</label>
          <label><input type="checkbox" name="specializations" value="V√Ω≈æiva" /> V√Ω≈æiva / Nutriƒçn√≠ poradenstv√≠</label>
          <label><input type="checkbox" name="specializations" value="Rehabilitace" /> Rehabilitace</label>
          <label><input type="checkbox" name="specializations" value="Bƒõh√°n√≠" /> Bƒõh√°n√≠</label>
          <label><input type="checkbox" name="specializations" value="J√≥ga" /> J√≥ga</label>
          <label><input type="checkbox" name="specializations" value="Pilates" /> Pilates</label>
          <label><input type="checkbox" name="specializations" value="Skupinov√© lekce" /> Skupinov√© lekce</label>
        </div>

        <!-- Cen√≠k + Zku≈°enosti -->
        <div class="grid-2">
          <div class="field">
            <label for="pricing">Cen√≠k</label>
            <textarea id="pricing" placeholder="Nap≈ô. 700 Kƒç/hod ¬∑ Bal√≠ƒçky‚Ä¶" required></textarea>
          </div>
          <div class="field">
            <label for="experience">Zku≈°enosti (roky)</label>
            <input type="number" id="experience" min="0" max="50" placeholder="Roky zku≈°enost√≠" />
          </div>
        </div>

        <!-- Jazyky -->
        <h3 class="section">Jazyky</h3>
        <div id="languageOptions" class="checkbox-group">
          <label><input type="checkbox" name="languages" value="CZ" /> ƒåe≈°tina (CZ)</label>
          <label><input type="checkbox" name="languages" value="EN" /> Angliƒçtina (EN)</label>
          <label><input type="checkbox" name="languages" value="DE" /> Nƒõmƒçina (DE)</label>
          <label><input type="checkbox" name="languages" value="SK" /> Sloven≈°tina (SK)</label>
          <label><input type="checkbox" name="languages" value="RU" /> Ru≈°tina (RU)</label>
          <label><input type="checkbox" name="languages" value="FR" /> Francouz≈°tina (FR)</label>
        </div>

        <!-- Socials -->
        <h3 class="section">Soci√°ln√≠ s√≠tƒõ (voliteln√©)</h3>
        <div class="grid-3">
          <div class="field">
            <label for="instagram">Instagram</label>
            <input type="text" id="instagram" placeholder="u≈æivatelsk√© jm√©no nebo odkaz" />
          </div>
          <div class="field">
            <label for="facebook">Facebook</label>
            <input type="text" id="facebook" placeholder="u≈æivatelsk√© jm√©no nebo odkaz" />
          </div>
          <div class="field">
            <label for="tiktok">TikTok</label>
            <input type="text" id="tiktok" placeholder="u≈æivatelsk√© jm√©no nebo odkaz" />
          </div>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button type="submit" class="btn primary">Odeslat</button>
          <button type="button" class="btn btn-red" onclick="window.location.href='register.html'">Zpƒõt</button>
        </div>
      </form>
    </div>
  </main>

  <!-- TFJS must load before nsfwjs -->
  <script src="https://unpkg.com/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>

  <!-- Your local UMD build that exposes window.nsfwjs -->
  <script src="vendor/nsfwjs.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, sendEmailVerification, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
      authDomain: "cztrainers-dat1.firebaseapp.com",
      databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cztrainers-dat1",
      storageBucket: "cztrainers-dat1.appspot.com",
      messagingSenderId: "369200533487",
      appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };

    const CLOUD_NAME = "dkt3pdcbe";
    const SIGNER_URL = "https://wandering-sunset-c489.aiman18192.workers.dev/";
    const MAX_FILE_SIZE = 500 * 1024;
    const MAX_DIM = 800;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const profileImageInput = document.getElementById("profileImage");

      // File size guard
    profileImageInput.addEventListener("change", () => {
      const file = profileImageInput.files[0];
      if (file && file.size > MAX_FILE_SIZE) {
        alert("Soubor je p≈ô√≠li≈° velk√Ω. Maxim√°ln√≠ velikost je 500 KB.");
        profileImageInput.value = "";
      }
    });

    // --- preview of selected profile photo ---
    const preview = document.getElementById("profilePreview");

    profileImageInput.addEventListener("change", () => {
      const file = profileImageInput.files[0];

      // clear preview if nothing selected
      if (!file) {
        preview.removeAttribute("src");
        preview.style.display = "none";
        return;
      }

      // guard: only images + size limit
      if (!file.type.startsWith("image/")) {
        alert("Vybran√Ω soubor nen√≠ obr√°zek.");
        profileImageInput.value = "";
        preview.style.display = "none";
        return;
      }
      if (file.size > MAX_FILE_SIZE) {
        alert("Soubor je p≈ô√≠li≈° velk√Ω. Maxim√°ln√≠ velikost je 500 KB.");
        profileImageInput.value = "";
        preview.style.display = "none";
        return;
      }

      // show preview (use a blob URL; revoke old one if any)
      if (preview.dataset.blobUrl) URL.revokeObjectURL(preview.dataset.blobUrl);
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.dataset.blobUrl = url;
      preview.style.display = "block";
    });


    // Helpers: downscale, NSFW, signature, signed upload
    async function downscaleImage(file, maxDim = MAX_DIM, mime = "image/jpeg", quality = 0.9) {
      const img = await new Promise((res, rej) => {
        const i = new Image();
        i.onload = () => res(i);
        i.onerror = rej;
        i.src = URL.createObjectURL(file);
      });
      const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      canvas.getContext("2d").drawImage(img, 0, 0, w, h);
      return new Promise((res) => canvas.toBlob(res, mime, quality));
    }

    // ---------- NSFWJS (local if possible, otherwise CDN) ----------
let nsfwModelPromise = null;

// Try local model first; if missing (404), fall back to CDN
async function getNSFWModel() {
  if (nsfwModelPromise) return nsfwModelPromise;

  const LOCAL_DIR = "./vendor/nsfw-model/";                 // directory that contains model.json + shard files
  const LOCAL_PROBE = LOCAL_DIR + "model.json";
  const CDN_DIR   = "https://unpkg.com/nsfwjs@2/dist/model/";

  // Probe the local model.json (HEAD = cheap and fast)
  let modelDir = CDN_DIR;
    try {
      const res = await fetch(LOCAL_PROBE, { method: "HEAD", cache: "no-store" });
      if (res.ok) modelDir = LOCAL_DIR;
    } catch (_) { /* ignore; use CDN */ }

    // window.nsfwjs is provided by vendor/nsfwjs.min.js
    const NS = window.nsfwjs;
    if (!NS) throw new Error("NSFWJS UMD not loaded (vendor/nsfwjs.min.js)");

    nsfwModelPromise = NS.load(modelDir);
    return nsfwModelPromise;
  }

  // (optional) warm-up so first use is instant
  getNSFWModel().catch(err => console.error("[nsfw] preload failed:", err));

  async function isImageSafe(file) {
    const model = await getNSFWModel();
    const dataURL = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(file); });
    const img = new Image();
    await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = dataURL; });
    const preds = await model.classify(img);
    const score = { Sexy: 0, Porn: 0, Hentai: 0 };
    preds.forEach(p => { if (score[p.className] != null) score[p.className] = p.probability; });
    if (score.Porn + score.Hentai >= 0.2) return false;
    if (score.Sexy >= 0.5) return false;
    return true;
  }
async function getSignature(params){
  try {
    const r = await fetch(SIGNER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(params)
    });
    if (!r.ok) {
      const txt = await r.text().catch(()=>"(no body)");
      throw new Error(`Signature service HTTP ${r.status}: ${txt}`);
    }
    return r.json();
  } catch (e) {
    console.error("Signer error:", e);
    throw new Error("Nepoda≈ôilo se kontaktovat podpisovou slu≈æbu (Worker). Zkontrolujte CORS a nasazen√≠.");
  }
}

    async function uploadPfpSigned({ file, uid }){
      const public_id = `users/${uid}/pfp`;
      const timestamp = Math.floor(Date.now()/1000);
      const { signature, apiKey } = await getSignature({ public_id, timestamp, overwrite:true, invalidate:true });

      const form = new FormData();
      form.append("file", file, "pfp.jpg");   // instead of form.append("file", file)
      form.append("api_key", apiKey);
      form.append("timestamp", String(timestamp));
      form.append("public_id", public_id);
      form.append("overwrite", "true");
      form.append("invalidate", "true");
      form.append("signature", signature);

      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
      let resp;
      try {
        resp = await fetch(url, { method:"POST", body: form });
      } catch (e) {
        console.error("Network error to Cloudinary:", e);
        throw new Error("Nelze se p≈ôipojit ke Cloudinary (s√≠≈•/CORS).");
      }
      if (!resp.ok) {
        const body = await resp.text().catch(()=>"(no body)");
        console.error("Cloudinary error:", resp.status, body);
        throw new Error(`Cloudinary chyba ${resp.status}: ${body}`);
      }
      return resp.json();
    }

    document.getElementById("registerForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const rawFile  = document.getElementById("profileImage").files[0];
    const email    = document.getElementById("email").value;
    const password = document.getElementById("password").value;

    try {
      // 1) Create auth user
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;

      // 2) Send verification email RIGHT AWAY (before any DB writes)
      auth.useDeviceLanguage();
      try {
        await sendEmailVerification(user);   // ‚Üê no actionCodeSettings
      } catch (err) {
        alert("Nepoda≈ôilo se odeslat ovƒõ≈ôovac√≠ e-mail: " + err.code + " ‚Äî " + err.message);
        throw err; // stop the flow if email couldn‚Äôt be queued
      }


      // 3) (Optional) process & upload profile photo
      let profilePictureUrl = "";
      if (rawFile && rawFile.size <= MAX_FILE_SIZE) {
        const blob = await downscaleImage(rawFile);
        const jpg  = new File([blob], "pfp.jpg", { type: "image/jpeg" });

        const safe = await isImageSafe(jpg);
        if (!safe) {
          alert("Tento obr√°zek nen√≠ vhodn√Ω pro profil (NSFW). Zvolte pros√≠m jin√Ω.");
          await signOut(auth);
          return;
        }

        const { secure_url } = await uploadPfpSigned({ file: jpg, uid: user.uid });
        profilePictureUrl = secure_url;
      }

      // 4) Prepare trainer data
      const socials = {
        instagram: document.getElementById("instagram").value.trim(),
        facebook:  document.getElementById("facebook").value.trim(),
        tiktok:    document.getElementById("tiktok").value.trim()
      };

      const userData = {
        name: document.getElementById("name").value,
        prijmeni: document.getElementById("prijmeni").value,
        email: user.email,
        datum: document.getElementById("datum").value,
        phone: document.getElementById("phone").value,
        gender: document.getElementById("gender").value,
        location: document.getElementById("location").value,
        bio: document.getElementById("bio").value,
        specializations: Array.from(document.querySelectorAll('input[name="specializations"]:checked')).map(el => el.value).join(", "),
        pricing: document.getElementById("pricing").value,
        experience: document.getElementById("experience").value,
        languages: Array.from(document.querySelectorAll('input[name="languages"]:checked')).map(el => el.value).join(", "),
        profilePicture: profilePictureUrl,
        socials
      };

      // 5) Write to "unverified-users" (may be blocked if App Check is enforced,
      //    but the verification email has already been sent)
      try {
        await set(ref(db, 'unverified-users/' + user.uid), userData);
      } catch (dbErr) {
        console.warn("DB write failed (will still allow email verification):", dbErr);
        // carry on ‚Äî they can verify email and you can migrate on first login
      }

      alert("Ovƒõ≈ôovac√≠ e-mail byl odesl√°n. Zkontrolujte pros√≠m doruƒçenou po≈°tu/spam.");
      await signOut(auth);
      this.reset();
      window.location.href = "login.html";

    } catch (error) {
      alert("Chyba p≈ôi registraci: " + error.message);
      try { await signOut(auth); } catch {}
    }
  });
  </script>
  <script type="module" src="auth-navbar.js"></script>
</body>
</html>
