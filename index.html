<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZTRAINERS</title>

  <!-- Fonts + global stylesheet -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="style_main.css" />
  <link rel="stylesheet" href="navbar.css">
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body>
  <!-- Navbar (isolated) -->
  <nav class="cznav" aria-label="Hlavn√≠ navigace">
    <div class="cznav__logo">
      <a href="index.html">
        <img src="assets/CZTrainersNew.png" alt="CZTRAINERS Logo" />
      </a>
    </div>

    <!-- Right cluster: profile pill + theme + burger -->
    <div class="cznav__right">
      <a id="profilePill" class="cznav__pill" href="register.html" aria-label="P≈ôihl√°sit / registrace">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M6 20a6 6 0 0112 0"></path>
        </svg>
        <span id="pillText">Login</span>
      </a>

      <button id="themeToggle" class="cznav__theme" type="button" aria-label="P≈ôepnout motiv">
        <span id="themeIcon">‚òÄÔ∏è</span>
      </button>

      <button id="hamburger" class="cznav__hamburger" type="button" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <!-- Dropdown -->
    <div id="navLinks" class="cznav__menu" role="menu" aria-label="Navigace">
      <a href="index.html" class="cznav__link">Dom≈Ø</a>
      <a href="mapa-treneru.html" class="cznav__link">Mapa Tren√©r≈Ø</a>
      <a href="o-nas.html" class="cznav__link">O n√°s</a>
      <a href="login.html" class="cznav__link" id="loginBtn">P≈ôihl√°≈°en√≠</a>
      <a href="#" class="cznav__link" id="logoutBtn" style="display:none">Odhl√°sit se</a>
    </div>
  </nav>
  <script type="module" src="auth-navbar.js"></script>
  
  <!-- CZTRAINERS: NEW HERO SECTION -->
  <section class="cz-hero" aria-labelledby="cz-hero-title" role="region">
    <div class="cz-hero__bg" aria-hidden="true"></div> <!-- background pattern stays visible under overlay -->
    <div class="cz-hero__overlay" aria-hidden="true"></div> <!-- dark layer for contrast -->

    <div class="cz-container cz-hero__content">
      <!-- left: text -->
      <div class="cz-hero__left">
        <h1 id="cz-hero-title" class="cz-hero__title animate__animated animate__fadeInDown">
          Najdƒõte ide√°ln√≠ho tren√©ra v ƒåR ‚Äî rychle.
        </h1>
        <p class="cz-hero__subtitle animate__animated animate__fadeInUp animate__delay-1s">
          Zobraz√≠me tren√©ry na mapƒõ. Hledejte podle lokality, specializace nebo zku≈°enost√≠.
        </p>

        <!-- three features 
        <div class="cz-features">
          <div class="cz-feature animate__animated animate__fadeInUp" style="animation-delay: 0s">
            <div class="cz-feature__icon">üìç</div>
            <div class="cz-feature__text">
              <strong>Lokalita</strong><br><span>Najdƒõte tren√©ry bl√≠zko v√°s</span>
            </div>
          </div>

          <div class="cz-feature animate__animated animate__fadeInUp" style="animation-delay: 0.15s">
            <div class="cz-feature__icon">üèãÔ∏è‚Äç‚ôÄÔ∏è</div>
            <div class="cz-feature__text">
              <strong>Specializace</strong><br><span>Fitness, silov√Ω tr√©nink, bƒõh a v√≠c</span>
            </div>
          </div>

          <div class="cz-feature animate__animated animate__fadeInUp" style="animation-delay: 0.30s">
            <div class="cz-feature__icon">‚è≥</div>
            <div class="cz-feature__text">
              <strong>Zku≈°enosti</strong><br><span>Filtrovat podle praxe a zku≈°enost√≠</span>
            </div>
          </div>
        </div>
        -->
        <!-- main CTAs -->
        <div class="cz-hero__ctas">
          <a href="mapa-treneru.html"
            id="cz-hero-map-btn"
            class="cz-btn cz-btn--primary animate__animated animate__pulse"
            aria-label="Zobrazit tren√©ry na mapƒõ">
            <!-- inline SVG map+pin -->
            <span class="cz-btn__icon" aria-hidden="true">
              <svg width="28" height="28" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" focusable="false">
                <g fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M32 6 C20 6 12 14 12 26 C12 40 32 58 32 58 C32 58 52 40 52 26 C52 14 44 6 32 6 Z"/>
                </g>
                <circle cx="32" cy="26" r="6"/>
              </svg>
            </span>
            <span>Zobrazit tren√©ry na mapƒõ</span>
          </a>

          <button id="cz-hero-search-btn" class="cz-btn cz-btn--outline" aria-label="P≈ôej√≠t na vyhled√°v√°n√≠ tren√©r≈Ø">
            Vyhledat tren√©ra
          </button>
        </div>

        <p class="cz-hero__note">Nebo pou≈æijte vyhled√°v√°n√≠ n√≠≈æe pro p≈ôesnƒõj≈°√≠ v√Ωsledky.</p>
      </div>

      <!-- right: decorative map preview (image) -->
      <div class="cz-hero__right" data-aos="zoom-in">
          <a href="mapa-treneru.html">
            <img class="cz-hero__map-preview" src="assets/cztrainersmap.png" alt="N√°hled mapy tren√©r≈Ø" loading="lazy">
          </a>
      </div>
    </div>
  </section>
  <!-- END CZTRAINERS HERO SECTION -->
  <div class="fade-between"></div>
  <!-- PAGE CONTENT -->
  <div class="container">
    <h1 class="animate__animated animate__fadeInUp">PROFESION√ÅLN√ç TREN√â≈òI V ƒåESK√â REPUBLICE</h1>

    <!-- Toolbar: search + filters button + active chips -->
    <div class="toolbar">
      <div class="search-wrap">
        <input type="text" id="search" placeholder="Hledat jm√©no..." />
        <button id="filtersToggle" type="button" class="filters-toggle">Filtry</button>
      </div>
      <div id="activeChips" class="chips"></div>
    </div>

    <!-- Filters panel -->
    <div id="filtersPanel" class="filters-panel" hidden>
      <div class="filters-grid">
        <fieldset>
          <legend>Lokalita</legend>
          <div id="f-locations"></div>
        </fieldset>
        <fieldset>
          <legend>Specializace</legend>
          <div id="f-specs">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Jazyky</legend>
          <div id="f-langs">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Pohlav√≠</legend>
          <div id="f-genders">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Zku≈°enosti (roky)</legend>
          <div class="number-row">
            <input type="number" id="f-exp-min" min="0" placeholder="Min" />
            <input type="number" id="f-exp-max" min="0" placeholder="Max" />
          </div>
          <div id="f-exp-hint" class="small"></div>
        </fieldset>
        <fieldset>
          <legend>Obl√≠ben√≠</legend>
          <label style="display:block; margin:.25rem 0;">
            <input type="checkbox" id="f-only-favs"> Moji obl√≠ben√≠
          </label>
        </fieldset>

        <fieldset>
          <legend>≈òazen√≠</legend>
          <select id="f-sort" style="width:100%; height:40px; border-radius:10px; border:1px solid #e5e7eb; padding:0 .6rem;">
            <option value="default">V√Ωchoz√≠</option>
            <option value="popular">Nejobl√≠benƒõj≈°√≠</option>
          </select>
        </fieldset>
      </div>
      <div class="filters-actions">
        <button id="filtersClear" class="btn">Vymazat v≈°e</button>
        <button id="filtersApply" class="btn primary">Pou≈æ√≠t</button>
      </div>
    </div>

    <div id="loader" class="loader">Naƒç√≠t√°m u≈æivatele...</div>
    <div id="userList" class="cards"></div>
  </div>

  <div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, get, set, remove, runTransaction, onValue, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  // --- Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
    authDomain: "cztrainers-dat1.firebaseapp.com",
    databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "cztrainers-dat1",
    storageBucket: "cztrainers-dat1.appspot.com",
    messagingSenderId: "369200533487",
    appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
  };
  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const auth = getAuth(app);

  // --- Cloudinary thumb helper ---
  const CLOUD_NAME = "dkt3pdcbe";
  const clThumb = (uid) => `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/c_fill,w_320,h_320,q_auto,f_auto/users/${uid}/pfp`;

  // --- DOM ---
  const userList      = document.getElementById("userList");
  const searchInput   = document.getElementById("search");
  const loader        = document.getElementById("loader");
  const filtersToggle = document.getElementById("filtersToggle");
  const filtersPanel  = document.getElementById("filtersPanel");
  const chipsWrap     = document.getElementById("activeChips");

  const boxLocations = document.getElementById("f-locations");
  const boxSpecs     = document.getElementById("f-specs");
  const boxLangs     = document.getElementById("f-langs");
  const boxGenders   = document.getElementById("f-genders");
  const expMinInput  = document.getElementById("f-exp-min");
  const expMaxInput  = document.getElementById("f-exp-max");
  const expHint      = document.getElementById("f-exp-hint");

  const onlyFavsCheckbox = document.getElementById("f-only-favs");
  const sortSelect       = document.getElementById("f-sort");

  const btnApply = document.getElementById("filtersApply");
  const btnClear = document.getElementById("filtersClear");

  // Normalizes location to a displayable string ("City, Region")
  function locationText(loc) {
    if (!loc) return "";
    if (typeof loc === "string") return loc;
    const city   = (loc.city   || "").trim();
    const region = (loc.region || "").trim();
    return city && region ? `${city}, ${region}` : (city || region || "");
  }

  const toastEl = document.getElementById("toast");
  const toast = (msg) => {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 1800);
  };
  // --- Fixed list of Czech regions for the Location filter ---
  const CZECH_REGIONS = [
    "Hlavn√≠ mƒõsto Praha",
    "St≈ôedoƒçesk√Ω kraj",
    "Jihoƒçesk√Ω kraj",
    "Plze≈àsk√Ω kraj",
    "Karlovarsk√Ω kraj",
    "√östeck√Ω kraj",
    "Libereck√Ω kraj",
    "Kr√°lov√©hradeck√Ω kraj",
    "Pardubick√Ω kraj",
    "Vysoƒçina",
    "Jihomoravsk√Ω kraj",
    "Olomouck√Ω kraj",
    "Zl√≠nsk√Ω kraj",
    "Moravskoslezsk√Ω kraj"
  ];
  // badge catalog (you can extend it)
  const BADGE_META = {
    verified:   { label: 'Ovƒõ≈ôen√Ω', icon: '‚úîÔ∏è', cls: 'b-verified' },
    'top-rated':{ label: 'Top',      icon: '‚≠ê',  cls: 'b-top'      },
    pro:        { label: 'Pro',      icon: 'üèÖ',  cls: 'b-pro'      },
    recommended:{ label: 'Doporuƒçujeme', icon: 'üëç', cls: 'b-rec'  },
    new:        { label: 'Nov√Ω',     icon: 'üÜï',  cls: 'b-new'      },
  };

  function badgePiece(key){
    const m = BADGE_META[key] || { label: key, icon: 'üè∑Ô∏è', cls: 'b-generic' };
    // class uses the key so ‚Äútop-rated‚Äù becomes ‚Äúbadge--top-rated‚Äù (valid css)
    return `<span class="badge badge--${key} ${m.cls}" title="${m.label}"><i>${m.icon}</i>${m.label}</span>`;
  }

  // --- State ---
  let allUsers = [];                 // [ [uid, user], ... ]
  let facets   = null;
  let me = null;                     // current auth user
  let myFavSet = new Set();          // trainer UIDs I favorited
  let favCounts = {};                // { trainerUid: number }
  const favBusy = new Set();
  
  // toggle filters panel
  filtersToggle.addEventListener("click", () => {
    const isHidden = filtersPanel.hasAttribute("hidden");
    if (isHidden) { filtersPanel.removeAttribute("hidden"); filtersPanel.classList.add("open"); }
    else { filtersPanel.setAttribute("hidden",""); filtersPanel.classList.remove("open"); }
  });

  // --- Facets helpers ---
  const uniqPush = (set, val) => { if (val && String(val).trim()) set.add(String(val).trim()); };

  function buildFacets(users){
    const locations = new Set(), specs = new Set(), langs = new Set(), genders = new Set();
    let expMin = Infinity, expMax = -Infinity;

    users.forEach(([_, u]) => {
      uniqPush(locations, locationText(u.location));
      uniqPush(genders,   u.gender);

      const sArr = Array.isArray(u.specializations) ? u.specializations :
        (typeof u.specializations === 'string' ? u.specializations.split(',').map(s=>s.trim()) : []);
      sArr.forEach(v => uniqPush(specs, v));

      const lArr = Array.isArray(u.languages) ? u.languages :
        (typeof u.languages === 'string' ? u.languages.split(',').map(s=>s.trim()) : []);
      lArr.forEach(v => uniqPush(langs, v));

      const e = Number(u.experience || 0);
      if (Number.isFinite(e)) { expMin = Math.min(expMin, e); expMax = Math.max(expMax, e); }
    });

    if (!Number.isFinite(expMin)) expMin = 0;
    if (!Number.isFinite(expMax)) expMax = 0;
    return { locations, specs, langs, genders, expMin, expMax };
  }

  function checkboxList(container, name, values){
    const arr = [...values].sort((a,b)=>a.localeCompare(b,'cs'));
    container.innerHTML = arr.map(v => `
      <label style="display:block; margin:.25rem 0;">
        <input type="checkbox" name="${name}" value="${v}"> ${v}
      </label>
    `).join("") || "<span class='small'>≈Ω√°dn√© polo≈æky</span>";
  }

  function populateFilters(){
    checkboxList(boxLocations, "loc",    new Set(CZECH_REGIONS));
    checkboxList(boxSpecs,     "spec",   facets.specs);
    checkboxList(boxLangs,     "lang",   facets.langs);
    checkboxList(boxGenders,   "gender", facets.genders);

    expMinInput.placeholder = String(facets.expMin);
    expMaxInput.placeholder = String(facets.expMax);
    expHint.textContent     = `Rozsah v datech: ${facets.expMin} ‚Äì ${facets.expMax} let`;
  }

  // --- Filters ---
  function getFiltersFromUI(){
    const checked = (sel) => [...document.querySelectorAll(sel+':checked')].map(i=>i.value);
    return {
      q:      searchInput.value.trim().toLowerCase(),
      loc:    checked('input[name="loc"]'),
      spec:   checked('input[name="spec"]'),
      lang:   checked('input[name="lang"]'),
      gender: checked('input[name="gender"]'),
      expMin: expMinInput.value ? Number(expMinInput.value) : null,
      expMax: expMaxInput.value ? Number(expMaxInput.value) : null,
      onlyFavs: !!onlyFavsCheckbox?.checked,
      sort: sortSelect?.value || "default",
    };
  }

  function applyFilters(users, f){
    const q = f.q;
    let out = users.filter(([id, u]) => {
      const locObj = u.location || {};
      const region = (locObj.region || "").trim();
      const locStr = locationText(locObj); // still used for text search & card meta

      if (q) {
        const hay = [
          u.name, u.prijmeni, u.bio,
          Array.isArray(u.specializations) ? u.specializations.join(" ") : u.specializations,
          locStr
        ].filter(Boolean).join(" ").toLowerCase();
        if (!hay.includes(q)) return false;
      }

      // region filter against fixed checkboxes
      if (f.loc.length && !f.loc.includes(region)) return false;


      if (f.spec.length) {
        const sArr = Array.isArray(u.specializations) ? u.specializations :
          (typeof u.specializations === 'string' ? u.specializations.split(',').map(s=>s.trim()) : []);
        if (!f.spec.every(s => sArr.includes(s))) return false;
      }

      if (f.lang.length) {
        const lArr = Array.isArray(u.languages) ? u.languages :
          (typeof u.languages === 'string' ? u.languages.split(',').map(s=>s.trim()) : []);
        if (!f.lang.some(l => lArr.includes(l))) return false;
      }

      if (f.gender.length && !f.gender.includes(u.gender)) return false;

      const e = Number(u.experience || 0);
      if (f.expMin != null && e < f.expMin) return false;
      if (f.expMax != null && e > f.expMax) return false;

      // NEW: Only my favorites
      if (f.onlyFavs && me) {
        if (!myFavSet.has(id)) return false;
      } else if (f.onlyFavs && !me) {
        // if user is not signed in and tries to filter onlyFavs, show none
        return false;
      }

      return true;
    });

    // NEW: sorting
    if (f.sort === "popular") {
      out.sort((a,b) => (favCounts[b[0]] || 0) - (favCounts[a[0]] || 0));
    }

    return out;
  }

  function renderChips(f){
    const chips = [];
    const add = (label, value, clearKey, clearVal) => {
      chips.push(`<span class="chip">${label}: ${value} <button data-k="${clearKey}" data-v="${encodeURIComponent(clearVal || '')}">√ó</button></span>`);
    };

    if (f.q) add("Hledat", f.q, "q");
    f.loc.forEach(v => add("Lokalita", v, "loc", v));
    f.spec.forEach(v => add("Specializace", v, "spec", v));
    f.lang.forEach(v => add("Jazyk", v, "lang", v));
    f.gender.forEach(v => add("Pohlav√≠", v, "gender", v));
    if (f.expMin != null) add("Zku≈°enost ‚â•", f.expMin, "expMin");
    if (f.expMax != null) add("Zku≈°enost ‚â§", f.expMax, "expMax");
    if (f.onlyFavs) add("Filtr", "Moji obl√≠ben√≠", "onlyFavs");

    chipsWrap.innerHTML = chips.join("") || "";
    chipsWrap.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        const k = btn.dataset.k;
        const v = decodeURIComponent(btn.dataset.v||"");
        switch (k) {
          case "q": searchInput.value = ""; break;
          case "expMin": expMinInput.value = ""; break;
          case "expMax": expMaxInput.value = ""; break;
          case "onlyFavs": if (onlyFavsCheckbox) onlyFavsCheckbox.checked = false; break;
          default: {
            const selector = `input[name="${k}"][value="${CSS.escape(v)}"]`;
            const el = document.querySelector(selector);
            if (el) el.checked = false;
          }
        }
        doFilter();
      });
    });
  }

  function safeProfileUrl(id) {
    if (!/^[A-Za-z0-9_-]+$/.test(id)) return null;
    return `profile.html?id=${encodeURIComponent(id)}`;
  }

  // --- Rendering cards (now with the heart) ---
  function renderUsers(users) {
    userList.innerHTML = "";
    if (!users.length) {
      userList.innerHTML = "<p>≈Ω√°dn√≠ u≈æivatel√© nebyli nalezeni.</p>";
      return;
    }

    users.forEach(([id, user], idx) => {
      const href = safeProfileUrl(id);
      if (!href) return;

      const photoURL =
        (typeof user.profilePicture === "string" && user.profilePicture.startsWith("http"))
          ? user.profilePicture
          : clThumb(id);

      const name = (user.name || "").trim() || "Nezn√°m√Ω";
      const lastName = (user.prijmeni || "").trim();

      const specs = Array.isArray(user.specializations)
        ? user.specializations
        : (typeof user.specializations === "string"
            ? user.specializations.split(",").map(s => s.trim()).filter(Boolean)
            : []);

      const show = specs.slice(0, 3);
      const moreCount = Math.max(0, specs.length - show.length);

      const accentOf = (arr) => {
        const s = (arr[0] || "").toLowerCase();
        if (s.includes("silov")) return "strength";
        if (s.includes("j√≥ga")) return "yoga";
        if (s.includes("rehab")) return "rehab";
        if (s.includes("v√Ω≈æiv") || s.includes("nutri")) return "nutrition";
        return "fit";
      };
      const accent = accentOf(show);

      const count  = favCounts[id] || 0;
      const isMine = me && me.uid === id;
      const favOn  = myFavSet.has(id);

      // stagger: 0,80,160,240,‚Ä¶ (wrap every 8 for long lists)
      const delay = (idx % 8) * 80;

      const card = document.createElement("a");
      card.className = "trainer-card";
      card.href = href;
      card.setAttribute("data-accent", accent);

      // AOS attributes
      card.setAttribute("data-aos", "fade-up");
      card.setAttribute("data-aos-delay", String(delay));
      card.setAttribute("data-aos-anchor-placement", "top-bottom");

      // ===== BADGES (merge old boolean/array with new object style) =====
      // start from your existing array logic
      const badges = [];

      // old boolean (keep)
      if (user.verified === true) {
        badges.push({ key: "verified", label: "Ovƒõ≈ôen√Ω", icon: "‚úî" });
      }

      // old array (keep)
      if (Array.isArray(user.badges)) {
        user.badges.forEach(b => {
          const k = String(b).toLowerCase();
          if (k === "pro")          badges.push({ key:"pro",          label:"Pro",           icon:"‚òÖ"  });
          if (k === "recommended")  badges.push({ key:"recommended",  label:"Doporuƒçujeme",  icon:"‚òÖ"  });
          if (k === "top")          badges.push({ key:"top",          label:"Top",           icon:"üèÜ" });
          if (k === "new")          badges.push({ key:"new",          label:"Nov√Ω",          icon:"üÜï" });
        });
      }

      // NEW: object map { key: true } like { "top-rated": true, "verified": true }
      if (user.badges && typeof user.badges === "object" && !Array.isArray(user.badges)) {
        for (const [k, v] of Object.entries(user.badges)) {
          if (!v) continue;
          // prefer catalog meta if we know the key; otherwise use the key as label
          const meta = BADGE_META[k];
          badges.push({
            key: k,
            label: meta?.label || k,
            icon: meta?.icon || "üè∑Ô∏è"
          });
        }
      }

      // render max 3 badges (you can change the number)
      const shownBadges = badges.slice(0, 3)
        .map(b => `<span class="badge badge--${b.key}" title="${b.label}"><i>${b.icon}</i>${b.label}</span>`)
        .join("");

      card.innerHTML = `
        <div class="card-header"></div>

        <button
          class="fav-btn ${favOn ? 'on' : ''}"
          data-trainer-id="${id}"
          ${isMine ? 'disabled' : ''}
          aria-pressed="${favOn ? 'true' : 'false'}"
          aria-label="${favOn ? 'Odebrat z obl√≠ben√Ωch' : 'P≈ôidat mezi obl√≠ben√©'}"
        >
          <span class="heart" aria-hidden="true">${favOn ? '‚ô•' : '‚ô°'}</span>
          <span class="count" data-fav-count>${count}</span>
        </button>

        <div class="avatar-wrap">
          <img class="avatar"
              src="${photoURL}"
              alt="Profilov√Ω obr√°zek"
              onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=Profil';">
        </div>

        <div class="card-body">
          <h3 class="name">
            ${name} ${lastName}
            ${(user.verified || user.badges?.verified) ? `<span class="v-tick" title="Ovƒõ≈ôen√Ω">‚úì</span>` : ``}
          </h3>

          <div class="meta">
            <span>üìç ${locationText(user.location) || "-"}</span>
            <span class="sep">‚Ä¢</span>
            <span>üß† ${user.experience ?? "-"} let praxe</span>
          </div>

          <!-- ${shownBadges ? `<div class="badges">${shownBadges}</div>` : ""} --> 

          <div class="tags">
            ${show.map(t => `<span class="tag">${t}</span>`).join("")}
            ${moreCount ? `<span class="tag tag-more">+${moreCount}</span>` : ""}
          </div>
        </div>
      `;

      userList.appendChild(card);
    });

    // Tell AOS new nodes were added
    if (window.AOS && !window.__aosBooted) { window.__aosBooted = true; AOS.refresh(); }
  }
  // --- Favorite toggling ---
  async function toggleFavorite(trainerId, btn){
    const user = auth.currentUser;
    if (!user) { toast("Pro ukl√°d√°n√≠ obl√≠ben√Ωch se p≈ôihlaste."); window.location.href = "register.html"; return; }
    if (trainerId === user.uid) return;
    if (favBusy.has(trainerId)) return;
    favBusy.add(trainerId);
    if (btn) btn.disabled = true;

    const favRef   = ref(db, `favoritesByUser/${user.uid}/${trainerId}`);
    const countRef = ref(db, `favoriteCounts/${trainerId}`);

    try {
      const snap = await get(favRef);
      const already = snap.exists();

      // grab current UI parts
      const countEl = btn?.querySelector(".count");
      const heartEl = btn?.querySelector(".heart");
      const cur = parseInt(countEl?.textContent || "0", 10) || 0;

// figure out the current number shown (fallback to cached counts)
const prevCount =
  countEl && !Number.isNaN(parseInt(countEl.textContent, 10))
    ? parseInt(countEl.textContent, 10)
    : (favCounts[trainerId] || 0);

    if (already) {
      await remove(favRef);
      await runTransaction(countRef, cur => Math.max(0, (cur || 0) - 1));

      // local state + UI
      myFavSet.delete(trainerId);
      const next = Math.max(0, prevCount - 1);
      if (countEl) countEl.textContent = String(next);
      favCounts[trainerId] = next;

      if (heartEl) heartEl.textContent = "‚ô°";
      if (btn) {
        btn.classList.remove("on");
        btn.setAttribute("aria-pressed","false");
      }
      toast("Odebr√°no z obl√≠ben√Ωch");
    } else {
      await set(favRef, { addedAt: Date.now() });
      await runTransaction(countRef, cur => (cur || 0) + 1);

      // local state + UI
      myFavSet.add(trainerId);
      const next = prevCount + 1;
      if (countEl) countEl.textContent = String(next);
      favCounts[trainerId] = next;

      if (heartEl) heartEl.textContent = "‚ô•";
      if (btn) {
        btn.classList.add("on");
        btn.setAttribute("aria-pressed","true");
      }
      toast("P≈ôid√°no do obl√≠ben√Ωch ‚úì");
    }

    } catch (e) {
      console.error(e);
      alert("Nepoda≈ôilo se zmƒõnit obl√≠ben√©: " + (e?.message || e));
    } finally {
      favBusy.delete(trainerId);
      if (btn) btn.disabled = false;
    }
  }

  // --- Delegated click for hearts (stop link nav) ---
  userList.addEventListener("click", (e) => {
    const btn = e.target.closest(".fav-btn");
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();
    const id = btn.dataset.trainerId;
    if (!id) return;
    toggleFavorite(id, btn); // pass btn
  });

  // --- Filter reactiveness ---
  const doFilter = (() => {
    let t;
    return function trigger(){
      clearTimeout(t);
      t = setTimeout(() => {
        const f = getFiltersFromUI();
        renderChips(f);
        renderUsers(applyFilters(allUsers, f));
      }, 120);
    };
  })();

  btnApply.addEventListener("click", () => {
    doFilter();
    filtersPanel.setAttribute("hidden", "");
  });
  btnClear.addEventListener("click", () => {
    searchInput.value = "";
    expMinInput.value = "";
    expMaxInput.value = "";
    document.querySelectorAll('#filtersPanel input[type="checkbox"]').forEach(cb => (cb.checked = false));
    if (sortSelect) sortSelect.value = "default";
    doFilter();
  });
  searchInput.addEventListener("input", doFilter);
  filtersPanel.addEventListener("change", (e) => {
    if (e.target.matches('input[type="checkbox"], input[type="number"], select')) doFilter();
  });

  // --- Data subscriptions ---
  // trainers
  async function loadUsersOnce() {
    loader.style.display = "none";
    const snap = await get(ref(db, "users"));
    const data = snap.val() || {};
    allUsers = Object.entries(data).filter(([_, user]) => user && user.email);
    facets = buildFacets(allUsers);
    populateFilters();
    doFilter();
  }
  loadUsersOnce();

  onValue(ref(db, "favoriteCounts"), (snap) => {
    favCounts = snap.val() || {};
    const f = getFiltersFromUI();               // keep your existing helpers
    renderChips(f);
    renderUsers(applyFilters(allUsers, f));
  });

  // auth + my favorites
  onAuthStateChanged(auth, (user) => {
    me = user && user.emailVerified ? user : null;

    if (me) {
      onValue(ref(db, `favoritesByUser/${me.uid}`), (snap) => {
        const m = snap.val() || {};
        myFavSet = new Set(Object.keys(m));
        doFilter();
      });
    } else {
      myFavSet = new Set();
      doFilter();
    }
  });
</script>
<script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
<script>
  AOS.init({
    duration: 650,            // animation length
    easing: 'ease-out-quart', // feels snappy
    once: true,               // animate only the first time
    offset: 80                // start a bit before the card hits viewport
  });
</script>
  <!-- small script to wire hero buttons & animations (paste near end of body) -->
  <script>
    (function(){
      // Scroll to search (secondary CTA)
      const sBtn = document.getElementById('cz-hero-search-btn');
      sBtn?.addEventListener('click', () => {
        const target = document.getElementById('search-section') || document.getElementById('search-form') || document.querySelector('form#search-form');
        if (target) {
          target.scrollIntoView({behavior: 'smooth', block: 'start'});
          // focus first input if possible
          const input = target.querySelector('input, select, textarea');
          if (input) input.focus();
        } else {
          // fallback to scroll a bit
          window.scrollBy({top: 500, left:0, behavior:'smooth'});
        }
      });

      // Stop the button pulse after ~2500ms so it's not annoying
      const mapBtn = document.getElementById('cz-hero-map-btn');
      if (mapBtn) {
        setTimeout(() => {
          mapBtn.classList.remove('animate__pulse');
        }, 2500);
      }

      // init AOS if available
      if (window.AOS) {
        AOS.init({ once: true, duration: 700, easing: 'ease-out-cubic' });
      }
      // if animate.css not loaded explicitly, classes degrade gracefully
    })();
  </script>
</body>
</html>