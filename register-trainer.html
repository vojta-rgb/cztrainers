<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registrace trenéra – CZTRAINERS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="register-trainer.css" />
  <link rel="stylesheet" href="navbar.css">
  <link rel="stylesheet" href="showPassword.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body>
  <script type="module" src="showPassword.js"></script>
<!-- Navbar (isolated) -->
  <nav class="cznav" aria-label="Hlavní navigace">
    <div class="cznav__logo">
      <a href="index.html">
        <img src="assets/CZTrainersNew.png" alt="CZTRAINERS Logo" />
      </a>
    </div>

    <!-- Right cluster: profile pill + theme + burger -->
    <div class="cznav__right">
      <a id="profilePill" class="cznav__pill" href="register.html" aria-label="Přihlásit / registrace">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M6 20a6 6 0 0112 0"></path>
        </svg>
        <span id="pillText">Login</span>
      </a>

      <button id="themeToggle" class="cznav__theme" type="button" aria-label="Přepnout motiv">
        <span id="themeIcon">☀️</span>
      </button>

      <button id="hamburger" class="cznav__hamburger" type="button" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <!-- Dropdown -->
    <div id="navLinks" class="cznav__menu" role="menu" aria-label="Navigace">
      <a href="index.html" class="cznav__link">Domů</a>
      <a href="mapa-treneru.html" class="cznav__link">Mapa Trenérů</a>
      <a href="o-nas.html" class="cznav__link">O nás</a>
      <a href="login.html" class="cznav__link" id="loginBtn">Přihlášení</a>
      <a href="#" class="cznav__link" id="logoutBtn" style="display:none">Odhlásit se</a>
    </div>
  </nav>

  <!-- FORM CARD -->
  <main class="page-wrapper">
    <div class="form-container animate__animated animate__fadeIn">
      <h1 class="title">Registrace trenéra</h1>

      <form id="registerForm" class="form">
        <!-- Obrázek -->
        <div class="field">
          <label for="profileImage">Přidejte profilový obrázek</label>
          <img id="profilePreview" src="" alt="Profilový obrázek" style="display:none" />
          <input type="file" id="profileImage" accept="image/*" />
          <p class="hint">Max 10&nbsp;MB · Obrázek automaticky zkomprimujeme (≈500&nbsp;KB). Nevhodné obrázky se zamítnou.</p>
        </div>

        <!-- === Gallery (multiple images) === -->
        <fieldset class="field-group">
          <legend>Galerie</legend>
          <p class="hint">Vyberte více fotek (JPG/PNG/WebP/AVIF). Max 10&nbsp;MB za soubor – zkomprimujeme cca na 500&nbsp;KB.</p>

          <input id="galleryInput" type="file" accept="image/*" multiple />
          <div id="galleryPreview" class="gallery-preview" aria-live="polite"></div>
          <p class="hint" id="galleryCount">0 fotek vybráno</p>
        </fieldset>

        <!-- Osobní údaje -->
        <h3 class="section">Osobní údaje</h3>
        <div class="grid-2">
          <div class="field">
            <label for="name">Jméno</label>
            <input type="text" id="name" placeholder="Jméno" required />
          </div>
          <div class="field">
            <label for="prijmeni">Příjmení</label>
            <input type="text" id="prijmeni" placeholder="Příjmení" required />
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="email">E-mail</label>
            <input type="email" id="email" placeholder="např. jan.novak@email.cz" required />
          </div>
          <div class="field">
            <label for="password">Heslo</label>
            <input type="password" id="password" placeholder="Min. 6 znaků" required minlength="6" data-showpw placeholder="••••••••"/>
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="phone">Telefon</label>
            <input type="tel" id="phone" placeholder="+420 123 456 789" required pattern="\+?[0-9\s]{9,15}" />
          </div>
          <div class="field">
            <label for="datum">Datum narození</label>
            <input type="date" id="datum" required />
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="gender">Pohlaví</label>
            <select id="gender" required>
              <option value="">Vyber pohlaví</option>
              <option value="muz">Muž</option>
              <option value="zena">Žena</option>
              <option value="jine">Jiné</option>
            </select>
          </div>
          <div class="field">
            <label for="location">Kraj</label>
            <select id="location" required>
              <option value="">Vyber kraj</option>
              <option value="Hlavní město Praha">Hlavní město Praha</option>
              <option value="Středočeský kraj">Středočeský kraj</option>
              <option value="Jihočeský kraj">Jihočeský kraj</option>
              <option value="Plzeňský kraj">Plzeňský kraj</option>
              <option value="Karlovarský kraj">Karlovarský kraj</option>
              <option value="Ústecký kraj">Ústecký kraj</option>
              <option value="Liberecký kraj">Liberecký kraj</option>
              <option value="Královéhradecký kraj">Královéhradecký kraj</option>
              <option value="Pardubický kraj">Pardubický kraj</option>
              <option value="Vysočina">Vysočina</option>
              <option value="Jihomoravský kraj">Jihomoravský kraj</option>
              <option value="Olomoucký kraj">Olomoucký kraj</option>
              <option value="Zlínský kraj">Zlínský kraj</option>
              <option value="Moravskoslezský kraj">Moravskoslezský kraj</option>
            </select>
          </div>
        </div>

        <!-- O mně -->
        <div class="field">
          <label for="bio">O mně</label>
          <textarea id="bio" placeholder="Krátký popis (specializace, zkušenosti…)" required></textarea>
        </div>

        <!-- Specializace -->
        <h3 class="section">Specializace</h3>
        <div id="specializationOptions" class="checkbox-group">
          <label><input type="checkbox" name="specializations" value="Fitness" /> Fitness</label>
          <label><input type="checkbox" name="specializations" value="Kondiční trénink" /> Kondiční trénink</label>
          <label><input type="checkbox" name="specializations" value="Silový trénink" /> Silový trénink</label>
          <label><input type="checkbox" name="specializations" value="Hubnutí" /> Hubnutí</label>
          <label><input type="checkbox" name="specializations" value="Výživa" /> Výživa / Nutriční poradenství</label>
          <label><input type="checkbox" name="specializations" value="Rehabilitace" /> Rehabilitace</label>
          <label><input type="checkbox" name="specializations" value="Běhání" /> Běhání</label>
          <label><input type="checkbox" name="specializations" value="Jóga" /> Jóga</label>
          <label><input type="checkbox" name="specializations" value="Pilates" /> Pilates</label>
          <label><input type="checkbox" name="specializations" value="Skupinové lekce" /> Skupinové lekce</label>
        </div>

        <!-- Ceník + Zkušenosti -->
        <div class="grid-2">
          <div class="field">
            <label for="pricing">Ceník</label>
            <textarea id="pricing" placeholder="Např. 700 Kč/hod · Balíčky…" required></textarea>
          </div>
          <div class="field">
            <label for="experience">Zkušenosti (roky)</label>
            <input type="number" id="experience" min="0" max="50" placeholder="Roky zkušeností" required />
          </div>
        </div>

        <!-- Jazyky -->
        <h3 class="section">Jazyky</h3>
        <div id="languageOptions" class="checkbox-group">
          <label><input type="checkbox" name="languages" value="CZ" /> Čeština (CZ)</label>
          <label><input type="checkbox" name="languages" value="EN" /> Angličtina (EN)</label>
          <label><input type="checkbox" name="languages" value="DE" /> Němčina (DE)</label>
          <label><input type="checkbox" name="languages" value="SK" /> Slovenština (SK)</label>
          <label><input type="checkbox" name="languages" value="RU" /> Ruština (RU)</label>
          <label><input type="checkbox" name="languages" value="FR" /> Francouzština (FR)</label>
        </div>

        <!-- Socials -->
        <h3 class="section">Sociální sítě (volitelné)</h3>
        <div class="grid-3">
          <div class="field">
            <label for="instagram">Instagram</label>
            <input type="text" id="instagram" placeholder="uživatelské jméno nebo odkaz" />
          </div>
          <div class="field">
            <label for="facebook">Facebook</label>
            <input type="text" id="facebook" placeholder="uživatelské jméno nebo odkaz" />
          </div>
          <div class="field">
            <label for="tiktok">TikTok</label>
            <input type="text" id="tiktok" placeholder="uživatelské jméno nebo odkaz" />
          </div>
        </div>

        <!-- ======= Mapa & poloha trenéra ======= -->
        <h3 class="section">Zvol, kde trénuješ (adresu najdeš nebo přetáhneš pin)</h3>

        <div class="rt-mapbox">
          <label class="map-field">
            <span>Najdi adresu / město</span>
            <input id="mapSearch" type="text" placeholder="Zadejte adresu nebo město" />
          </label>

          <div id="trainerMap" class="map-picker" aria-label="Výběr polohy trenéra"></div>

          <div class="map-toggles">
            <label class="rt-check">
              <input type="checkbox" id="showOnMap" checked>
              <span>Zobrazit na mapě</span>
            </label>

            <div class="map-precision">
              <label class="rt-check">
                <input type="radio" name="locPrecision" value="exact" checked>
                <span>Přesná poloha</span>
              </label>
              <label class="rt-check">
                <input type="radio" name="locPrecision" value="approx">
                <span>Přibližná poloha</span>
              </label>
            </div>
          </div>

          <div class="map-meta">
            <label class="field-small">
              <span>Město (auto)</span>
              <input id="cityDisplay" type="text" readonly placeholder="—" />
            </label>
            <label class="field-small">
              <span>Kraj (auto vyplní výběr výše)</span>
              <input id="regionDisplay" type="text" readonly placeholder="—" />
            </label>
          </div>

          <!-- Hidden fields JS fills before save -->
          <input type="hidden" id="loc_lat" />
          <input type="hidden" id="loc_lng" />
          <input type="hidden" id="loc_lat_public" />
          <input type="hidden" id="loc_lng_public" />
          <input type="hidden" id="loc_city" />
          <input type="hidden" id="loc_region" />
          <input type="hidden" id="loc_geohash" />
          <input type="hidden" id="loc_precision" value="exact" />
          <input type="hidden" id="loc_visible" value="true" />
        </div>

        <!-- Age confirmation -->
        <label class="rt-check">
          <input type="checkbox" id="age16" required>
          <span>Je mi alespoň 16 let.</span>
        </label>
        <label class="rt-check" style="display:flex;gap:.5rem;align-items:flex-start;margin:.5rem 0 1rem;">
          <input type="checkbox" id="consentTos" required>
          <span>Souhlasím se <a href="podminky.html" target="_blank" rel="noopener">Smluvními podmínkami</a> a se 
            <a href="ochrana-osobnich-udaju.html" target="_blank" rel="noopener">Zásadami ochrany osobních údajů</a>.
          </span>
        </label>

        <!-- Actions -->
        <div class="actions">
        <button id="submitBtn" type="submit" class="ur-btn ur-btn-primary">Vytvořit účet</button>
        <a class="ur-btn ur-btn-ghost" href="register.html">Zpět na výběr registrace</a>
        </div>
      </form>
      <!-- SUCCESS CARD (hidden by default) -->
      <div id="successCard" class="rt-success-card" style="display:none">
        <h3>✅ Účet vytvořen – ověřte e-mail</h3>
        <p>Poslali jsme vám ověřovací e-mail. Otevřete schránku a klikněte na odkaz pro aktivaci účtu.</p>
        <p style="opacity:.9">Nevidíte zprávu? Zkontrolujte Spam/Promo a počkejte pár minut.</p>
        <div class="rt-success-actions">
          <a class="rt-btn rt-btn-primary" href="login.html">Přejít na přihlášení</a>
          <a class="rt-btn" href="index.html">Zpět na hlavní stránku</a>
        </div>
      </div>
    </div>
  </main>

  <footer class="ur-foot animate__animated animate__swing animate__delay-3s">
    <p>Máte účet? <a href="login.html">Přihlásit se</a></p>
  </footer>

  <!-- TFJS must load before nsfwjs -->
  <script src="https://unpkg.com/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>

  <!-- Your local UMD build that exposes window.nsfwjs -->
  <script src="vendor/nsfwjs.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, createUserWithEmailAndPassword, sendEmailVerification, signOut, deleteUser
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
      authDomain: "cztrainers-dat1.firebaseapp.com",
      databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cztrainers-dat1",
      storageBucket: "cztrainers-dat1.appspot.com",
      messagingSenderId: "369200533487",
      appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };

    const CLOUD_NAME = "dkt3pdcbe";
    const SIGNER_URL = "/api/sign"; // call your Cloudflare Pages Function on the same origin
    const MAX_INPUT_SIZE = 10 * 1024 * 1024;   // 10 MB client guard
    const TARGET_MAX_BYTES = 500 * 1024;       // final target ~500KB
    const MAX_DIM = 1600;                      // longest edge for upload
    const MAX_GALLERY_FILES = 10;         // hard cap to avoid abuse
    const GALLERY_TARGET_BYTES = TARGET_MAX_BYTES; // ≈500 KB each
    const GALLERY_MAX_DIM = MAX_DIM;      // 1600px longest edge


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const profileImageInput = document.getElementById("profileImage");
    const galleryInput   = document.getElementById("galleryInput");
    const galleryPreview = document.getElementById("galleryPreview");
    const galleryCountEl = document.getElementById("galleryCount");
    let galleryFilesSelected = []; // File[] (originals) – we compress later on submit
    
      // File size guard
    profileImageInput.addEventListener("change", () => {
      const file = profileImageInput.files[0];
      if (file && file.size > MAX_INPUT_SIZE) {
        alert("Soubor je příliš velký. Maximální velikost je 10 MB.");
        profileImageInput.value = "";
      }
    });
    // --- preview of selected profile photo ---
    const preview = document.getElementById("profilePreview");

    profileImageInput.addEventListener("change", () => {
      const file = profileImageInput.files[0];

      // clear preview if nothing selected
      if (!file) {
        preview.removeAttribute("src");
        preview.style.display = "none";
        return;
      }

      // guard: only images + size limit
      if (!file.type.startsWith("image/")) {
        alert("Vybraný soubor není obrázek.");
        profileImageInput.value = "";
        preview.style.display = "none";
        return;
      }
      if (file.size > MAX_INPUT_SIZE) {
        alert("Soubor je příliš velký. Maximální velikost je 10 MB.");
        profileImageInput.value = "";
        preview.style.display = "none";
        return;
      }

      // show preview (use a blob URL; revoke old one if any)
      if (preview.dataset.blobUrl) URL.revokeObjectURL(preview.dataset.blobUrl);
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.dataset.blobUrl = url;
      preview.style.display = "block";
    });

    galleryInput?.addEventListener("change", () => {
      const files = Array.from(galleryInput.files || []);
      // Filter to images & ≤10MB
      const ok = files.filter(f => /^image\//.test(f.type) && f.size <= MAX_INPUT_SIZE);
      if (ok.length !== files.length) {
        alert("Některé soubory byly přeskočeny (nejsou obrázek nebo jsou větší než 10 MB).");
      }
      // Cap total count
      if (ok.length > MAX_GALLERY_FILES) {
        alert(`Maximálně ${MAX_GALLERY_FILES} fotek v galerii najednou.`);
        ok.length = MAX_GALLERY_FILES;
      }
      galleryFilesSelected = ok;

      // Previews
      galleryPreview.innerHTML = "";
      ok.forEach((f, i) => {
        const url = URL.createObjectURL(f);
        const wrap = document.createElement("div");
        wrap.className = "g-thumb";
        wrap.innerHTML = `<img src="${url}" alt="Náhled ${i+1}"><span class="g-meta">${Math.round(f.size/1024)} kB</span>`;
        galleryPreview.appendChild(wrap);
      });
      galleryCountEl.textContent = `${ok.length} ${ok.length===1?'fotka':'fotky'}`;
    });

    // Helpers: downscale, NSFW, signature, signed upload
    async function downscaleImage(file, maxDim = MAX_DIM, mime = "image/jpeg", quality = 0.9) {
      const img = await new Promise((res, rej) => {
        const i = new Image();
        i.onload = () => res(i);
        i.onerror = rej;
        i.src = URL.createObjectURL(file);
      });
      const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
      const w = Math.round(img.width * scale);
      const h = Math.round(img.height * scale);
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      canvas.getContext("2d").drawImage(img, 0, 0, w, h);
      return new Promise((res) => canvas.toBlob(res, mime, quality));
    }

    async function compressToTarget(file, { maxDim = MAX_DIM, target = TARGET_MAX_BYTES } = {}) {
      // Start with good quality and reduce until under target or minimum
      let quality = 0.9;
      let blob = await downscaleImage(file, maxDim, "image/jpeg", quality);
      // If still too big, iteratively lower quality; if still big, reduce dimension and retry
      let dim = maxDim;
      for (let step = 0; (blob && blob.size > target) && step < 8; step++) {
        if (quality > 0.5) {
          quality -= 0.08;
        } else {
          dim = Math.round(dim * 0.85); // shrink 15%
        }
        blob = await downscaleImage(file, dim, "image/jpeg", Math.max(quality, 0.35));
      }
      return new File([blob], "pfp.jpg", { type: "image/jpeg" });
    }

    // ---------- NSFWJS (local if possible, otherwise CDN) ----------
    let nsfwModelPromise = null;

    // Try local model first; if missing (404), fall back to CDN
    async function getNSFWModel() {
    if (nsfwModelPromise) return nsfwModelPromise;

    const LOCAL_DIR = "./vendor/nsfw-model/";                 // directory that contains model.json + shard files
    const LOCAL_PROBE = LOCAL_DIR + "model.json";
    const CDN_DIR   = "https://unpkg.com/nsfwjs@2/dist/model/";

    // Probe the local model.json (HEAD = cheap and fast)
    let modelDir = CDN_DIR;
      try {
        const res = await fetch(LOCAL_PROBE, { method: "HEAD", cache: "no-store" });
        if (res.ok) modelDir = LOCAL_DIR;
      } catch (_) { /* ignore; use CDN */ }

      // window.nsfwjs is provided by vendor/nsfwjs.min.js
      const NS = window.nsfwjs;
      if (!NS) throw new Error("NSFWJS UMD not loaded (vendor/nsfwjs.min.js)");

      nsfwModelPromise = NS.load(modelDir);
      return nsfwModelPromise;
    }

    // (optional) warm-up so first use is instant
    getNSFWModel().catch(err => console.error("[nsfw] preload failed:", err));

    async function isImageSafe(file) {
      const model = await getNSFWModel();
      const dataURL = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result); r.readAsDataURL(file); });
      const img = new Image();
      await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = dataURL; });
      const preds = await model.classify(img);
      const score = { Sexy: 0, Porn: 0, Hentai: 0 };
      preds.forEach(p => { if (score[p.className] != null) score[p.className] = p.probability; });
      if (score.Porn + score.Hentai >= 0.2) return false;
      if (score.Sexy >= 0.5) return false;
      return true;
    }
    async function getSignature(params){
      try {
        const r = await fetch(SIGNER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(params)
        });
        if (!r.ok) {
          const txt = await r.text().catch(()=>"(no body)");
          throw new Error(`Signature service HTTP ${r.status}: ${txt}`);
        }
        return r.json();
      } catch (e) {
        console.error("Signer error:", e);
        throw new Error("Nepodařilo se kontaktovat podpisovou službu (Worker). Zkontrolujte CORS a nasazení.");
      }
    }

    async function uploadPfpSigned({ file, uid }){
      const public_id = `users/${uid}/pfp`;
      const timestamp = Math.floor(Date.now()/1000);
      const { signature, apiKey } = await getSignature({ public_id, timestamp, overwrite:true, invalidate:true });

      const form = new FormData();
      form.append("file", file, "pfp.jpg");   // instead of form.append("file", file)
      form.append("api_key", apiKey);
      form.append("timestamp", String(timestamp));
      form.append("public_id", public_id);
      form.append("overwrite", "true");
      form.append("invalidate", "true");
      form.append("signature", signature);

      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
      let resp;
      try {
        resp = await fetch(url, { method:"POST", body: form });
      } catch (e) {
        console.error("Network error to Cloudinary:", e);
        throw new Error("Nelze se připojit ke Cloudinary (síť/CORS).");
      }
      if (!resp.ok) {
        const body = await resp.text().catch(()=>"(no body)");
        console.error("Cloudinary error:", resp.status, body);
        throw new Error(`Cloudinary chyba ${resp.status}: ${body}`);
      }
      return resp.json();
    }

    async function uploadGallerySigned({ file, uid }) {
      const timestamp = Math.floor(Date.now() / 1000);
      // Each photo gets its own public_id under users/<uid>/gallery/<ts>-<rand>
      const public_id = `users/${uid}/gallery/${Date.now()}-${Math.random().toString(36).slice(2,8)}`;

      // Ask your signer for a signature for these exact params (must match on both sides)
      const sigRes = await fetch(SIGNER_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          public_id,
          timestamp,
          overwrite: true,
          invalidate: true
          // If you chose to require a preset in signer, also send: upload_preset: "trainer_profile_signed"
        })
      }).then(r => r.json());

      const form = new FormData();
      form.append("file", file);
      form.append("api_key", sigRes.apiKey);
      form.append("timestamp", String(timestamp));
      form.append("public_id", public_id);
      form.append("overwrite", "true");
      form.append("invalidate", "true");
      // form.append("upload_preset","trainer_profile_signed"); // only if your preset is required
      form.append("signature", sigRes.signature);

      const res = await fetch(`https://api.cloudinary.com/v1_1/${sigRes.cloudName || CLOUD_NAME}/image/upload`, {
        method: "POST", body: form
      }).then(r => r.json());

      if (!res.secure_url) throw new Error("Cloudinary upload failed");
      return res; // contains { secure_url, public_id, bytes, width, height, ... }
    }

    // === UX helpers: toast, button spinner, success card ===
    const rtToastEl = document.getElementById("rt-toast");
    function toast(msg){
      if(!rtToastEl) return;
      rtToastEl.textContent = String(msg || "");
      rtToastEl.classList.add("show");
      setTimeout(()=> rtToastEl.classList.remove("show"), 2600);
    }

    // OPTIONAL: replace blocking window.alert with non-blocking toast (no other edits needed)
    // comment this line out if you still want native alerts:
    window.alert = (m)=> toast(m);

    const submitBtn = document.getElementById("submitBtn");
    function setLoading(isOn){
      if(!submitBtn) return;
      if(isOn){
        submitBtn.dataset.label = submitBtn.textContent;
        submitBtn.classList.add("rt-loading");
        submitBtn.innerHTML = '<span class="rt-spin" aria-hidden="true"></span>' + (submitBtn.dataset.label || "Odesílám…");
        submitBtn.disabled = true;
      }else{
        submitBtn.classList.remove("rt-loading");
        submitBtn.textContent = submitBtn.dataset.label || "Vytvořit účet";
        submitBtn.disabled = false;
      }
    }

    function showSuccessCard(){
      const form = document.getElementById("registerForm");
      const card = document.getElementById("successCard");
      if(form && card){
        form.style.display = "none";
        card.style.display = "block";
      }
    }

    function collectMapLocation() {
      const visible   = document.getElementById("showOnMap")?.checked ?? true;
      const precision = document.querySelector('input[name="locPrecision"]:checked')?.value || "exact";

      const latExact = parseFloat(document.getElementById("loc_lat")?.value ?? "");
      const lngExact = parseFloat(document.getElementById("loc_lng")?.value ?? "");
      const latPub   = parseFloat(document.getElementById("loc_lat_public")?.value ?? "");
      const lngPub   = parseFloat(document.getElementById("loc_lng_public")?.value ?? "");
      const city = document.getElementById("loc_city")?.value || "";
      const regionAuto = document.getElementById("loc_region")?.value || "";
      const geohash = document.getElementById("loc_geohash")?.value || "";

      return {
        visibleOnMap: visible,
        precision,
        lat:  visible && Number.isFinite(latExact) ? latExact : null,
        lng:  visible && Number.isFinite(lngExact) ? lngExact : null,
        publicLat: visible && Number.isFinite(latPub) ? latPub : null,
        publicLng: visible && Number.isFinite(lngPub) ? lngPub : null,
        city,
        region: regionAuto || (document.getElementById("location")?.value || ""),
        geohash: visible ? geohash : "",
        updatedAt: Date.now()
      };
    }

    const form = document.getElementById("registerForm");

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Native HTML5 validation first (prevents creating an account on invalid form)
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // Disable button while we work
      submitBtn?.setAttribute("disabled", "true");
      setLoading(true);
      let createdUser = null; // for rollback if later steps fail

      try {
        // 1) Read values
        const email    = document.getElementById("email").value.trim();
        const pass     = document.getElementById("password").value;
        const jmeno    = document.getElementById("name").value.trim();
        const prijmeni = document.getElementById("prijmeni").value.trim();
        const region   = document.getElementById("location").value.trim();
        const bio      = document.getElementById("bio").value.trim();

        // 2) Pre-check and prepare PROFILE image locally (no network yet)
        let profilePictureUrl = "";
        let pfpToUpload = null;
        const rawPfp = (profileImageInput?.files || [])[0] || null;
        if (rawPfp) {
          if (!/^image\//.test(rawPfp.type)) throw new Error("Profilová fotka musí být obrázek.");
          if (rawPfp.size > MAX_INPUT_SIZE) throw new Error("Profilová fotka je větší než 10 MB.");
          const jpg = await compressToTarget(rawPfp, { maxDim: MAX_DIM, target: TARGET_MAX_BYTES });
          const safe = await isImageSafe(jpg);
          if (!safe) throw new Error("Profilová fotka byla zamítnuta (NSFW).");
          pfpToUpload = jpg;
        }

        // 3) Enforce gallery cap at submit time + prepare images locally
        const picked = galleryFilesSelected?.length
          ? galleryFilesSelected
          : Array.from(galleryInput?.files || []);
        const limited = picked.slice(0, MAX_GALLERY_FILES);
        if (picked.length > limited.length) {
          alert(`Nahrávám pouze prvních ${MAX_GALLERY_FILES} fotek z galerie.`);
        }

        const galleryPrepared = [];
        for (const raw of limited) {
          if (!/^image\//.test(raw.type)) continue;
          if (raw.size > MAX_INPUT_SIZE) continue;
          const jpg = await compressToTarget(raw, { maxDim: GALLERY_MAX_DIM, target: GALLERY_TARGET_BYTES });
          const ok  = await isImageSafe(jpg);
          if (!ok) { console.warn("Galerie: NSFW odmítnuto"); continue; }
          galleryPrepared.push(jpg);
        }

        // 4) Only now create the auth user (form + images are valid)
        const { user } = await createUserWithEmailAndPassword(auth, email, pass);
        createdUser = user;

        // 5) Upload images (needs uid)
        if (pfpToUpload) {
          const up = await uploadPfpSigned({ file: pfpToUpload, uid: user.uid });
          profilePictureUrl = up.secure_url;
        }

        const galleryResults = [];
        for (const jpg of galleryPrepared) {
          try {
            const up = await uploadGallerySigned({ file: jpg, uid: user.uid });
            galleryResults.push({ publicId: up.public_id, url: up.secure_url });
          } catch (err) {
            console.error("Galerie upload error:", err);
          }
        }

        // 6) Save trainer record (Realtime Database in your file)
        // Build a full location object from the current UI (keeps lat/lng, public coords, city, region, etc.)
        const fullLocation = (typeof collectMapLocation === "function") ? collectMapLocation() : { region };

        // Build the trainer document
        const trainerDoc = {
          uid: user.uid,
          email,
          name: jmeno,
          prijmeni,
          location: fullLocation,         // <- full object now
          bio,
          profilePictureUrl,
          gallery: galleryResults,
          galleryCount: galleryResults.length,
          createdAt: serverTimestamp ? serverTimestamp() : Date.now(),
          updatedAt: serverTimestamp ? serverTimestamp() : Date.now(),
          verified: false
        };

        // DEBUG: log before writing so you can inspect in the console
        console.debug("[register] writing trainers/%s ->", user.uid, trainerDoc);

        // Use update() to merge keys without replacing parent node
        try {
          await update(ref(db, `trainers/${user.uid}`), trainerDoc);
          console.debug("[register] trainers/%s updated ok", user.uid);
        } catch (dbErr) {
          console.error("[register] failed writing trainers/%s:", user.uid, dbErr);
          throw dbErr; // let outer catch perform rollback
        }

        // 7) Send verification email AFTER successful DB write
        await sendEmailVerification(user);

        // 8) Success UI
        form.reset();
        galleryPreview.innerHTML = "";
        galleryCountEl.textContent = "0 fotek vybráno";
        showSuccessCard(); // ← show your own success card
      } catch (err) {
        console.error(err);
        // Rollback: if user was created but something failed after, delete the account to avoid “email already in use”
        try {
          if (createdUser && auth.currentUser?.uid === createdUser.uid) {
            await deleteUser(auth.currentUser);
          }
        } catch (delErr) {
          console.warn("Rollback (delete user) failed:", delErr);
        }
        alert(String(err?.message || err));
      } finally {
        submitBtn?.removeAttribute("disabled");
        setLoading(false);
      }
    });
  </script>
  
  <script type="module" src="auth-navbar.js"></script>
  <script type="module" src="register-trainer-map.js"></script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCCkboX_dqsdoPwyVYuNoxeBieZZnUILzU&libraries=places&language=cs&region=CZ&callback=initTrainerPickMap&loading=async"></script>

  <div id="rt-toast" class="rt-toast" role="status" aria-live="polite"></div>
</body>
</html>
