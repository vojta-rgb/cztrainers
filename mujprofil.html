<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Můj profil – CZTRAINERS</title>
  <link rel="stylesheet" href="mujprofil.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-logo">
      <a href="index_main.html"><img src="CZtrainers new better.png" alt="CZTRAINERS Logo" /></a>
    </div>
    <button class="hamburger" id="hamburger" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-links" id="navLinks">
      <a href="index_main.html" class="nav-button">Domů</a>
      <div id="authButtons">
        <a href="index.html" class="nav-button" id="registerBtn">Registrace</a>
        <a href="login.html" class="nav-button" id="loginBtn">Přihlášení</a>
      </div>
      <a href="mujprofil.html" class="nav-button" id="profileBtn" style="display: none;">Můj profil</a>
      <a href="#" class="nav-button" id="logoutBtn" style="display: none;">Odhlásit se</a>
      <a href="o-nas.html" class="nav-button">O nás</a>
      <button class="theme-toggle" id="themeToggle"><span id="themeIcon">☀️</span></button>
    </div>
  </nav>

  <div class="container">
    <h2>Můj profil</h2>
    <form id="profileForm">
      <input type="text" id="name" placeholder="Jméno" />
      <input type="text" id="prijmeni" placeholder="Příjmení" />
      <input type="date" id="datum" />
      <input type="tel" id="phone" placeholder="Telefonní číslo" pattern="^\+?[0-9]{7,15}$" required />
      <select id="gender" required>
        <option value="">Vyber pohlaví</option>
        <option value="muz">Muž</option>
        <option value="zena">Žena</option>
        <option value="jine">Jiné</option>
      </select>
      <select id="location" required>
        <option value="">Vyber kraj</option>
        <option value="Hlavní město Praha">Hlavní město Praha</option>
        <option value="Středočeský kraj">Středočeský kraj</option>
        <option value="Jihočeský kraj">Jihočeský kraj</option>
        <option value="Plzeňský kraj">Plzeňský kraj</option>
        <option value="Karlovarský kraj">Karlovarský kraj</option>
        <option value="Ústecký kraj">Ústecký kraj</option>
        <option value="Liberecký kraj">Liberecký kraj</option>
        <option value="Královéhradecký kraj">Královéhradecký kraj</option>
        <option value="Pardubický kraj">Pardubický kraj</option>
        <option value="Vysočina">Vysočina</option>
        <option value="Jihomoravský kraj">Jihomoravský kraj</option>
        <option value="Olomoucký kraj">Olomoucký kraj</option>
        <option value="Zlínský kraj">Zlínský kraj</option>
        <option value="Moravskoslezský kraj">Moravskoslezský kraj</option>
      </select>
      <textarea id="bio" placeholder="O mně"></textarea>

      <div id="specializationOptions" class="checkbox-group">
        <label><input type="checkbox" name="specializations" value="Fitness" /> Fitness</label><br/>
        <label><input type="checkbox" name="specializations" value="Kondiční trénink" /> Kondiční trénink</label><br/>
        <label><input type="checkbox" name="specializations" value="Silový trénink" /> Silový trénink</label><br/>
        <label><input type="checkbox" name="specializations" value="Hubnutí" /> Hubnutí</label><br/>
        <label><input type="checkbox" name="specializations" value="Výživa" /> Výživa / Nutriční poradenství</label><br/>
        <label><input type="checkbox" name="specializations" value="Rehabilitace" /> Rehabilitace</label><br/>
        <label><input type="checkbox" name="specializations" value="Běhání" /> Běhání</label><br/>
        <label><input type="checkbox" name="specializations" value="Jóga" /> Jóga</label><br/>
        <label><input type="checkbox" name="specializations" value="Pilates" /> Pilates</label><br/>
        <label><input type="checkbox" name="specializations" value="Skupinové lekce" /> Skupinové lekce</label><br/>
      </div>

      <textarea id="pricing" placeholder="cenník" required></textarea>
      <input type="number" id="experience" min="0" max="50" placeholder="Roky zkušeností" />

      <div id="languageOptions" class="checkbox-group">
        <label><input type="checkbox" name="languages" value="CZ" /> Čeština (CZ)</label><br/>
        <label><input type="checkbox" name="languages" value="EN" /> Angličtina (EN)</label><br/>
        <label><input type="checkbox" name="languages" value="DE" /> Němčina (DE)</label><br/>
        <label><input type="checkbox" name="languages" value="SK" /> Slovenština (SK)</label><br/>
        <label><input type="checkbox" name="languages" value="RU" /> Ruština (RU)</label><br/>
        <label><input type="checkbox" name="languages" value="FR" /> Francouzština (FR)</label><br/>
      </div>

      <img id="profilePreview" src="" alt="Profilový obrázek" style="display:none" />
      <input type="file" id="profileImage" accept="image/*" />

      <h3>Sociální sítě (volitelné)</h3>
      <input type="text" id="instagram" placeholder="Instagram (uživatelské jméno nebo odkaz)" />
      <input type="text" id="facebook" placeholder="Facebook (uživatelské jméno nebo odkaz)" />
      <input type="text" id="tiktok" placeholder="TikTok (uživatelské jméno nebo odkaz)" />

      <button type="submit">Uložit změny</button>
    </form>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Load TFJS then NSFWJS (global window.nsfwjs) -->
  <script src="https://unpkg.com/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <script src="https://unpkg.com/nsfwjs@4.1.0/dist/nsfwjs.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
      authDomain: "cztrainers-dat1.firebaseapp.com",
      databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cztrainers-dat1",
      storageBucket: "cztrainers-dat1.appspot.com",
      messagingSenderId: "369200533487",
      appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };

    const CLOUD_NAME = "dkt3pdcbe";
    const SIGNER_URL = "https://wandering-sunset-c489.aiman18192.workers.dev/";
    const MAX_FILE_SIZE = 500 * 1024;
    const MAX_DIM = 800;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const form = document.getElementById("profileForm");
    const imageInput = document.getElementById("profileImage");
    const preview = document.getElementById("profilePreview");
    let currentUrl = "";

    // Preview on choose
    imageInput.addEventListener("change", () => {
      const file = imageInput.files[0];
      if (!file) return;
      if (file.size > MAX_FILE_SIZE) {
        alert("Obrázek je moc velký (max 500 KB).");
        imageInput.value = "";
        preview.style.display = "none";
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    });

    // ---------- helpers: downscale, NSFW, signer, signed upload ----------
    async function downscaleImage(file, maxDim = MAX_DIM, mime = "image/jpeg", quality = 0.9) {
      try {
        const img = await new Promise((res, rej) => {
          const i = new Image();
          i.onload = () => res(i);
          i.onerror = rej;
          i.src = URL.createObjectURL(file);
        });
        const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
        if (!isFinite(scale) || scale <= 0) return file;

        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const canvas = document.createElement("canvas");
        canvas.width = w; canvas.height = h;
        canvas.getContext("2d").drawImage(img, 0, 0, w, h);

        const blob = await new Promise((res) => canvas.toBlob(res, mime, quality));
        if (!blob || !blob.size) return file; // fallback
        return new File([blob], "pfp.jpg", { type: mime });
      } catch (e) {
        console.warn("Downscale failed, using original file:", e);
        return file;
      }
    }

    let nsfwModelPromise;
    function getNSFWModel() {
      if (nsfwModelPromise) return nsfwModelPromise;
      const NSFW = window.nsfwjs;
      if (!NSFW) throw new Error("NSFWJS failed to load");
      // v4 bundles the model; no URL needed
      nsfwModelPromise = NSFW.load();
      return nsfwModelPromise;
    }
    
    getNSFWModel().catch(err => console.error("[nsfw] preload failed:", err));

    // --- NSFW check helper ---
    async function isImageSafe(file){
      const model = await getNSFWModel();               // loads the model (with CDN fallback)
      // Turn file into a DataURL for classification
      const dataURL = await new Promise((res) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.readAsDataURL(file);
      });
      // Create an <img> for the model
      const img = new Image();
      await new Promise((res, rej) => { img.onload = res; img.onerror = rej; img.src = dataURL; });

      const preds = await model.classify(img);          // [{className, probability}, ...]
      const score = { Sexy: 0, Porn: 0, Hentai: 0 };
      preds.forEach(p => { if (score[p.className] != null) score[p.className] = p.probability; });

      // simple thresholds (tune if you want)
      if (score.Porn + score.Hentai >= 0.2) return false;
      if (score.Sexy >= 0.5) return false;
      return true;
    }

    async function getSignature(params){
      console.log("[pfp] requesting signature…", params);
      try {
        const r = await fetch(SIGNER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(params)
        });
        const txt = await r.text().catch(()=>"(no body)");
        if (!r.ok) {
          console.error("Signer HTTP error:", r.status, txt);
          throw new Error(`Signer HTTP ${r.status}: ${txt}`);
        }
        const json = JSON.parse(txt);
        console.log("[pfp] signature ok");
        return json; // { signature, apiKey }
      } catch (e) {
        console.error("Signer fetch failed:", e);
        throw new Error("Nepodařilo se kontaktovat podpisovou službu (Worker).");
      }
    }

    async function uploadPfpSigned({ file, uid }){
      const public_id = `users/${uid}/pfp`;
      const timestamp = Math.floor(Date.now()/1000);

      const { signature, apiKey } = await getSignature({ public_id, timestamp, overwrite:true, invalidate:true });

      console.log("[pfp] uploading to Cloudinary…");
      const formData = new FormData();
      formData.append("file", file, "pfp.jpg");
      formData.append("api_key", apiKey);
      formData.append("timestamp", String(timestamp));
      formData.append("public_id", public_id);
      formData.append("overwrite", "true");
      formData.append("invalidate", "true");
      formData.append("signature", signature);

      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
      let resp;
      try {
        resp = await fetch(url, { method: "POST", body: formData });
      } catch (e) {
        console.error("Cloudinary fetch failed (network/CORS):", e);
        throw new Error("Nelze se připojit ke Cloudinary (síť/CORS).");
      }
      const bodyTxt = await resp.text().catch(()=>"(no body)");
      if (!resp.ok) {
        console.error("Cloudinary HTTP error:", resp.status, bodyTxt);
        throw new Error(`Cloudinary chyba ${resp.status}: ${bodyTxt}`);
      }
      const json = JSON.parse(bodyTxt);
      console.log("[pfp] upload ok:", json.secure_url);
      return json;
    }

    // Utility: normalize list coming from DB (array or comma string)
    function asArray(val){
      if (!val) return [];
      if (Array.isArray(val)) return val;
      if (typeof val === "string") return val.split(",").map(s => s.trim()).filter(Boolean);
      return [];
    }

    onAuthStateChanged(auth, (user) => {
      if (!user || !user.emailVerified) {
        alert("Nejste přihlášen nebo nemáte ověřený email.");
        window.location.href = "login.html";
        return;
      }

      const userRef = ref(db, "users/" + user.uid);

      get(userRef).then((snap) => {
        if (!snap.exists()) return;

        const d = snap.val();
        form.name.value = d.name || "";
        form.prijmeni.value = d.prijmeni || "";
        form.datum.value = d.datum || "";
        form.phone.value = d.phone || "";
        form.gender.value = d.gender || "";
        form.location.value = d.location || "";
        form.bio.value = d.bio || "";
        form.pricing.value = d.pricing || "";
        form.experience.value = d.experience || "";

        // socials (supports both flat and nested under d.socials)
        const socials = d.socials || {};
        form.instagram.value = (d.instagram ?? socials.instagram ?? "") || "";
        form.facebook.value  = (d.facebook  ?? socials.facebook  ?? "") || "";
        form.tiktok.value    = (d.tiktok    ?? socials.tiktok    ?? "") || "";

        // checkboxes
        const specs = asArray(d.specializations);
        document.querySelectorAll("#specializationOptions input[type='checkbox']").forEach(cb => {
          cb.checked = specs.includes(cb.value);
        });

        const langs = asArray(d.languages);
        document.querySelectorAll("#languageOptions input[type='checkbox']").forEach(cb => {
          cb.checked = langs.includes(cb.value);
        });

        currentUrl = d.profilePicture || "";
        if (currentUrl) {
          const thumb = currentUrl.includes("/image/upload/")
            ? currentUrl.replace("/image/upload/", "/image/upload/c_fill,w_320,h_320,q_auto,f_auto/")
            : currentUrl;
          preview.src = thumb;
          preview.style.display = "block";
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        let newUrl = currentUrl;

        // If user picked a new image, validate + upload signed to overwrite users/<uid>/pfp
        if (imageInput.files.length > 0) {
          const raw = imageInput.files[0];
          if (raw.size > MAX_FILE_SIZE) {
            alert("Obrázek je příliš velký.");
            return;
          }
          try {
            const jpg = await downscaleImage(raw);

            const safe = await isImageSafe(jpg);
            if (!safe) {
              alert("Tento obrázek není vhodný pro profil (NSFW). Zvolte prosím jiný.");
              return;
            }

            const { secure_url } = await uploadPfpSigned({ file: jpg, uid: user.uid });
            newUrl = secure_url;
          } catch (err) {
            console.error("[pfp] upload failed:", err);
            alert("Nepodařilo se nahrát obrázek: " + err.message);
            return;
          }
        }
        // Preload so uploads don't fail on first use
        getNSFWModel().catch(err => console.error("[nsfw] preload failed:", err));

        // Collect checkbox values
        const selectedSpecializations = Array.from(
          document.querySelectorAll("#specializationOptions input[type='checkbox']:checked")
        ).map(cb => cb.value);

        const selectedLanguages = Array.from(
          document.querySelectorAll("#languageOptions input[type='checkbox']:checked")
        ).map(cb => cb.value);

        const updated = {
          name: form.name.value,
          prijmeni: form.prijmeni.value,
          datum: form.datum.value,
          phone: form.phone.value,
          gender: form.gender.value,
          location: form.location.value,
          bio: form.bio.value,
          specializations: selectedSpecializations,
          pricing: form.pricing.value,
          experience: form.experience.value,
          languages: selectedLanguages,
          email: user.email,
          profilePicture: newUrl,
          instagram: form.instagram.value.trim(),
          facebook: form.facebook.value.trim(),
          tiktok: form.tiktok.value.trim()
        };

        set(userRef, updated).then(() => {
          alert("Profil uložen.");
          currentUrl = newUrl;
          if (currentUrl) {
            const thumb = currentUrl.includes("/image/upload/")
              ? currentUrl.replace("/image/upload/", "/image/upload/c_fill,w_320,h_320,q_auto,f_auto/")
              : currentUrl;
            preview.src = thumb;
            preview.style.display = "block";
          }
          // optional redirect:
          // window.location.href = "index_main.html";
        }).catch((err) => alert("Chyba: " + err.message));
      });
    });
  </script>

  <script>
    const icon = document.getElementById("themeIcon");
    const toggle = document.getElementById("themeToggle");
    const toast = document.getElementById("toast");

    function updateThemeUI(isDark) {
      document.body.classList.toggle("dark", isDark);
      icon.textContent = isDark ? "🌙" : "☀️";
      localStorage.setItem("theme", isDark ? "dark" : "light");
      toast.textContent = isDark ? "Tmavý mód zapnut" : "Světlý mód zapnut";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    if (localStorage.getItem("theme") === "dark") updateThemeUI(true);
    toggle.addEventListener("click", () => updateThemeUI(!document.body.classList.contains("dark")));
    document.getElementById("hamburger").addEventListener("click", () => {
      document.getElementById("navLinks").classList.toggle("active");
    });
  </script>
  <script type="module" src="auth-navbar.js"></script>
</body>
</html>
