<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MÅ¯j profil â€“ CZTRAINERS</title>
  <link rel="stylesheet" href="mujprofil.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
</head>
<body>
  <nav class="navbar">
    <div class="nav-logo">
      <a href="index_main.html"><img src="CZtrainers new better.png" alt="CZTRAINERS Logo" /></a>
    </div>
    <button class="hamburger" id="hamburger" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-links" id="navLinks">
      <a href="index_main.html" class="nav-button">DomÅ¯</a>
      <div id="authButtons">
        <a href="index.html" class="nav-button" id="registerBtn">Registrace</a>
        <a href="login.html" class="nav-button" id="loginBtn">PÅ™ihlÃ¡Å¡enÃ­</a>
      </div>
      <a href="mujprofil.html" class="nav-button" id="profileBtn" style="display: none;">MÅ¯j profil</a>
      <a href="#" class="nav-button" id="logoutBtn" style="display: none;">OdhlÃ¡sit se</a>
      <a href="o-nas.html" class="nav-button">O nÃ¡s</a>
      <button class="theme-toggle" id="themeToggle"><span id="themeIcon">â˜€ï¸</span></button>
    </div>
  </nav>

  <div class="container">
    <h2>MÅ¯j profil</h2>
    <form id="profileForm">
      <input type="text" id="name" placeholder="JmÃ©no" />
      <input type="text" id="prijmeni" placeholder="PÅ™Ã­jmenÃ­" />
      <input type="date" id="datum" />
      <input type="tel" id="phone" placeholder="TelefonnÃ­ ÄÃ­slo" pattern="^\+?[0-9]{7,15}$" required />
      <select id="gender" required>
        <option value="">Vyber pohlavÃ­</option>
        <option value="muz">MuÅ¾</option>
        <option value="zena">Å½ena</option>
        <option value="jine">JinÃ©</option>
      </select>
      <select id="location" required>
        <option value="">Vyber kraj</option>
        <option value="HlavnÃ­ mÄ›sto Praha">HlavnÃ­ mÄ›sto Praha</option>
        <option value="StÅ™edoÄeskÃ½ kraj">StÅ™edoÄeskÃ½ kraj</option>
        <option value="JihoÄeskÃ½ kraj">JihoÄeskÃ½ kraj</option>
        <option value="PlzeÅˆskÃ½ kraj">PlzeÅˆskÃ½ kraj</option>
        <option value="KarlovarskÃ½ kraj">KarlovarskÃ½ kraj</option>
        <option value="ÃšsteckÃ½ kraj">ÃšsteckÃ½ kraj</option>
        <option value="LibereckÃ½ kraj">LibereckÃ½ kraj</option>
        <option value="KrÃ¡lovÃ©hradeckÃ½ kraj">KrÃ¡lovÃ©hradeckÃ½ kraj</option>
        <option value="PardubickÃ½ kraj">PardubickÃ½ kraj</option>
        <option value="VysoÄina">VysoÄina</option>
        <option value="JihomoravskÃ½ kraj">JihomoravskÃ½ kraj</option>
        <option value="OlomouckÃ½ kraj">OlomouckÃ½ kraj</option>
        <option value="ZlÃ­nskÃ½ kraj">ZlÃ­nskÃ½ kraj</option>
        <option value="MoravskoslezskÃ½ kraj">MoravskoslezskÃ½ kraj</option>
      </select>
      <textarea id="bio" placeholder="O mnÄ›"></textarea>

      <div id="specializationOptions" class="checkbox-group">
        <label><input type="checkbox" name="specializations" value="Fitness" /> Fitness</label><br/>
        <label><input type="checkbox" name="specializations" value="KondiÄnÃ­ trÃ©nink" /> KondiÄnÃ­ trÃ©nink</label><br/>
        <label><input type="checkbox" name="specializations" value="SilovÃ½ trÃ©nink" /> SilovÃ½ trÃ©nink</label><br/>
        <label><input type="checkbox" name="specializations" value="HubnutÃ­" /> HubnutÃ­</label><br/>
        <label><input type="checkbox" name="specializations" value="VÃ½Å¾iva" /> VÃ½Å¾iva / NutriÄnÃ­ poradenstvÃ­</label><br/>
        <label><input type="checkbox" name="specializations" value="Rehabilitace" /> Rehabilitace</label><br/>
        <label><input type="checkbox" name="specializations" value="BÄ›hÃ¡nÃ­" /> BÄ›hÃ¡nÃ­</label><br/>
        <label><input type="checkbox" name="specializations" value="JÃ³ga" /> JÃ³ga</label><br/>
        <label><input type="checkbox" name="specializations" value="Pilates" /> Pilates</label><br/>
        <label><input type="checkbox" name="specializations" value="SkupinovÃ© lekce" /> SkupinovÃ© lekce</label><br/>
      </div>

      <textarea id="pricing" placeholder="cennÃ­k" required></textarea>
      <input type="number" id="experience" min="0" max="50" placeholder="Roky zkuÅ¡enostÃ­" />

      <div id="languageOptions" class="checkbox-group">
        <label><input type="checkbox" name="languages" value="CZ" /> ÄŒeÅ¡tina (CZ)</label><br/>
        <label><input type="checkbox" name="languages" value="EN" /> AngliÄtina (EN)</label><br/>
        <label><input type="checkbox" name="languages" value="DE" /> NÄ›mÄina (DE)</label><br/>
        <label><input type="checkbox" name="languages" value="SK" /> SlovenÅ¡tina (SK)</label><br/>
        <label><input type="checkbox" name="languages" value="RU" /> RuÅ¡tina (RU)</label><br/>
        <label><input type="checkbox" name="languages" value="FR" /> FrancouzÅ¡tina (FR)</label><br/>
      </div>

      <img id="profilePreview" src="" alt="ProfilovÃ½ obrÃ¡zek" style="display:none" />
      <input type="file" id="profileImage" accept="image/*" />

      <h3>SociÃ¡lnÃ­ sÃ­tÄ› (volitelnÃ©)</h3>
      <input type="text" id="instagram" placeholder="Instagram (uÅ¾ivatelskÃ© jmÃ©no nebo odkaz)" />
      <input type="text" id="facebook" placeholder="Facebook (uÅ¾ivatelskÃ© jmÃ©no nebo odkaz)" />
      <input type="text" id="tiktok" placeholder="TikTok (uÅ¾ivatelskÃ© jmÃ©no nebo odkaz)" />

      <button type="submit">UloÅ¾it zmÄ›ny</button>
    </form>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Load TFJS then NSFWJS (global window.nsfwjs) -->
  <script src="https://unpkg.com/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <script src="https://unpkg.com/nsfwjs@2/dist/nsfwjs.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
  authDomain: "cztrainers-dat1.firebaseapp.com",
  databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "cztrainers-dat1",
  storageBucket: "cztrainers-dat1.appspot.com",
  messagingSenderId: "369200533487",
  appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
};

const CLOUD_NAME = "dkt3pdcbe";
const SIGNER_URL = "https://wandering-sunset-c489.aiman18192.workers.dev/";
const MAX_FILE_SIZE = 500 * 1024;
const MAX_DIM = 800;

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const form = document.getElementById("profileForm");
const imageInput = document.getElementById("profileImage");
const preview = document.getElementById("profilePreview");
let currentUrl = "";

// Preview on choose
imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (!file) return;
  if (file.size > MAX_FILE_SIZE) {
    alert("ObrÃ¡zek je moc velkÃ½ (max 500 KB).");
    imageInput.value = "";
    preview.style.display = "none";
    return;
  }
  const reader = new FileReader();
  reader.onload = (e) => {
    preview.src = e.target.result;
    preview.style.display = "block";
  };
  reader.readAsDataURL(file);
});

// ---------- helpers: downscale, NSFW, signer, signed upload ----------
async function downscaleImage(file, maxDim = MAX_DIM, mime = "image/jpeg", quality = 0.9) {
  const img = await new Promise((res, rej) => {
    const i = new Image();
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = URL.createObjectURL(file);
  });
  const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);
  const canvas = document.createElement("canvas");
  canvas.width = w; canvas.height = h;
  canvas.getContext("2d").drawImage(img, 0, 0, w, h);
  return new Promise((res) => canvas.toBlob(res, mime, quality));
}

let nsfwModelPromise;
function getNSFWModel(){
  const NSFW = window.nsfwjs;
  if (!NSFW) throw new Error("NSFWJS failed to load");
  return nsfwModelPromise ||= NSFW.load();
}
async function isImageSafe(file){
  const model = await getNSFWModel();
  const dataURL = await new Promise((res)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file);});
  const img = new Image(); await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=dataURL; });
  const preds = await model.classify(img);
  const score = {Sexy:0,Porn:0,Hentai:0};
  preds.forEach(p=>{ if(score[p.className]!=null) score[p.className]=p.probability; });
  if (score.Porn + score.Hentai >= 0.2) return false;
  if (score.Sexy >= 0.5) return false;
  return true;
}

async function getSignature(params){
  try {
    const r = await fetch(SIGNER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(params)
    });
    if (!r.ok) {
      const txt = await r.text().catch(()=>"(no body)");
      console.error("Signer HTTP error:", r.status, txt);
      throw new Error(`Signer HTTP ${r.status}`);
    }
    return r.json(); // { signature, apiKey }
  } catch (e) {
    console.error("Signer fetch failed:", e);
    throw new Error("NepodaÅ™ilo se kontaktovat podpisovou sluÅ¾bu (Worker).");
  }
}

async function uploadPfpSigned({ file, uid }){
  const public_id = `users/${uid}/pfp`;
  const timestamp = Math.floor(Date.now()/1000);

  // 1) Ask Worker
  const { signature, apiKey } = await getSignature({ public_id, timestamp, overwrite:true, invalidate:true });

  // 2) Upload to Cloudinary
  const formData = new FormData();
  formData.append("file", file);
  formData.append("api_key", apiKey);
  formData.append("timestamp", String(timestamp));
  formData.append("public_id", public_id);
  formData.append("overwrite", "true");
  formData.append("invalidate", "true");
  formData.append("signature", signature);

  const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
  let resp;
  try {
    resp = await fetch(url, { method: "POST", body: formData });
  } catch (e) {
    console.error("Cloudinary fetch failed (network/CORS):", e);
    throw new Error("Nelze se pÅ™ipojit ke Cloudinary (sÃ­Å¥/CORS).");
  }
  if (!resp.ok) {
    const body = await resp.text().catch(()=>"(no body)");
    console.error("Cloudinary HTTP error:", resp.status, body);
    throw new Error(`Cloudinary chyba ${resp.status}`);
  }
  return resp.json();
}

// Utility: normalize list coming from DB (array or comma string)
function asArray(val){
  if (!val) return [];
  if (Array.isArray(val)) return val;
  if (typeof val === "string") return val.split(",").map(s => s.trim()).filter(Boolean);
  return [];
}

onAuthStateChanged(auth, (user) => {
  if (!user || !user.emailVerified) {
    alert("Nejste pÅ™ihlÃ¡Å¡en nebo nemÃ¡te ovÄ›Å™enÃ½ email.");
    window.location.href = "login.html";
    return;
  }

  const userRef = ref(db, "users/" + user.uid);

  get(userRef).then((snap) => {
    if (!snap.exists()) return;

    const d = snap.val();
    form.name.value = d.name || "";
    form.prijmeni.value = d.prijmeni || "";
    form.datum.value = d.datum || "";
    form.phone.value = d.phone || "";
    form.gender.value = d.gender || "";
    form.location.value = d.location || "";
    form.bio.value = d.bio || "";
    form.pricing.value = d.pricing || "";
    form.experience.value = d.experience || "";

    // socials (supports both flat and nested under d.socials)
    const socials = d.socials || {};
    form.instagram.value = (d.instagram ?? socials.instagram ?? "") || "";
    form.facebook.value  = (d.facebook  ?? socials.facebook  ?? "") || "";
    form.tiktok.value    = (d.tiktok    ?? socials.tiktok    ?? "") || "";

    // checkboxes
    const specs = asArray(d.specializations);
    document.querySelectorAll("#specializationOptions input[type='checkbox']").forEach(cb => {
      cb.checked = specs.includes(cb.value);
    });

    const langs = asArray(d.languages);
    document.querySelectorAll("#languageOptions input[type='checkbox']").forEach(cb => {
      cb.checked = langs.includes(cb.value);
    });

    currentUrl = d.profilePicture || "";
    if (currentUrl) {
      // use a thumb transform if it's a Cloudinary URL
      const thumb = currentUrl.includes("/image/upload/")
        ? currentUrl.replace("/image/upload/", "/image/upload/c_fill,w_320,h_320,q_auto,f_auto/")
        : currentUrl;
      preview.src = thumb;
      preview.style.display = "block";
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    let newUrl = currentUrl;

    // If user picked a new image, validate + upload signed to overwrite users/<uid>/pfp
    if (imageInput.files.length > 0) {
      const file = imageInput.files[0];
      if (file.size > MAX_FILE_SIZE) {
        alert("ObrÃ¡zek je pÅ™Ã­liÅ¡ velkÃ½.");
        return;
      }
      try {
        const blob = await downscaleImage(file);
        const jpg = new File([blob], "pfp.jpg", { type: "image/jpeg" });

        const safe = await isImageSafe(jpg);
        if (!safe) {
          alert("Tento obrÃ¡zek nenÃ­ vhodnÃ½ pro profil (NSFW). Zvolte prosÃ­m jinÃ½.");
          return;
        }

        const { secure_url } = await uploadPfpSigned({ file: jpg, uid: user.uid });
        newUrl = secure_url;
      } catch (err) {
        alert("NepodaÅ™ilo se nahrÃ¡t obrÃ¡zek: " + err.message);
        return;
      }
    }

    // Collect checkbox values
    const selectedSpecializations = Array.from(
      document.querySelectorAll("#specializationOptions input[type='checkbox']:checked")
    ).map(cb => cb.value);

    const selectedLanguages = Array.from(
      document.querySelectorAll("#languageOptions input[type='checkbox']:checked")
    ).map(cb => cb.value);

    // socials (store flat; your listing code can read either flat or nested)
    const updated = {
      name: form.name.value,
      prijmeni: form.prijmeni.value,
      datum: form.datum.value,
      phone: form.phone.value,
      gender: form.gender.value,
      location: form.location.value,
      bio: form.bio.value,
      specializations: selectedSpecializations,
      pricing: form.pricing.value,
      experience: form.experience.value,
      languages: selectedLanguages,
      email: user.email,
      profilePicture: newUrl,
      instagram: form.instagram.value.trim(),
      facebook: form.facebook.value.trim(),
      tiktok: form.tiktok.value.trim()
    };

    set(userRef, updated).then(() => {
      alert("Profil uloÅ¾en.");
      currentUrl = newUrl;
      if (currentUrl) {
        const thumb = currentUrl.includes("/image/upload/")
          ? currentUrl.replace("/image/upload/", "/image/upload/c_fill,w_320,h_320,q_auto,f_auto/")
          : currentUrl;
        preview.src = thumb;
        preview.style.display = "block";
      }
      // optional: redirect
      // window.location.href = "index_main.html";
    }).catch((err) => alert("Chyba: " + err.message));
  });
});
</script>

  <script>
    const icon = document.getElementById("themeIcon");
    const toggle = document.getElementById("themeToggle");
    const toast = document.getElementById("toast");

    function updateThemeUI(isDark) {
      document.body.classList.toggle("dark", isDark);
      icon.textContent = isDark ? "ğŸŒ™" : "â˜€ï¸";
      localStorage.setItem("theme", isDark ? "dark" : "light");
      toast.textContent = isDark ? "TmavÃ½ mÃ³d zapnut" : "SvÄ›tlÃ½ mÃ³d zapnut";
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    if (localStorage.getItem("theme") === "dark") updateThemeUI(true);
    toggle.addEventListener("click", () => updateThemeUI(!document.body.classList.contains("dark")));
    document.getElementById("hamburger").addEventListener("click", () => {
      document.getElementById("navLinks").classList.toggle("active");
    });
  </script>
  <script type="module" src="auth-navbar.js"></script>
</body>
</html>
