<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZTRAINERS</title>

  <!-- Fonts + global stylesheet -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="style_main.css" />
</head>
<body>
  <!-- NAVBAR (desktop = inline links, mobile = hamburger) -->
  <nav class="navbar">
    <a class="nav-logo" href="index_main.html" aria-label="CZTRAINERS">
      <img src="CZtrainers new better.png" alt="CZTRAINERS Logo" />
    </a>

    <!-- Hamburger (shown on mobile by CSS) -->
    <button class="hamburger" id="hamburger" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>

    <!-- Inline links container -->
    <div class="nav-links" id="navLinks">
      <a href="index_main.html" class="nav-button">Dom≈Ø</a>

      <!-- Public -->
      <a href="index.html" class="nav-button" id="registerBtn">Registrace</a>
      <a href="login.html" class="nav-button" id="loginBtn">P≈ôihl√°≈°en√≠</a>

      <!-- Private (shown when logged in & verified) -->
      <a href="mujprofil.html" class="nav-button" id="profileBtn" style="display:none">M≈Øj profil</a>
      <a href="account.html" class="nav-button" id="accountBtn" style="display:none">√öƒçet &amp; Zabezpeƒçen√≠</a>
      <a href="#" class="nav-button" id="logoutBtn" style="display:none">Odhl√°sit se</a>

      <a href="o-nas.html" class="nav-button">O n√°s</a>

      <button class="theme-toggle" id="themeToggle" type="button" aria-label="P≈ôepnout motiv">
        <span id="themeIcon">‚òÄÔ∏è</span>
      </button>
    </div>
  </nav>

  <!-- PAGE CONTENT -->
  <div class="container">
    <h1>PROFESION√ÅLN√ç TREN√â≈òI V ƒåESK√â REPUBLICE</h1>

    <!-- Toolbar: search + filters button + active chips -->
    <div class="toolbar">
      <div class="search-wrap">
        <input type="text" id="search" placeholder="Hledat jm√©no..." />
        <button id="filtersToggle" type="button" class="filters-toggle">Filtry</button>
      </div>
      <div id="activeChips" class="chips"></div>
    </div>

    <!-- Filters panel -->
    <div id="filtersPanel" class="filters-panel" hidden>
      <div class="filters-grid">
        <fieldset>
          <legend>Lokalita</legend>
          <div id="f-locations"></div>
        </fieldset>
        <fieldset>
          <legend>Specializace</legend>
          <div id="f-specs">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Jazyky</legend>
          <div id="f-langs">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Pohlav√≠</legend>
          <div id="f-genders">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Zku≈°enosti (roky)</legend>
          <div class="number-row">
            <input type="number" id="f-exp-min" min="0" placeholder="Min" />
            <input type="number" id="f-exp-max" min="0" placeholder="Max" />
          </div>
          <div id="f-exp-hint" class="small"></div>
        </fieldset>
      </div>
      <div class="filters-actions">
        <button id="filtersClear" class="btn">Vymazat v≈°e</button>
        <button id="filtersApply" class="btn primary">Pou≈æ√≠t</button>
      </div>
    </div>

    <div id="loader" class="loader">Naƒç√≠t√°m u≈æivatele...</div>
    <div id="userList" class="cards"></div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- js for the filters -->
  <script type="module" src="filters.js"></script>

  <!-- Shared navbar logic for ALL pages -->
  <script type="module" src="auth-navbar.js"></script>

  <!-- Page-specific logic (trainers list + filters) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
      authDomain: "cztrainers-dat1.firebaseapp.com",
      databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cztrainers-dat1",
      storageBucket: "cztrainers-dat1.appspot.com",
      messagingSenderId: "369200533487",
      appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };

    // Safe initialize
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Cloudinary thumb helper
    const CLOUD_NAME = "dkt3pdcbe";
    function clThumb(uid) {
      return `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/c_fill,w_320,h_320,q_auto,f_auto/users/${uid}/pfp`;
    }

    // DOM
    const userList      = document.getElementById("userList");
    const searchInput   = document.getElementById("search");
    const loader        = document.getElementById("loader");
    const filtersToggle = document.getElementById("filtersToggle");
    const filtersPanel  = document.getElementById("filtersPanel");
    const chipsWrap     = document.getElementById("activeChips");

    const boxLocations = document.getElementById("f-locations");
    const boxSpecs     = document.getElementById("f-specs");
    const boxLangs     = document.getElementById("f-langs");
    const boxGenders   = document.getElementById("f-genders");
    const expMinInput  = document.getElementById("f-exp-min");
    const expMaxInput  = document.getElementById("f-exp-max");
    const expHint      = document.getElementById("f-exp-hint");

    const btnApply = document.getElementById("filtersApply");
    const btnClear = document.getElementById("filtersClear");

    // State
    let allUsers = []; // [ [uid, user], ... ]
    let facets   = null;

    // Toggle filters panel
    filtersToggle.addEventListener("click", () => {
      const open = filtersPanel.hasAttribute("hidden");
      if (open) filtersPanel.removeAttribute("hidden");
      else filtersPanel.setAttribute("hidden", "");
    });

    // Helpers
    const uniqPush = (set, val) => { if (val && String(val).trim()) set.add(String(val).trim()); };

    function buildFacets(users){
      const locations = new Set(), specs = new Set(), langs = new Set(), genders = new Set();
      let expMin = Infinity, expMax = -Infinity;

      users.forEach(([_, u]) => {
        uniqPush(locations, u.location);
        uniqPush(genders,   u.gender);

        const sArr = Array.isArray(u.specializations) ? u.specializations :
          (typeof u.specializations === 'string' ? u.specializations.split(',').map(s=>s.trim()) : []);
        sArr.forEach(v => uniqPush(specs, v));

        const lArr = Array.isArray(u.languages) ? u.languages :
          (typeof u.languages === 'string' ? u.languages.split(',').map(s=>s.trim()) : []);
        lArr.forEach(v => uniqPush(langs, v));

        const e = Number(u.experience || 0);
        if (Number.isFinite(e)) { expMin = Math.min(expMin, e); expMax = Math.max(expMax, e); }
      });

      if (!Number.isFinite(expMin)) expMin = 0;
      if (!Number.isFinite(expMax)) expMax = 0;
      return { locations, specs, langs, genders, expMin, expMax };
    }

    function checkboxList(container, name, values){
      const arr = [...values].sort((a,b)=>a.localeCompare(b,'cs'));
      container.innerHTML = arr.map(v => `
        <label style="display:block; margin:.25rem 0;">
          <input type="checkbox" name="${name}" value="${v}"> ${v}
        </label>
      `).join("") || "<span class='small'>≈Ω√°dn√© polo≈æky</span>";
    }

    function populateFilters(){
      checkboxList(boxLocations, "loc",    facets.locations);
      checkboxList(boxSpecs,     "spec",   facets.specs);
      checkboxList(boxLangs,     "lang",   facets.langs);
      checkboxList(boxGenders,   "gender", facets.genders);

      expMinInput.placeholder = String(facets.expMin);
      expMaxInput.placeholder = String(facets.expMax);
      expHint.textContent     = `Rozsah v datech: ${facets.expMin} ‚Äì ${facets.expMax} let`;
    }

    function getFiltersFromUI(){
      const checked = (sel) => [...document.querySelectorAll(sel+':checked')].map(i=>i.value);
      return {
        q:      searchInput.value.trim().toLowerCase(),
        loc:    checked('input[name="loc"]'),
        spec:   checked('input[name="spec"]'),
        lang:   checked('input[name="lang"]'),
        gender: checked('input[name="gender"]'),
        expMin: expMinInput.value ? Number(expMinInput.value) : null,
        expMax: expMaxInput.value ? Number(expMaxInput.value) : null,
      };
    }

    function applyFilters(users, f){
      const q = f.q;
      return users.filter(([_, u]) => {
        if (q) {
          const hay = [
            u.name, u.prijmeni, u.bio,
            Array.isArray(u.specializations) ? u.specializations.join(" ") : u.specializations,
            u.location
          ].filter(Boolean).join(" ").toLowerCase();
          if (!hay.includes(q)) return false;
        }

        if (f.loc.length && !f.loc.includes(u.location)) return false;

        if (f.spec.length) {
          const sArr = Array.isArray(u.specializations) ? u.specializations :
            (typeof u.specializations === 'string' ? u.specializations.split(',').map(s=>s.trim()) : []);
          if (!f.spec.every(s => sArr.includes(s))) return false; // require ALL selected specs
        }

        if (f.lang.length) {
          const lArr = Array.isArray(u.languages) ? u.languages :
            (typeof u.languages === 'string' ? u.languages.split(',').map(s=>s.trim()) : []);
          if (!f.lang.some(l => lArr.includes(l))) return false; // at least ONE language
        }

        if (f.gender.length && !f.gender.includes(u.gender)) return false;

        const e = Number(u.experience || 0);
        if (f.expMin != null && e < f.expMin) return false;
        if (f.expMax != null && e > f.expMax) return false;

        return true;
      });
    }

    function renderChips(f){
      const chips = [];
      const add = (label, value, clearKey, clearVal) => {
        chips.push(`<span class="chip">${label}: ${value} <button data-k="${clearKey}" data-v="${encodeURIComponent(clearVal || '')}">√ó</button></span>`);
      };

      if (f.q) add("Hledat", f.q, "q");
      f.loc.forEach(v => add("Lokalita", v, "loc", v));
      f.spec.forEach(v => add("Specializace", v, "spec", v));
      f.lang.forEach(v => add("Jazyk", v, "lang", v));
      f.gender.forEach(v => add("Pohlav√≠", v, "gender", v));
      if (f.expMin != null) add("Zku≈°enost ‚â•", f.expMin, "expMin");
      if (f.expMax != null) add("Zku≈°enost ‚â§", f.expMax, "expMax");

      chipsWrap.innerHTML = chips.join("") || "";
      chipsWrap.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const k = btn.dataset.k;
          const v = decodeURIComponent(btn.dataset.v||"");
          switch (k) {
            case "q": searchInput.value = ""; break;
            case "expMin": expMinInput.value = ""; break;
            case "expMax": expMaxInput.value = ""; break;
            default: {
              const selector = `input[name="${k}"][value="${CSS.escape(v)}"]`;
              const el = document.querySelector(selector);
              if (el) el.checked = false;
            }
          }
          doFilter();
        });
      });
    }

    function safeProfileUrl(id) {
      if (!/^[A-Za-z0-9_-]+$/.test(id)) return null;
      return `profile.html?id=${encodeURIComponent(id)}`;
    }

    function renderUsers(users) {
      userList.innerHTML = "";
      if (!users.length) {
        userList.innerHTML = "<p>≈Ω√°dn√≠ u≈æivatel√© nebyli nalezeni.</p>";
        return;
      }

      users.forEach(([id, user]) => {
        const href = safeProfileUrl(id);
        if (!href) return;

        const photoURL =
          (typeof user.profilePicture === "string" && user.profilePicture.startsWith("http"))
            ? user.profilePicture
            : clThumb(id);

        const name = (user.name || "").trim() || "Nezn√°m√Ω";
        const lastName = (user.prijmeni || "").trim();

        const card = document.createElement("a");
        card.className = "card";
        card.href = href;
        card.innerHTML = `
          <img class="profile-pic"
               src="${photoURL}"
               alt="Profilov√Ω obr√°zek"
               onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=Profil';">
          <div class="card-info">
            <h3>${name} ${lastName}</h3>
            <p><strong>Zku≈°enosti:</strong> ${user.experience || "-"} let</p>
            <p><strong>Specializace:</strong> ${
              Array.isArray(user.specializations)
                ? user.specializations.join(", ")
                : (user.specializations || "-")
            }</p>
            <p><strong>Lokalita:</strong> ${user.location || "-"}</p>
          </div>
        `;
        userList.appendChild(card);
      });
    }

    const doFilter = (() => {
      let t;
      return function trigger(){
        clearTimeout(t);
        t = setTimeout(() => {
          const f = getFiltersFromUI();
          renderChips(f);
          renderUsers(applyFilters(allUsers, f));
        }, 150);
      };
    })();

    btnApply.addEventListener("click", () => {
      doFilter();
      filtersPanel.setAttribute("hidden", "");
    });
    btnClear.addEventListener("click", () => {
      searchInput.value = "";
      expMinInput.value = "";
      expMaxInput.value = "";
      document.querySelectorAll('#filtersPanel input[type="checkbox"]').forEach(cb => (cb.checked = false));
      doFilter();
    });
    searchInput.addEventListener("input", doFilter);
    filtersPanel.addEventListener("change", (e) => {
      if (e.target.matches('input[type="checkbox"], input[type="number"]')) doFilter();
    });

    // Load trainers
    onValue(ref(db, "users/"), (snapshot) => {
      loader.style.display = "none";
      const data = snapshot.val() || {};
      allUsers = Object.entries(data).filter(([_, user]) => user && user.email);
      facets = buildFacets(allUsers);
      populateFilters();
      doFilter();
    });
  </script>

  <script>
    // Hamburger menus
    document.getElementById("hamburger").addEventListener("click", function () {
      document.getElementById("navLinks").classList.toggle("active");
    });

    // Dark/light mode
    const themeToggle = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");

    function updateTheme(isDark) {
      document.body.classList.toggle("dark", isDark);
      themeIcon.textContent = isDark ? "üåô" : "‚òÄÔ∏è";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    if (localStorage.getItem("theme") === "dark") {
      updateTheme(true);
    }

    themeToggle.addEventListener("click", () => {
      const isDark = !document.body.classList.contains("dark");
      updateTheme(isDark);
    });
  </script>
</body>
</html>
