<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZTRAINERS</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="style_main.css" />
  <style>
    /* Minimal styling (you can replace later) */
    .toolbar { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; margin:1rem 0; }
    .filters-toggle { padding:.6rem .9rem; border-radius:.6rem; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .filters-panel { display:none; border:1px solid #e5e7eb; border-radius:12px; padding:1rem; margin:.5rem 0 1rem; background:rgba(0,0,0,0.02); }
    .filters-panel.open { display:block; }
    .filters-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:1rem; }
    fieldset { border:0; background:#fff; padding:1rem; border-radius:10px; box-shadow:0 1px 0 rgba(0,0,0,.05); }
    fieldset legend { font-weight:600; margin-bottom:.5rem; }
    .chips { display:flex; gap:.5rem; flex-wrap:wrap; }
    .chip { display:inline-flex; align-items:center; gap:.35rem; padding:.35rem .6rem; border-radius:999px; background:#eef2ff; font-size:.9rem; }
    .chip button { border:0; background:transparent; cursor:pointer; font-weight:700; }
    .filters-actions { display:flex; gap:.75rem; justify-content:flex-end; margin-top:.5rem; }
    .btn { padding:.6rem .9rem; border-radius:.6rem; border:1px solid #ddd; background:#fff; cursor:pointer; }
    .btn.primary { background:#111827; color:#fff; border-color:#111827; }
    .number-row { display:flex; gap:.5rem; }
    .number-row input { width:100%; }
    .small { font-size:.85rem; color:#6b7280; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-logo">
      <a href="index_main.html"><img src="CZtrainers new better.png" alt="CZTRAINERS Logo" /></a>
    </div>
    <button class="hamburger" id="hamburger" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <div class="nav-links" id="navLinks">
      <a href="index_main.html" class="nav-button">Dom≈Ø</a>
      <div id="authButtons">
        <a href="index.html" class="nav-button" id="registerBtn">Registrace</a>
        <a href="login.html" class="nav-button" id="loginBtn">P≈ôihl√°≈°en√≠</a>
      </div>
      <a href="mujprofil.html" class="nav-button" id="profileBtn" style="display: none;">M≈Øj profil</a>
      <a href="#" class="nav-button" id="logoutBtn" style="display: none;">Odhl√°sit se</a>
      <a href="o-nas.html" class="nav-button">O n√°s</a>
      <button class="theme-toggle" id="themeToggle"><span id="themeIcon">‚òÄÔ∏è</span></button>
    </div>
  </nav>

  <div class="container">
    <h1>PROFESION√ÅLN√ç TREN√â≈òI V ƒåESK√â REPUBLICE</h1>

    <!-- Toolbar: search + filters button + active chips -->
    <div class="toolbar">
      <input type="text" id="search" placeholder="Hledat jm√©no, specializace, lokalita..." />
      <button id="filtersToggle" class="filters-toggle">Filtry</button>
      <div id="activeChips" class="chips"></div>
    </div>

    <!-- Filters panel (built dynamically from data) -->
    <div id="filtersPanel" class="filters-panel">
      <div class="filters-grid">
        <fieldset>
          <legend>Lokalita</legend>
          <div id="f-locations"></div>
        </fieldset>
        <fieldset>
          <legend>Specializace</legend>
          <div id="f-specs" class="small">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Jazyky</legend>
          <div id="f-langs" class="small">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Pohlav√≠</legend>
          <div id="f-genders" class="small">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Zku≈°enosti (roky)</legend>
          <div class="number-row">
            <input type="number" id="f-exp-min" min="0" placeholder="Min" />
            <input type="number" id="f-exp-max" min="0" placeholder="Max" />
          </div>
          <div id="f-exp-hint" class="small"></div>
        </fieldset>
      </div>
      <div class="filters-actions">
        <button id="filtersClear" class="btn">Vymazat v≈°e</button>
        <button id="filtersApply" class="btn primary">Pou≈æ√≠t</button>
      </div>
    </div>

    <div id="loader" class="loader">Naƒç√≠t√°m u≈æivatele...</div>
    <div id="userList" class="cards"></div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
    }

    window.addEventListener('DOMContentLoaded', () => {
      const themeToggle = document.getElementById('themeToggle');
      const toast = document.getElementById('toast');
      const icon = document.getElementById('themeIcon');

      function updateThemeUI(isDark) {
        document.body.classList.toggle('dark', isDark);
        icon.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        toast.textContent = isDark ? 'Tmav√Ω m√≥d zapnut' : 'Svƒõtl√Ω m√≥d zapnut';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
      }

      if (localStorage.getItem('theme') === 'dark') updateThemeUI(true);

      themeToggle.addEventListener('click', () => {
        const isDark = !document.body.classList.contains('dark');
        updateThemeUI(isDark);
      });

      document.getElementById("hamburger").addEventListener("click", () => {
        document.getElementById("navLinks").classList.toggle("active");
      });
    });
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
      authDomain: "cztrainers-dat1.firebaseapp.com",
      databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cztrainers-dat1",
      storageBucket: "cztrainers-dat1.appspot.com",
      messagingSenderId: "369200533487",
      appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };

    // Cloudinary thumb helper
    const CLOUD_NAME = "dkt3pdcbe";
    const clThumb = (uid) =>
      `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/c_fill,w_320,h_320,q_auto,f_auto/users/${uid}/pfp`;

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const registerBtn = document.getElementById("registerBtn");
    const loginBtn = document.getElementById("loginBtn");
    const profileBtn = document.getElementById("profileBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    onAuthStateChanged(auth, (user) => {
      if (user && user.emailVerified) {
        registerBtn.style.display = "none";
        loginBtn.style.display = "none";
        profileBtn.style.display = "inline-block";
        logoutBtn.style.display = "inline-block";
      } else {
        registerBtn.style.display = "inline-block";
        loginBtn.style.display = "inline-block";
        profileBtn.style.display = "none";
        logoutBtn.style.display = "none";
      }
    });

    logoutBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      signOut(auth).then(() => window.location.reload());
    });

    // --- DOM hooks ---
    const userList = document.getElementById("userList");
    const searchInput = document.getElementById("search");
    const loader = document.getElementById("loader");

    const filtersToggle = document.getElementById("filtersToggle");
    const filtersPanel  = document.getElementById("filtersPanel");
    const chipsWrap     = document.getElementById("activeChips");

    const boxLocations = document.getElementById("f-locations");
    const boxSpecs     = document.getElementById("f-specs");
    const boxLangs     = document.getElementById("f-langs");
    const boxGenders   = document.getElementById("f-genders");
    const expMinInput  = document.getElementById("f-exp-min");
    const expMaxInput  = document.getElementById("f-exp-max");
    const expHint      = document.getElementById("f-exp-hint");

    const btnApply = document.getElementById("filtersApply");
    const btnClear = document.getElementById("filtersClear");

    // --- state ---
    let allUsers = [];     // [ [uid, user], ... ]
    let facets   = null;   // {locations:Set, specs:Set, langs:Set, genders:Set, expMin, expMax}

    // --- UI: filters panel toggle ---
    filtersToggle.addEventListener("click", () => {
      filtersPanel.classList.toggle("open");
    });

    // --- helpers ---
    const uniqPush = (set, val) => { if (val && String(val).trim()) set.add(String(val).trim()); };

    function buildFacets(users){
      const locations = new Set();
      const specs     = new Set();
      const langs     = new Set();
      const genders   = new Set();

      let expMin = Infinity, expMax = -Infinity;

      users.forEach(([_, u]) => {
        uniqPush(locations, u.location);
        uniqPush(genders,   u.gender);

        const sArr = Array.isArray(u.specializations) ? u.specializations :
          (typeof u.specializations === 'string' ? u.specializations.split(',').map(s=>s.trim()) : []);
        sArr.forEach(v => uniqPush(specs, v));

        const lArr = Array.isArray(u.languages) ? u.languages :
          (typeof u.languages === 'string' ? u.languages.split(',').map(s=>s.trim()) : []);
        lArr.forEach(v => uniqPush(langs, v));

        const e = Number(u.experience || 0);
        if (Number.isFinite(e)) {
          expMin = Math.min(expMin, e);
          expMax = Math.max(expMax, e);
        }
      });

      if (!Number.isFinite(expMin)) expMin = 0;
      if (!Number.isFinite(expMax)) expMax = 0;

      return { locations, specs, langs, genders, expMin, expMax };
    }

    function checkboxList(container, name, values){
      const arr = [...values].sort((a,b)=>a.localeCompare(b,'cs'));
      container.innerHTML = arr.map(v => `
        <label style="display:block; margin:.25rem 0;">
          <input type="checkbox" name="${name}" value="${v}"> ${v}
        </label>
      `).join("") || "<span class='small'>≈Ω√°dn√© polo≈æky</span>";
    }

    function populateFilters(){
      checkboxList(boxLocations, "loc",    facets.locations);
      checkboxList(boxSpecs,     "spec",   facets.specs);
      checkboxList(boxLangs,     "lang",   facets.langs);
      checkboxList(boxGenders,   "gender", facets.genders);

      expMinInput.placeholder = String(facets.expMin);
      expMaxInput.placeholder = String(facets.expMax);
      expHint.textContent = `Rozsah v datech: ${facets.expMin} ‚Äì ${facets.expMax} let`;
    }

    function getFiltersFromUI(){
      const checked = (sel) => [...document.querySelectorAll(sel+':checked')].map(i=>i.value);

      const f = {
        q: searchInput.value.trim().toLowerCase(),
        loc:  checked('input[name="loc"]'),
        spec: checked('input[name="spec"]'),
        lang: checked('input[name="lang"]'),
        gender: checked('input[name="gender"]'),
        expMin: expMinInput.value ? Number(expMinInput.value) : null,
        expMax: expMaxInput.value ? Number(expMaxInput.value) : null,
      };
      return f;
    }

    function applyFilters(users, f){
      const q = f.q;
      let out = users.filter(([_, u]) => {
        // search text
        if (q) {
          const hay = [
            u.name, u.prijmeni, u.bio,
            Array.isArray(u.specializations) ? u.specializations.join(" ") : u.specializations,
            u.location
          ].filter(Boolean).join(" ").toLowerCase();
          if (!hay.includes(q)) return false;
        }

        if (f.loc.length && !f.loc.includes(u.location)) return false;

        if (f.spec.length) {
          const sArr = Array.isArray(u.specializations) ? u.specializations :
            (typeof u.specializations === 'string' ? u.specializations.split(',').map(s=>s.trim()) : []);
          // require ALL selected specs
          if (!f.spec.every(s => sArr.includes(s))) return false;
        }

        if (f.lang.length) {
          const lArr = Array.isArray(u.languages) ? u.languages :
            (typeof u.languages === 'string' ? u.languages.split(',').map(s=>s.trim()) : []);
          // at least ONE language matches
          if (!f.lang.some(l => lArr.includes(l))) return false;
        }

        if (f.gender.length && !f.gender.includes(u.gender)) return false;

        const e = Number(u.experience || 0);
        if (f.expMin != null && e < f.expMin) return false;
        if (f.expMax != null && e > f.expMax) return false;

        return true;
      });

      return out;
    }

    function renderChips(f){
      const chips = [];
      const add = (label, value, clearKey, clearVal) => {
        chips.push(`<span class="chip">${label}: ${value} <button data-k="${clearKey}" data-v="${encodeURIComponent(clearVal || '')}">√ó</button></span>`);
      };

      if (f.q) add("Hledat", f.q, "q");
      f.loc.forEach(v => add("Lokalita", v, "loc", v));
      f.spec.forEach(v => add("Specializace", v, "spec", v));
      f.lang.forEach(v => add("Jazyk", v, "lang", v));
      f.gender.forEach(v => add("Pohlav√≠", v, "gender", v));
      if (f.expMin != null) add("Zku≈°enost ‚â•", f.expMin, "expMin");
      if (f.expMax != null) add("Zku≈°enost ‚â§", f.expMax, "expMax");

      chipsWrap.innerHTML = chips.join("") || "";
      chipsWrap.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const k = btn.dataset.k;
          const v = decodeURIComponent(btn.dataset.v||"");
          clearOneFilter(k, v);
          doFilter(); // reapply
        });
      });
    }

    function clearOneFilter(key, value){
      switch (key) {
        case "q": searchInput.value = ""; break;
        case "loc":
        case "spec":
        case "lang":
        case "gender": {
          const name = key === "loc" ? "loc" : key;
          const selector = `input[name="${name}"][value="${CSS.escape(value)}"]`;
          const el = document.querySelector(selector);
          if (el) el.checked = false;
          break;
        }
        case "expMin": expMinInput.value = ""; break;
        case "expMax": expMaxInput.value = ""; break;
      }
    }

    function clearAllFilters(){
      searchInput.value = "";
      expMinInput.value = "";
      expMaxInput.value = "";
      document.querySelectorAll('#filtersPanel input[type="checkbox"]').forEach(cb => cb.checked = false);
      doFilter();
    }

    // --- rendering users ---
    function renderUsers(users) {
      userList.innerHTML = "";
      if (!users.length) {
        userList.innerHTML = "<p>≈Ω√°dn√≠ u≈æivatel√© nebyli nalezeni.</p>";
        return;
      }

      users.forEach(([id, user]) => {
        const photoURL =
          (typeof user.profilePicture === "string" && user.profilePicture.startsWith("http"))
            ? user.profilePicture
            : clThumb(id);

        const name = user.name?.trim() || "Nezn√°m√Ω";
        const lastName = user.prijmeni?.trim() || "";

        const card = document.createElement("a");
        card.className = "card";
        card.href = `profile.html?id=${id}`;
        card.innerHTML = `
          <img class="profile-pic"
               src="${photoURL}"
               alt="Profilov√Ω obr√°zek"
               onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=Profil';">
          <div class="card-info">
            <h3>${name} ${lastName}</h3>
            <p><strong>Zku≈°enosti:</strong> ${user.experience || "-"} let</p>
            <p><strong>Specializace:</strong> ${
                Array.isArray(user.specializations)
                  ? user.specializations.join(", ")
                  : (user.specializations || "-")
              }</p>
            <p><strong>Lokalita:</strong> ${user.location || "-"}</p>
          </div>
        `;
        userList.appendChild(card);
      });
    }

    // --- filter execution ---
    const doFilter = (() => {
      let t;
      return function trigger(){
        clearTimeout(t);
        t = setTimeout(() => {
          const f = getFiltersFromUI();
          renderChips(f);
          const list = applyFilters(allUsers, f);
          renderUsers(list);
        }, 150); // debounce
      };
    })();

    // --- wire up apply/clear + search ---
    btnApply.addEventListener("click", () => { doFilter(); filtersPanel.classList.remove("open"); });
    btnClear.addEventListener("click", clearAllFilters);
    searchInput.addEventListener("input", doFilter);
    // Also respond to any checkbox/number change immediately:
    filtersPanel.addEventListener("change", (e) => {
      if (e.target.matches('input[type="checkbox"], input[type="number"]')) doFilter();
    });

    // --- load trainers ---
    const usersRef = ref(db, "users/");
    onValue(usersRef, (snapshot) => {
      loader.style.display = "none";
      const data = snapshot.val() || {};
      allUsers = Object.entries(data).filter(([_, user]) => user.email);

      facets = buildFacets(allUsers);
      populateFilters();

      // initial render
      doFilter();
      console.log("Loaded users:", data);
    });
  </script>
</body>
</html>
