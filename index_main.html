<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZTRAINERS</title>

  <!-- Fonts + global stylesheet -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="style_main.css" />
  <link rel="stylesheet" href="navbar.css">
</head>
<body>
<!-- Navbar (isolated) -->
  <nav class="cznav" aria-label="Hlavní navigace">
    <div class="cznav__logo">
      <a href="index_main.html">
        <img src="CZtrainers new better.png" alt="CZTRAINERS Logo" />
      </a>
    </div>

    <!-- Right cluster: profile pill + theme + burger -->
    <div class="cznav__right">
      <a id="profilePill" class="cznav__pill" href="register.html" aria-label="Přihlásit / registrace">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M6 20a6 6 0 0112 0"></path>
        </svg>
        <span id="pillText">Login</span>
      </a>

      <button id="themeToggle" class="cznav__theme" type="button" aria-label="Přepnout motiv">
        <span id="themeIcon">☀️</span>
      </button>

      <button id="hamburger" class="cznav__hamburger" type="button" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <!-- Dropdown -->
    <div id="navLinks" class="cznav__menu" role="menu" aria-label="Navigace">
      <a href="o-nas.html" class="cznav__link">O nás</a>
      <a href="login.html" class="cznav__link" id="loginBtn">Přihlášení</a>
      <a href="#" class="cznav__link" id="logoutBtn" style="display:none">Odhlásit se</a>
    </div>
  </nav>

  <!-- PAGE CONTENT -->
  <div class="container">
    <h1>PROFESIONÁLNÍ TRENÉŘI V ČESKÉ REPUBLICE</h1>

    <!-- Toolbar: search + filters button + active chips -->
    <div class="toolbar">
      <div class="search-wrap">
        <input type="text" id="search" placeholder="Hledat jméno..." />
        <button id="filtersToggle" type="button" class="filters-toggle">Filtry</button>
      </div>
      <div id="activeChips" class="chips"></div>
    </div>

    <!-- Filters panel -->
    <div id="filtersPanel" class="filters-panel" hidden>
      <div class="filters-grid">
        <fieldset>
          <legend>Lokalita</legend>
          <div id="f-locations"></div>
        </fieldset>
        <fieldset>
          <legend>Specializace</legend>
          <div id="f-specs">Načítám…</div>
        </fieldset>
        <fieldset>
          <legend>Jazyky</legend>
          <div id="f-langs">Načítám…</div>
        </fieldset>
        <fieldset>
          <legend>Pohlaví</legend>
          <div id="f-genders">Načítám…</div>
        </fieldset>
        <fieldset>
          <legend>Zkušenosti (roky)</legend>
          <div class="number-row">
            <input type="number" id="f-exp-min" min="0" placeholder="Min" />
            <input type="number" id="f-exp-max" min="0" placeholder="Max" />
          </div>
          <div id="f-exp-hint" class="small"></div>
        </fieldset>
      </div>
      <div class="filters-actions">
        <button id="filtersClear" class="btn">Vymazat vše</button>
        <button id="filtersApply" class="btn primary">Použít</button>
      </div>
    </div>

    <div id="loader" class="loader">Načítám uživatele...</div>
    <div id="userList" class="cards"></div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Shared navbar logic for ALL pages -->
  <script type="module" src="auth-navbar.js"></script>

  <!-- Page-specific logic (trainers list + filters) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
      authDomain: "cztrainers-dat1.firebaseapp.com",
      databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cztrainers-dat1",
      storageBucket: "cztrainers-dat1.appspot.com",
      messagingSenderId: "369200533487",
      appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };

    // Safe initialize
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Cloudinary thumb helper
    const CLOUD_NAME = "dkt3pdcbe";
    function clThumb(uid) {
      return `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/c_fill,w_320,h_320,q_auto,f_auto/users/${uid}/pfp`;
    }

    // DOM
    const userList      = document.getElementById("userList");
    const searchInput   = document.getElementById("search");
    const loader        = document.getElementById("loader");
    const filtersToggle = document.getElementById("filtersToggle");
    const filtersPanel  = document.getElementById("filtersPanel");
    const chipsWrap     = document.getElementById("activeChips");

    const boxLocations = document.getElementById("f-locations");
    const boxSpecs     = document.getElementById("f-specs");
    const boxLangs     = document.getElementById("f-langs");
    const boxGenders   = document.getElementById("f-genders");
    const expMinInput  = document.getElementById("f-exp-min");
    const expMaxInput  = document.getElementById("f-exp-max");
    const expHint      = document.getElementById("f-exp-hint");

    const btnApply = document.getElementById("filtersApply");
    const btnClear = document.getElementById("filtersClear");

    // State
    let allUsers = []; // [ [uid, user], ... ]
    let facets   = null;

    // Toggle filters panel
    filtersToggle.addEventListener("click", () => {
    const isHidden = filtersPanel.hasAttribute("hidden");
    if (isHidden) {
      // show
      filtersPanel.removeAttribute("hidden");
      filtersPanel.classList.add("open");
    } else {
      // hide
      filtersPanel.setAttribute("hidden", "");
      filtersPanel.classList.remove("open");
    }
  });

    // Helpers
    const uniqPush = (set, val) => { if (val && String(val).trim()) set.add(String(val).trim()); };

    function buildFacets(users){
      const locations = new Set(), specs = new Set(), langs = new Set(), genders = new Set();
      let expMin = Infinity, expMax = -Infinity;

      users.forEach(([_, u]) => {
        uniqPush(locations, u.location);
        uniqPush(genders,   u.gender);

        const sArr = Array.isArray(u.specializations) ? u.specializations :
          (typeof u.specializations === 'string' ? u.specializations.split(',').map(s=>s.trim()) : []);
        sArr.forEach(v => uniqPush(specs, v));

        const lArr = Array.isArray(u.languages) ? u.languages :
          (typeof u.languages === 'string' ? u.languages.split(',').map(s=>s.trim()) : []);
        lArr.forEach(v => uniqPush(langs, v));

        const e = Number(u.experience || 0);
        if (Number.isFinite(e)) { expMin = Math.min(expMin, e); expMax = Math.max(expMax, e); }
      });

      if (!Number.isFinite(expMin)) expMin = 0;
      if (!Number.isFinite(expMax)) expMax = 0;
      return { locations, specs, langs, genders, expMin, expMax };
    }

    function checkboxList(container, name, values){
      const arr = [...values].sort((a,b)=>a.localeCompare(b,'cs'));
      container.innerHTML = arr.map(v => `
        <label style="display:block; margin:.25rem 0;">
          <input type="checkbox" name="${name}" value="${v}"> ${v}
        </label>
      `).join("") || "<span class='small'>Žádné položky</span>";
    }

    function populateFilters(){
      checkboxList(boxLocations, "loc",    facets.locations);
      checkboxList(boxSpecs,     "spec",   facets.specs);
      checkboxList(boxLangs,     "lang",   facets.langs);
      checkboxList(boxGenders,   "gender", facets.genders);

      expMinInput.placeholder = String(facets.expMin);
      expMaxInput.placeholder = String(facets.expMax);
      expHint.textContent     = `Rozsah v datech: ${facets.expMin} – ${facets.expMax} let`;
    }

    function getFiltersFromUI(){
      const checked = (sel) => [...document.querySelectorAll(sel+':checked')].map(i=>i.value);
      return {
        q:      searchInput.value.trim().toLowerCase(),
        loc:    checked('input[name="loc"]'),
        spec:   checked('input[name="spec"]'),
        lang:   checked('input[name="lang"]'),
        gender: checked('input[name="gender"]'),
        expMin: expMinInput.value ? Number(expMinInput.value) : null,
        expMax: expMaxInput.value ? Number(expMaxInput.value) : null,
      };
    }

    function applyFilters(users, f){
      const q = f.q;
      return users.filter(([_, u]) => {
        if (q) {
          const hay = [
            u.name, u.prijmeni, u.bio,
            Array.isArray(u.specializations) ? u.specializations.join(" ") : u.specializations,
            u.location
          ].filter(Boolean).join(" ").toLowerCase();
          if (!hay.includes(q)) return false;
        }

        if (f.loc.length && !f.loc.includes(u.location)) return false;

        if (f.spec.length) {
          const sArr = Array.isArray(u.specializations) ? u.specializations :
            (typeof u.specializations === 'string' ? u.specializations.split(',').map(s=>s.trim()) : []);
          if (!f.spec.every(s => sArr.includes(s))) return false; // require ALL selected specs
        }

        if (f.lang.length) {
          const lArr = Array.isArray(u.languages) ? u.languages :
            (typeof u.languages === 'string' ? u.languages.split(',').map(s=>s.trim()) : []);
          if (!f.lang.some(l => lArr.includes(l))) return false; // at least ONE language
        }

        if (f.gender.length && !f.gender.includes(u.gender)) return false;

        const e = Number(u.experience || 0);
        if (f.expMin != null && e < f.expMin) return false;
        if (f.expMax != null && e > f.expMax) return false;

        return true;
      });
    }

    function renderChips(f){
      const chips = [];
      const add = (label, value, clearKey, clearVal) => {
        chips.push(`<span class="chip">${label}: ${value} <button data-k="${clearKey}" data-v="${encodeURIComponent(clearVal || '')}">×</button></span>`);
      };

      if (f.q) add("Hledat", f.q, "q");
      f.loc.forEach(v => add("Lokalita", v, "loc", v));
      f.spec.forEach(v => add("Specializace", v, "spec", v));
      f.lang.forEach(v => add("Jazyk", v, "lang", v));
      f.gender.forEach(v => add("Pohlaví", v, "gender", v));
      if (f.expMin != null) add("Zkušenost ≥", f.expMin, "expMin");
      if (f.expMax != null) add("Zkušenost ≤", f.expMax, "expMax");

      chipsWrap.innerHTML = chips.join("") || "";
      chipsWrap.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const k = btn.dataset.k;
          const v = decodeURIComponent(btn.dataset.v||"");
          switch (k) {
            case "q": searchInput.value = ""; break;
            case "expMin": expMinInput.value = ""; break;
            case "expMax": expMaxInput.value = ""; break;
            default: {
              const selector = `input[name="${k}"][value="${CSS.escape(v)}"]`;
              const el = document.querySelector(selector);
              if (el) el.checked = false;
            }
          }
          doFilter();
        });
      });
    }

    function safeProfileUrl(id) {
      if (!/^[A-Za-z0-9_-]+$/.test(id)) return null;
      return `profile.html?id=${encodeURIComponent(id)}`;
    }

  function renderUsers(users) {
    userList.innerHTML = "";
    if (!users.length) {
      userList.innerHTML = "<p>Žádní uživatelé nebyli nalezeni.</p>";
      return;
    }

    const accentOf = (specsArr) => {
      const s = (specsArr[0] || "").toLowerCase();
      if (s.includes("silov")) return "strength";
      if (s.includes("jóga")) return "yoga";
      if (s.includes("rehab")) return "rehab";
      if (s.includes("výživ") || s.includes("nutri")) return "nutrition";
      return "fit"; // default blue
    };

    users.forEach(([id, user]) => {
      const href = safeProfileUrl(id);
      if (!href) return;

      const photoURL =
        (typeof user.profilePicture === "string" && user.profilePicture.startsWith("http"))
          ? user.profilePicture
          : clThumb(id);

      const name = (user.name || "").trim() || "Neznámý";
      const lastName = (user.prijmeni || "").trim();

      const specs = Array.isArray(user.specializations)
        ? user.specializations
        : (typeof user.specializations === "string"
            ? user.specializations.split(",").map(s => s.trim()).filter(Boolean)
            : []);

      const show = specs.slice(0, 3);
      const moreCount = Math.max(0, specs.length - show.length);

      const accent = accentOf(show);

      const card = document.createElement("a");
      card.className = "trainer-card";
      card.href = href;
      card.setAttribute("data-accent", accent);

      card.innerHTML = `
        <div class="card-header"></div>

        <div class="avatar-wrap">
          <img class="avatar"
              src="${photoURL}"
              alt="Profilový obrázek"
              onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=Profil';">
        </div>

        <div class="card-body">
          <h3 class="name">${name} ${lastName}</h3>
          <div class="meta">
            <span>📍 ${user.location || "-"}</span>
            <span class="sep">•</span>
            <span>🧠 ${user.experience ?? "-"} let praxe</span>
          </div>

          <div class="tags">
            ${show.map(t => `<span class="tag">${t}</span>`).join("")}
            ${moreCount ? `<span class="tag tag-more">+${moreCount}</span>` : ""}
          </div>
        </div>
      `;

      userList.appendChild(card);
    });
  }

    const doFilter = (() => {
      let t;
      return function trigger(){
        clearTimeout(t);
        t = setTimeout(() => {
          const f = getFiltersFromUI();
          renderChips(f);
          renderUsers(applyFilters(allUsers, f));
        }, 150);
      };
    })();

    btnApply.addEventListener("click", () => {
      doFilter();
      filtersPanel.setAttribute("hidden", "");
    });
    btnClear.addEventListener("click", () => {
      searchInput.value = "";
      expMinInput.value = "";
      expMaxInput.value = "";
      document.querySelectorAll('#filtersPanel input[type="checkbox"]').forEach(cb => (cb.checked = false));
      doFilter();
    });
    searchInput.addEventListener("input", doFilter);
    filtersPanel.addEventListener("change", (e) => {
      if (e.target.matches('input[type="checkbox"], input[type="number"]')) doFilter();
    });

    // Load trainers
    onValue(ref(db, "users/"), (snapshot) => {
      loader.style.display = "none";
      const data = snapshot.val() || {};
      allUsers = Object.entries(data).filter(([_, user]) => user && user.email);
      facets = buildFacets(allUsers);
      populateFilters();
      doFilter();
    });
  </script>
</body>
</html>
