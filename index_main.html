<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZTRAINERS</title>

  <!-- Fonts + global stylesheet -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="style_main.css" />
  <link rel="stylesheet" href="navbar.css">
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css">
</head>
<body>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <!-- Navbar (isolated) -->
  <nav class="cznav" aria-label="Hlavn√≠ navigace">
    <div class="cznav__logo">
      <a href="index_main.html">
        <img src="CZtrainers new better.png" alt="CZTRAINERS Logo" />
      </a>
    </div>

    <!-- Right cluster: profile pill + theme + burger -->
    <div class="cznav__right">
      <a id="profilePill" class="cznav__pill" href="register.html" aria-label="P≈ôihl√°sit / registrace">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
          <circle cx="12" cy="8" r="4"></circle>
          <path d="M6 20a6 6 0 0112 0"></path>
        </svg>
        <span id="pillText">Login</span>
      </a>

      <button id="themeToggle" class="cznav__theme" type="button" aria-label="P≈ôepnout motiv">
        <span id="themeIcon">‚òÄÔ∏è</span>
      </button>

      <button id="hamburger" class="cznav__hamburger" type="button" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>

    <!-- Dropdown -->
    <div id="navLinks" class="cznav__menu" role="menu" aria-label="Navigace">
      <a href="index_main.html" class="cznav__link">Dom≈Ø</a>
      <a href="o-nas.html" class="cznav__link">O n√°s</a>
      <a href="login.html" class="cznav__link" id="loginBtn">P≈ôihl√°≈°en√≠</a>
      <a href="#" class="cznav__link" id="logoutBtn" style="display:none">Odhl√°sit se</a>
    </div>
  </nav>
  <script type="module" src="auth-navbar.js"></script>
  
  <!-- PAGE CONTENT -->
  <div class="container">
    <h1 data-aos="zoom-in-up">PROFESION√ÅLN√ç TREN√â≈òI V ƒåESK√â REPUBLICE</h1>

    <!-- Toolbar: search + filters button + active chips -->
    <div class="toolbar">
      <div class="search-wrap">
        <input type="text" id="search" placeholder="Hledat jm√©no..." />
        <button id="filtersToggle" type="button" class="filters-toggle">Filtry</button>
      </div>
      <div id="activeChips" class="chips"></div>
    </div>

    <!-- Filters panel -->
    <div id="filtersPanel" class="filters-panel" hidden>
      <div class="filters-grid">
        <fieldset>
          <legend>Lokalita</legend>
          <div id="f-locations"></div>
        </fieldset>
        <fieldset>
          <legend>Specializace</legend>
          <div id="f-specs">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Jazyky</legend>
          <div id="f-langs">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Pohlav√≠</legend>
          <div id="f-genders">Naƒç√≠t√°m‚Ä¶</div>
        </fieldset>
        <fieldset>
          <legend>Zku≈°enosti (roky)</legend>
          <div class="number-row">
            <input type="number" id="f-exp-min" min="0" placeholder="Min" />
            <input type="number" id="f-exp-max" min="0" placeholder="Max" />
          </div>
          <div id="f-exp-hint" class="small"></div>
        </fieldset>
        <fieldset>
          <legend>Obl√≠ben√≠</legend>
          <label style="display:block; margin:.25rem 0;">
            <input type="checkbox" id="f-only-favs"> Moji obl√≠ben√≠
          </label>
        </fieldset>

        <fieldset>
          <legend>≈òazen√≠</legend>
          <select id="f-sort" style="width:100%; height:40px; border-radius:10px; border:1px solid #e5e7eb; padding:0 .6rem;">
            <option value="default">V√Ωchoz√≠</option>
            <option value="popular">Nejobl√≠benƒõj≈°√≠</option>
          </select>
        </fieldset>
      </div>
      <div class="filters-actions">
        <button id="filtersClear" class="btn">Vymazat v≈°e</button>
        <button id="filtersApply" class="btn primary">Pou≈æ√≠t</button>
      </div>
    </div>

    <div id="loader" class="loader">Naƒç√≠t√°m u≈æivatele...</div>
    <div id="userList" class="cards"></div>
  </div>

  <div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getDatabase, ref, onValue, set, remove, runTransaction
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  // --- Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
    authDomain: "cztrainers-dat1.firebaseapp.com",
    databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "cztrainers-dat1",
    storageBucket: "cztrainers-dat1.appspot.com",
    messagingSenderId: "369200533487",
    appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
  };
  const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const auth = getAuth(app);

  // --- Cloudinary thumb helper ---
  const CLOUD_NAME = "dkt3pdcbe";
  const clThumb = (uid) => `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/c_fill,w_320,h_320,q_auto,f_auto/users/${uid}/pfp`;

  // --- DOM ---
  const userList      = document.getElementById("userList");
  const searchInput   = document.getElementById("search");
  const loader        = document.getElementById("loader");
  const filtersToggle = document.getElementById("filtersToggle");
  const filtersPanel  = document.getElementById("filtersPanel");
  const chipsWrap     = document.getElementById("activeChips");

  const boxLocations = document.getElementById("f-locations");
  const boxSpecs     = document.getElementById("f-specs");
  const boxLangs     = document.getElementById("f-langs");
  const boxGenders   = document.getElementById("f-genders");
  const expMinInput  = document.getElementById("f-exp-min");
  const expMaxInput  = document.getElementById("f-exp-max");
  const expHint      = document.getElementById("f-exp-hint");

  const onlyFavsCheckbox = document.getElementById("f-only-favs");
  const sortSelect       = document.getElementById("f-sort");

  const btnApply = document.getElementById("filtersApply");
  const btnClear = document.getElementById("filtersClear");

  const toastEl = document.getElementById("toast");
  const toast = (msg) => {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 1800);
  };

  // --- State ---
  let allUsers = [];                 // [ [uid, user], ... ]
  let facets   = null;
  let me = null;                     // current auth user
  let myFavSet = new Set();          // trainer UIDs I favorited
  let favCounts = {};                // { trainerUid: number }

  // toggle filters panel
  filtersToggle.addEventListener("click", () => {
    const isHidden = filtersPanel.hasAttribute("hidden");
    if (isHidden) { filtersPanel.removeAttribute("hidden"); filtersPanel.classList.add("open"); }
    else { filtersPanel.setAttribute("hidden",""); filtersPanel.classList.remove("open"); }
  });

  // --- Facets helpers ---
  const uniqPush = (set, val) => { if (val && String(val).trim()) set.add(String(val).trim()); };

  function buildFacets(users){
    const locations = new Set(), specs = new Set(), langs = new Set(), genders = new Set();
    let expMin = Infinity, expMax = -Infinity;

    users.forEach(([_, u]) => {
      uniqPush(locations, u.location);
      uniqPush(genders,   u.gender);

      const sArr = Array.isArray(u.specializations) ? u.specializations :
        (typeof u.specializations === 'string' ? u.specializations.split(',').map(s=>s.trim()) : []);
      sArr.forEach(v => uniqPush(specs, v));

      const lArr = Array.isArray(u.languages) ? u.languages :
        (typeof u.languages === 'string' ? u.languages.split(',').map(s=>s.trim()) : []);
      lArr.forEach(v => uniqPush(langs, v));

      const e = Number(u.experience || 0);
      if (Number.isFinite(e)) { expMin = Math.min(expMin, e); expMax = Math.max(expMax, e); }
    });

    if (!Number.isFinite(expMin)) expMin = 0;
    if (!Number.isFinite(expMax)) expMax = 0;
    return { locations, specs, langs, genders, expMin, expMax };
  }

  function checkboxList(container, name, values){
    const arr = [...values].sort((a,b)=>a.localeCompare(b,'cs'));
    container.innerHTML = arr.map(v => `
      <label style="display:block; margin:.25rem 0;">
        <input type="checkbox" name="${name}" value="${v}"> ${v}
      </label>
    `).join("") || "<span class='small'>≈Ω√°dn√© polo≈æky</span>";
  }

  function populateFilters(){
    checkboxList(boxLocations, "loc",    facets.locations);
    checkboxList(boxSpecs,     "spec",   facets.specs);
    checkboxList(boxLangs,     "lang",   facets.langs);
    checkboxList(boxGenders,   "gender", facets.genders);

    expMinInput.placeholder = String(facets.expMin);
    expMaxInput.placeholder = String(facets.expMax);
    expHint.textContent     = `Rozsah v datech: ${facets.expMin} ‚Äì ${facets.expMax} let`;
  }

  // --- Filters ---
  function getFiltersFromUI(){
    const checked = (sel) => [...document.querySelectorAll(sel+':checked')].map(i=>i.value);
    return {
      q:      searchInput.value.trim().toLowerCase(),
      loc:    checked('input[name="loc"]'),
      spec:   checked('input[name="spec"]'),
      lang:   checked('input[name="lang"]'),
      gender: checked('input[name="gender"]'),
      expMin: expMinInput.value ? Number(expMinInput.value) : null,
      expMax: expMaxInput.value ? Number(expMaxInput.value) : null,
      onlyFavs: !!onlyFavsCheckbox?.checked,
      sort: sortSelect?.value || "default",
    };
  }

  function applyFilters(users, f){
    const q = f.q;
    let out = users.filter(([id, u]) => {
      if (q) {
        const hay = [
          u.name, u.prijmeni, u.bio,
          Array.isArray(u.specializations) ? u.specializations.join(" ") : u.specializations,
          u.location
        ].filter(Boolean).join(" ").toLowerCase();
        if (!hay.includes(q)) return false;
      }
      if (f.loc.length && !f.loc.includes(u.location)) return false;

      if (f.spec.length) {
        const sArr = Array.isArray(u.specializations) ? u.specializations :
          (typeof u.specializations === 'string' ? u.specializations.split(',').map(s=>s.trim()) : []);
        if (!f.spec.every(s => sArr.includes(s))) return false;
      }

      if (f.lang.length) {
        const lArr = Array.isArray(u.languages) ? u.languages :
          (typeof u.languages === 'string' ? u.languages.split(',').map(s=>s.trim()) : []);
        if (!f.lang.some(l => lArr.includes(l))) return false;
      }

      if (f.gender.length && !f.gender.includes(u.gender)) return false;

      const e = Number(u.experience || 0);
      if (f.expMin != null && e < f.expMin) return false;
      if (f.expMax != null && e > f.expMax) return false;

      // NEW: Only my favorites
      if (f.onlyFavs && me) {
        if (!myFavSet.has(id)) return false;
      } else if (f.onlyFavs && !me) {
        // if user is not signed in and tries to filter onlyFavs, show none
        return false;
      }

      return true;
    });

    // NEW: sorting
    if (f.sort === "popular") {
      out.sort((a,b) => (favCounts[b[0]] || 0) - (favCounts[a[0]] || 0));
    }

    return out;
  }

  function renderChips(f){
    const chips = [];
    const add = (label, value, clearKey, clearVal) => {
      chips.push(`<span class="chip">${label}: ${value} <button data-k="${clearKey}" data-v="${encodeURIComponent(clearVal || '')}">√ó</button></span>`);
    };

    if (f.q) add("Hledat", f.q, "q");
    f.loc.forEach(v => add("Lokalita", v, "loc", v));
    f.spec.forEach(v => add("Specializace", v, "spec", v));
    f.lang.forEach(v => add("Jazyk", v, "lang", v));
    f.gender.forEach(v => add("Pohlav√≠", v, "gender", v));
    if (f.expMin != null) add("Zku≈°enost ‚â•", f.expMin, "expMin");
    if (f.expMax != null) add("Zku≈°enost ‚â§", f.expMax, "expMax");
    if (f.onlyFavs) add("Filtr", "Moji obl√≠ben√≠", "onlyFavs");

    chipsWrap.innerHTML = chips.join("") || "";
    chipsWrap.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        const k = btn.dataset.k;
        const v = decodeURIComponent(btn.dataset.v||"");
        switch (k) {
          case "q": searchInput.value = ""; break;
          case "expMin": expMinInput.value = ""; break;
          case "expMax": expMaxInput.value = ""; break;
          case "onlyFavs": if (onlyFavsCheckbox) onlyFavsCheckbox.checked = false; break;
          default: {
            const selector = `input[name="${k}"][value="${CSS.escape(v)}"]`;
            const el = document.querySelector(selector);
            if (el) el.checked = false;
          }
        }
        doFilter();
      });
    });
  }

  function safeProfileUrl(id) {
    if (!/^[A-Za-z0-9_-]+$/.test(id)) return null;
    return `profile.html?id=${encodeURIComponent(id)}`;
  }

  // --- Rendering cards (now with the heart) ---
  function renderUsers(users) {
    userList.innerHTML = "";
    if (!users.length) {
      userList.innerHTML = "<p>≈Ω√°dn√≠ u≈æivatel√© nebyli nalezeni.</p>";
      return;
    }

    const accentOf = (specsArr) => {
      const s = (specsArr[0] || "").toLowerCase();
      if (s.includes("silov")) return "strength";
      if (s.includes("j√≥ga")) return "yoga";
      if (s.includes("rehab")) return "rehab";
      if (s.includes("v√Ω≈æiv") || s.includes("nutri")) return "nutrition";
      return "fit";
    };

    users.forEach(([id, user]) => {
      const href = safeProfileUrl(id);
      if (!href) return;

      const photoURL =
        (typeof user.profilePicture === "string" && user.profilePicture.startsWith("http"))
          ? user.profilePicture
          : clThumb(id);

      const name = (user.name || "").trim() || "Nezn√°m√Ω";
      const lastName = (user.prijmeni || "").trim();

      const specs = Array.isArray(user.specializations)
        ? user.specializations
        : (typeof user.specializations === "string"
            ? user.specializations.split(",").map(s => s.trim()).filter(Boolean)
            : []);

      const show = specs.slice(0, 3);
      const moreCount = Math.max(0, specs.length - show.length);
      const accent = accentOf(show);

      const count = favCounts[id] || 0;
      const isMine = me && me.uid === id;
      const favOn = myFavSet.has(id);

      const card = document.createElement("a");
      card.className = "trainer-card";
      card.href = href;
      card.setAttribute("data-accent", accent);

      card.innerHTML = `
        <div class="card-header"></div>

        <!-- Heart button -->
        <button class="fav-btn ${favOn ? "on" : ""}" data-id="${id}" ${isMine ? "disabled" : ""} aria-pressed="${favOn}" aria-label="P≈ôidat mezi obl√≠ben√©">
          <span class="heart">${favOn ? "‚ô•" : "‚ô°"}</span>
          <span class="count">${count}</span>
        </button>

        <div class="avatar-wrap">
          <img class="avatar"
              src="${photoURL}"
              alt="Profilov√Ω obr√°zek"
              onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=Profil';">
        </div>

        <div class="card-body">
          <h3 class="name">${name} ${lastName}</h3>
          <div class="meta">
            <span>üìç ${user.location || "-"}</span>
            <span class="sep">‚Ä¢</span>
            <span>üß† ${user.experience ?? "-"} let praxe</span>
          </div>

          <div class="tags">
            ${show.map(t => `<span class="tag">${t}</span>`).join("")}
            ${moreCount ? `<span class="tag tag-more">+${moreCount}</span>` : ""}
          </div>
        </div>
      `;

      userList.appendChild(card);
    });
  }

  // --- Favorite toggling ---
  async function toggleFavorite(trainerId){
    // Gate strangers
    if (!me) {
      toast("Pro ukl√°d√°n√≠ obl√≠ben√Ωch je pot≈ôeba √∫ƒçet.");
      window.location.href = "register.html";
      return;
    }
    if (trainerId === me.uid) return; // cannot favorite yourself

    const favRef  = ref(db, `favoritesByUser/${me.uid}/${trainerId}`);
    const countRef= ref(db, `favoriteCounts/${trainerId}`);
    const already = myFavSet.has(trainerId);

    try {
      if (already) {
        // remove favorite
        await remove(favRef);
        await runTransaction(countRef, (cur) => Math.max(0, (cur || 0) - 1));
        toast("Odebr√°no z obl√≠ben√Ωch");
      } else {
        // add favorite
        await set(favRef, { addedAt: Math.floor(Date.now()/1000) });
        await runTransaction(countRef, (cur) => (cur || 0) + 1);
        toast("P≈ôid√°no do obl√≠ben√Ωch ‚úì");
      }
    } catch (e) {
      alert("Nepoda≈ôilo se zmƒõnit obl√≠ben√©: " + (e?.message || e));
    }
  }

  // --- Delegated click for hearts (stop link nav) ---
  userList.addEventListener("click", (e) => {
    const btn = e.target.closest(".fav-btn");
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();
    const id = btn.getAttribute("data-id");
    if (!id) return;
    toggleFavorite(id);
  });

  // --- Filter reactiveness ---
  const doFilter = (() => {
    let t;
    return function trigger(){
      clearTimeout(t);
      t = setTimeout(() => {
        const f = getFiltersFromUI();
        renderChips(f);
        renderUsers(applyFilters(allUsers, f));
      }, 120);
    };
  })();

  btnApply.addEventListener("click", () => {
    doFilter();
    filtersPanel.setAttribute("hidden", "");
  });
  btnClear.addEventListener("click", () => {
    searchInput.value = "";
    expMinInput.value = "";
    expMaxInput.value = "";
    document.querySelectorAll('#filtersPanel input[type="checkbox"]').forEach(cb => (cb.checked = false));
    if (sortSelect) sortSelect.value = "default";
    doFilter();
  });
  searchInput.addEventListener("input", doFilter);
  filtersPanel.addEventListener("change", (e) => {
    if (e.target.matches('input[type="checkbox"], input[type="number"], select')) doFilter();
  });

  // --- Data subscriptions ---
  // trainers
  onValue(ref(db, "users/"), (snapshot) => {
    loader.style.display = "none";
    const data = snapshot.val() || {};
    allUsers = Object.entries(data).filter(([_, user]) => user && user.email);
    facets = buildFacets(allUsers);
    populateFilters();
    doFilter();
  });

  // counts (public)
  onValue(ref(db, "favoriteCounts"), (snap) => {
    favCounts = snap.val() || {};
    doFilter();
  });

  // auth + my favorites
  onAuthStateChanged(auth, (user) => {
    me = user && user.emailVerified ? user : null;

    if (me) {
      onValue(ref(db, `favoritesByUser/${me.uid}`), (snap) => {
        const m = snap.val() || {};
        myFavSet = new Set(Object.keys(m));
        doFilter();
      });
    } else {
      myFavSet = new Set();
      doFilter();
    }
  });
</script>
</body>
</html>
