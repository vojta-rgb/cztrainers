<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CZTRAINERS</title>

  <!-- Fonts + global stylesheet -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" />
  <link rel="stylesheet" href="style_main.css" />
</head>
<body>
  <!-- NAVBAR (dropdown hamburger; no inline CSS) -->
  <nav class="navbar">
    <a class="nav-logo" href="index_main.html" aria-label="CZTRAINERS">
      <img src="CZtrainers new better.png" alt="CZTRAINERS Logo" />
    </a>

    <div class="nav-right">
      <!-- Hamburger stays fixed; dropdown opens beneath -->
      <button class="hamburger" id="hamburger" aria-label="Menu" aria-expanded="false" aria-controls="navDropdown">
        <span></span><span></span><span></span>
      </button>

      <!-- Dropdown menu (CSS hides by default; navbar.js toggles .open) -->
      <div class="nav-dropdown" id="navDropdown" role="menu">
        <a href="index_main.html" class="nav-button" data-nav>Domů</a>

        <div class="nav-section" id="authPublic">
          <a href="index.html" class="nav-button" id="registerBtn" data-nav>Registrace</a>
          <a href="login.html" class="nav-button" id="loginBtn" data-nav>Přihlášení</a>
        </div>

        <div class="nav-section" id="authPrivate">
          <a href="mujprofil.html" class="nav-button" id="profileBtn" data-nav style="display:none">Můj profil</a>
          <a href="account.html" class="nav-button" id="accountBtn" data-nav style="display:none">Účet &amp; Zabezpečení</a>
          <a href="#" class="nav-button" id="logoutBtn" data-nav style="display:none">Odhlásit se</a>
        </div>

        <a href="o-nas.html" class="nav-button" data-nav>O nás</a>

        <button class="theme-toggle" id="themeToggle" type="button" aria-label="Přepnout motiv">
          <span id="themeIcon">☀️</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- PAGE CONTENT -->
  <div class="container">
    <h1>PROFESIONÁLNÍ TRENÉŘI V ČESKÉ REPUBLICE</h1>

    <!-- Toolbar: search + filters button + active chips -->
    <div class="toolbar">
      <div class="search-wrap">
        <input type="text" id="search" placeholder="Hledat jméno..." />
        <button id="filtersToggle" type="button" class="filters-toggle">Filtry</button>
      </div>
      <div id="activeChips" class="chips"></div>
    </div>

    <!-- Filters panel (kept intact; shown by adding .open) -->
    <div id="filtersPanel" class="filters-panel">
      <div class="filters-grid">
        <fieldset>
          <legend>Lokalita</legend>
          <div id="f-locations"></div>
        </fieldset>

        <fieldset>
          <legend>Specializace</legend>
          <div id="f-specs" class="small">Načítám…</div>
        </fieldset>

        <fieldset>
          <legend>Jazyky</legend>
          <div id="f-langs" class="small">Načítám…</div>
        </fieldset>

        <fieldset>
          <legend>Pohlaví</legend>
          <div id="f-genders" class="small">Načítám…</div>
        </fieldset>

        <fieldset>
          <legend>Zkušenosti (roky)</legend>
          <div class="number-row">
            <input type="number" id="f-exp-min" min="0" placeholder="Min" />
            <input type="number" id="f-exp-max" min="0" placeholder="Max" />
          </div>
          <div id="f-exp-hint" class="small"></div>
        </fieldset>
      </div>

      <div class="filters-actions">
        <button id="filtersClear" class="btn">Vymazat vše</button>
        <button id="filtersApply" class="btn primary">Použít</button>
      </div>
    </div>

    <div id="loader" class="loader">Načítám uživatele...</div>
    <div id="userList" class="cards"></div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Shared navbar logic for ALL pages (dropdown-aware version) -->
  <script type="module" src="auth-navbar.js"></script>

  <!-- Page-specific logic (trainers list + filters) -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    /* ========= Firebase ========= */
    const firebaseConfig = {
      apiKey: "AIzaSyASK2terL9kejt9JTJr944WCFYzRkK8AGU",
      authDomain: "cztrainers-dat1.firebaseapp.com",
      databaseURL: "https://cztrainers-dat1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "cztrainers-dat1",
      storageBucket: "cztrainers-dat1.appspot.com",
      messagingSenderId: "369200533487",
      appId: "1:369200533487:web:eb31707c0de4bda2b8f01a"
    };

    // Safe init alongside navbar.js
    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* ========= Cloudinary helper ========= */
    const CLOUD_NAME = "dkt3pdcbe";
    const clThumb = (uid) =>
      `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/c_fill,w_320,h_320,q_auto,f_auto/users/${uid}/pfp`;

    /* ========= DOM ========= */
    const userList      = document.getElementById("userList");
    const searchInput   = document.getElementById("search");
    const loader        = document.getElementById("loader");
    const filtersToggle = document.getElementById("filtersToggle");
    const filtersPanel  = document.getElementById("filtersPanel");
    const chipsWrap     = document.getElementById("activeChips");

    const boxLocations = document.getElementById("f-locations");
    const boxSpecs     = document.getElementById("f-specs");
    const boxLangs     = document.getElementById("f-langs");
    const boxGenders   = document.getElementById("f-genders");
    const expMinInput  = document.getElementById("f-exp-min");
    const expMaxInput  = document.getElementById("f-exp-max");
    const expHint      = document.getElementById("f-exp-hint");

    const btnApply = document.getElementById("filtersApply");
    const btnClear = document.getElementById("filtersClear");

    /* ========= State ========= */
    let allUsers = [];   // [ [uid, user], ... ]
    let facets   = null; // sets for locations/specs/langs/genders + exp range

    /* ========= Filters panel toggle (class .open) ========= */
    filtersToggle.addEventListener("click", () => {
      filtersPanel.classList.toggle("open");
    });

    /* ========= Helpers ========= */
    const uniqPush = (set, val) => { if (val && String(val).trim()) set.add(String(val).trim()); };

    function buildFacets(users){
      const locations = new Set(), specs = new Set(), langs = new Set(), genders = new Set();
      let expMin = Infinity, expMax = -Infinity;

      users.forEach(([_, u]) => {
        uniqPush(locations, u.location);
        uniqPush(genders,   u.gender);

        const sArr = Array.isArray(u.specializations) ? u.specializations :
          (typeof u.specializations === "string" ? u.specializations.split(",").map(s=>s.trim()) : []);
        sArr.forEach(v => uniqPush(specs, v));

        const lArr = Array.isArray(u.languages) ? u.languages :
          (typeof u.languages === "string" ? u.languages.split(",").map(s=>s.trim()) : []);
        lArr.forEach(v => uniqPush(langs, v));

        const e = Number(u.experience || 0);
        if (Number.isFinite(e)) {
          expMin = Math.min(expMin, e);
          expMax = Math.max(expMax, e);
        }
      });

      if (!Number.isFinite(expMin)) expMin = 0;
      if (!Number.isFinite(expMax)) expMax = 0;
      return { locations, specs, langs, genders, expMin, expMax };
    }

    function checkboxList(container, name, values){
      const arr = [...values].sort((a,b)=>a.localeCompare(b,"cs"));
      container.innerHTML = arr.map(v => `
        <label style="display:block; margin:.25rem 0;">
          <input type="checkbox" name="${name}" value="${v}"> ${v}
        </label>
      `).join("") || "<span class='small'>Žádné položky</span>";
    }

    function populateFilters(){
      checkboxList(boxLocations, "loc",    facets.locations);
      checkboxList(boxSpecs,     "spec",   facets.specs);
      checkboxList(boxLangs,     "lang",   facets.langs);
      checkboxList(boxGenders,   "gender", facets.genders);

      expMinInput.placeholder = String(facets.expMin);
      expMaxInput.placeholder = String(facets.expMax);
      expHint.textContent = `Rozsah v datech: \${facets.expMin} – \${facets.expMax} let`;
    }

    function getFiltersFromUI(){
      const checked = (sel) => [...document.querySelectorAll(sel + ":checked")].map(i => i.value);
      return {
        q:      searchInput.value.trim().toLowerCase(),
        loc:    checked('input[name="loc"]'),
        spec:   checked('input[name="spec"]'),
        lang:   checked('input[name="lang"]'),
        gender: checked('input[name="gender"]'),
        expMin: expMinInput.value ? Number(expMinInput.value) : null,
        expMax: expMaxInput.value ? Number(expMaxInput.value) : null,
      };
    }

    function applyFilters(users, f){
      const q = f.q;
      return users.filter(([_, u]) => {
        // full-text search across a few fields
        if (q) {
          const hay = [
            u.name, u.prijmeni, u.bio,
            Array.isArray(u.specializations) ? u.specializations.join(" ") : u.specializations,
            u.location
          ].filter(Boolean).join(" ").toLowerCase();
          if (!hay.includes(q)) return false;
        }

        if (f.loc.length && !f.loc.includes(u.location)) return false;

        if (f.spec.length) {
          const sArr = Array.isArray(u.specializations) ? u.specializations :
            (typeof u.specializations === "string" ? u.specializations.split(",").map(s=>s.trim()) : []);
          // require ALL selected specs
          if (!f.spec.every(s => sArr.includes(s))) return false;
        }

        if (f.lang.length) {
          const lArr = Array.isArray(u.languages) ? u.languages :
            (typeof u.languages === "string" ? u.languages.split(",").map(s=>s.trim()) : []);
          // at least ONE language matches
          if (!f.lang.some(l => lArr.includes(l))) return false;
        }

        if (f.gender.length && !f.gender.includes(u.gender)) return false;

        const e = Number(u.experience || 0);
        if (f.expMin != null && e < f.expMin) return false;
        if (f.expMax != null && e > f.expMax) return false;

        return true;
      });
    }

    function renderChips(f){
      const chips = [];
      const add = (label, value, clearKey, clearVal) => {
        chips.push(`<span class="chip">\${label}: \${value} <button data-k="\${clearKey}" data-v="\${encodeURIComponent(clearVal || "")}">×</button></span>`);
      };

      if (f.q) add("Hledat", f.q, "q");
      f.loc.forEach(v => add("Lokalita", v, "loc", v));
      f.spec.forEach(v => add("Specializace", v, "spec", v));
      f.lang.forEach(v => add("Jazyk", v, "lang", v));
      f.gender.forEach(v => add("Pohlaví", v, "gender", v));
      if (f.expMin != null) add("Zkušenost ≥", f.expMin, "expMin");
      if (f.expMax != null) add("Zkušenost ≤", f.expMax, "expMax");

      chipsWrap.innerHTML = chips.join("") || "";
      chipsWrap.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const k = btn.dataset.k;
          const v = decodeURIComponent(btn.dataset.v || "");
          switch (k) {
            case "q": searchInput.value = ""; break;
            case "expMin": expMinInput.value = ""; break;
            case "expMax": expMaxInput.value = ""; break;
            default: {
              const selector = `input[name="\${k}"][value="\${CSS.escape(v)}"]`;
              const el = document.querySelector(selector);
              if (el) el.checked = false;
            }
          }
          doFilter();
        });
      });
    }

    function renderUsers(users) {
      userList.innerHTML = "";
      if (!users.length) {
        userList.innerHTML = "<p>Žádní uživatelé nebyli nalezeni.</p>";
        return;
      }

      users.forEach(([id, user]) => {
        const photoURL =
          (typeof user.profilePicture === "string" && user.profilePicture.startsWith("http"))
            ? user.profilePicture
            : clThumb(id);

        const name = user.name?.trim() || "Neznámý";
        const lastName = user.prijmeni?.trim() || "";

        const card = document.createElement("a");
        card.className = "card";
        card.href = `profile.html?id=\${id}`;
        card.innerHTML = `
          <img class="profile-pic"
               src="${photoURL}"
               alt="Profilový obrázek"
               onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=Profil';">
          <div class="card-info">
            <h3>${name} ${lastName}</h3>
            <p><strong>Zkušenosti:</strong> ${user.experience || "-"} let</p>
            <p><strong>Specializace:</strong> ${
              Array.isArray(user.specializations)
                ? user.specializations.join(", ")
                : (user.specializations || "-")
            }</p>
            <p><strong>Lokalita:</strong> ${user.location || "-"}</p>
          </div>
        `;
        userList.appendChild(card);
      });
    }

    const doFilter = (() => {
      let t;
      return function trigger(){
        clearTimeout(t);
        t = setTimeout(() => {
          const f = getFiltersFromUI();
          renderChips(f);
          renderUsers(applyFilters(allUsers, f));
        }, 150);
      };
    })();

    btnApply.addEventListener("click", () => {
      doFilter();
      filtersPanel.classList.remove("open");
    });

    btnClear.addEventListener("click", () => {
      searchInput.value = "";
      expMinInput.value = "";
      expMaxInput.value = "";
      document.querySelectorAll('#filtersPanel input[type="checkbox"]').forEach(cb => cb.checked = false);
      doFilter();
    });

    searchInput.addEventListener("input", doFilter);

    // react to any checkbox/number changes
    filtersPanel.addEventListener("change", (e) => {
      if (e.target.matches('input[type="checkbox"], input[type="number"]')) doFilter();
    });

    /* ========= Load trainers ========= */
    onValue(ref(db, "users/"), (snapshot) => {
      loader.style.display = "none";
      const data = snapshot.val() || {};
      allUsers = Object.entries(data).filter(([_, user]) => user.email);
      facets = buildFacets(allUsers);
      populateFilters();
      doFilter();
    });
  </script>
</body>
</html>
